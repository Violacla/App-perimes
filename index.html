<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Gestion Perimé - Pharmacie du Libron</title>
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
<script src="https://apis.google.com/js/api.js"></script>
<style>
  .autocomplete-list {
  position: absolute;
  background-color: white;
 /* background-color: #fffefc;*/
  border: 1px solid #ccc;
  border-radius: 4px;
  list-style: none;
  margin: 0;
  padding: 0;
  max-height: 150px;
  overflow-y: auto;
  width: 250px;
  z-index: 999;
}

.autocomplete-list li {
  padding: 8px 10px;
  cursor: pointer;
  color: black;
}

.autocomplete-list li:hover,
.autocomplete-list li.active {
 background-color: #86bf8e;
/*background-color: #f294a6;*/
  color: white;
}

  :root {
    --bleu-glacial: #bcd7ed;
   /*--bleu-glacial: #f294a6;*/
  }

  body {
    margin: 0;
    font-family: Arial, sans-serif;
    /*background: #f9f9f9;*/
    background: #fffefc;
  }

  /* Bandeau bleu glacial */
  header {
    background-color: var(--bleu-glacial);
    color: #163f5b;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  }

  #header-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  #header-left > h1 {
    margin: 0;
    font-size: 1.3em;
  }

  button {
    cursor: pointer;
    border: none;
    background: transparent;
    font-size: 1em;
    color: black;
    padding: 6px 10px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: rgba(255 255 255 / 0.3);
  }

  /* Icons with emoji for simplicity */
  .icon {
    font-size: 1.2em;
    margin-right: 6px;
  }

  /* Header right buttons */
  #header-right {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  /* Operator form */
  #operator-form input {
  padding: 8px;
  border: 1px solid #16416d;
  border-radius: 8px;
  font-size: 1em;
  width: 180px; /* Adaptez la largeur si besoin */
}

  /* Layout */
  main {
    display: flex;
    margin: 20px;
  }

  /* Form to add entries on right */
 #entry-form {
  width: 320px;
  background: #ebf2ec;
  padding: 15px 20px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  margin-left: 20px;
  margin-top: 20px; /* Aligne avec les filtres */
}

  #entry-form h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: normal;
  }
  #entry-form input {
    background-color: #e1f4e4;
    width: 100%;
    margin: 6px 0;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  #entry-form button {
    width: 100%;
    /*background-color: var(--bleu-glacial);*/
    background-color: #bfdbc4;
    color: black;
    font-weight: bold;
    margin-top: 10px;
  }
  #entry-form button:hover {
    background-color: #86bf8e;
  }

  /* Table styles */
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    border-radius: 6px;
    overflow: hidden;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px 10px;
    text-align: center;
  }

  /* Alternate row background with 15% opacity bleu glacial */
  tbody tr:nth-child(odd) {
   /* background-color: rgba(188, 215, 237, 0.15);*/
    background-color: #ede2e6
  }

  /* Selected row highlight 50% opacity */
  tbody tr.selected {
    /*background-color: rgba(188, 215, 237, 0.5) !important;*/
    background-color: #f2b4bb!important;
  }

  /* Editable cells */
  tbody td {
    cursor: text;
  }

  /* Filter section */
  #filters {
    margin: 20px;
    display: flex;
    gap: 15px;
    align-items: flex-end;
  }
  #filters label {
    font-weight: bold;
     color: #86bf8e;
  }
  #filters input, #filters button {
    padding: 5px 8px;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #filters button {
    /*background-color: var(--bleu-glacial);*/
    background-color: #bfdbc4;
    color: black;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  #filters button:hover {
    background-color: #86bf8e;
    color: white;
  }

  /* Status text */
  #status {
    margin: 10px 20px;
    font-weight: bold;
    color: #0a2f51;
  }

 /* Styles pour la popup de notification */
  #notification-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    width: 1300px;
    max-height: 92vh;
    overflow-y: auto;
    z-index: 9999;
    display: none;
    flex-direction: column;
  }
  #notification-popup header {
    display: flex;
    justify-content: space-between;
    align-items: right;
    padding: 10px 20px;
    background-color: var(--bleu-glacial);
    color: #163f5b;
    border-radius: 10px 10px 0 0;
  }
  #notif-tabs {
    display: flex;
    gap: 10px;
    margin-left: auto;
  }
  .header-buttons {
    display: flex;
    gap: 10px;
  }
  .tab-button {
    background-color: transparent;
    color: #163f5b; /* Texte en noir par défaut */
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s, color 0.3s;
    text-align: right;
    border-radius: 5px 5px 0 0;
  }
  .tab-button:hover,
  .tab-button.active {
    background-color: #85b9dd; /* Fond bleu foncé au survol et pour l'onglet actif */
    color: white; /* Texte blanc au survol et pour l'onglet actif */
  }
  .tab-content {
    display: none;
    padding: 15px;
    overflow-y: auto;
    max-height: calc(92vh - 80px);
    color: black;
  }
  .tab-content h3 {
    text-align: left;
    color: black;
  }
  .tab-content.active {
    display: block;
  }
  .ligne-vendue td {
  text-decoration: line-through;
  background-color: #d8c0ca !important; /* ou une autre couleur que tu préfères */
  color: #efe8eb; /* facultatif : texte un peu plus gris */
}
  /* Styles pour l'impression */
  @media print {
    body > :not(#notification-popup) {
      display: none;
    }
    #notification-popup {
      position: static !important;
      transform: none !important;
      top: auto !important;
      left: auto !important;
      width: 100% !important;
      height: auto !important;
      max-height: none !important;
      overflow: visible !important;
      margin: 0 !important;
      padding: 0 !important;
      border-radius: 0 !important;
      display: block !important;
    }
    #notification-popup .tab-content:not(.active) {
      display: none !important;
    }
    #notification-popup #notif-tabs,
    #notification-popup .header-buttons {
      display: none !important;
    }
    html, body {
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    #notification-popup .tab-content,
    #notification-popup .content {
      max-height: none !important;
      overflow: visible !important;
    }
  }
  #date-error {
  display: none;
  background-color: white;
  color: #87c08f;
  padding: 10px;
  margin: 10px 0;
  border: 3px solid #87c08f;
  border-radius: 10px;
  font-weight: bold;
  text-align: center;
  font-size: 2.5em;
  max-width: 90%;
  margin: 0 auto 10px auto;
}
#update-overlay {
  position: fixed;
  top: 60px; /* Pour laisser le bandeau visible */
  left: 0;
  width: 100%;
  height: calc(100% - 60px);
  background-color: rgba(188, 215, 237, 0.9); /* bleu glacial transparent */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9998;
}

#update-popup {
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.25);
  max-width: 600px;
  text-align: center;
  font-size: 1.1em;
}

#update-popup h2 {
  margin-top: 0;
  color: #87c08f;
}

#update-popup ul {
  list-style: none;
  padding-left: 0;
  text-align: left;
  margin-bottom: 20px;
}

#update-popup ul li::before {
  content: "🔹 ";
}

#update-logo {
  display: block;
  margin: 20px auto 0 auto;
  width: 70px;
  height: auto;
}
  
#btn-login {
  background-color: #0a2f51;       /* 🔵 Bleu foncé */
  color: #bcd7ed;                  /* 💙 Bleu glacial (ton style principal) */
  font-weight: bold;
  padding: 12px 24px;
  font-size: 1.2em;
  border: none;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  cursor: pointer;
  transition: background-color 0.3s, transform 0.2s;
}

#btn-login:hover {
  background-color: #083049;      /* un peu plus foncé au hover */
  transform: translateY(-2px);
}
#filters {
  background-color: #ebf2ec; /* Couleur de fond verte */
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: flex-end;
  margin-bottom: 20px;
}

#filters label {
  font-weight: bold;
  color: #0a2f51; /* Couleur du texte des labels */
  display: block;
}

#filters input, #filters select {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1em;
}

#filters button {
  background-color: #bfdbc4;
  color: black;
  font-weight: bold;
  padding: 10px 15px;
  border-radius: 5px;
}

#filters button:hover {
  background-color: #5d9e63;
}
  /* Style du texte à l'intérieur des champs de saisie */
#filters input::placeholder {
  color: #87c08f; /* Vert pastel */
  opacity: 1; /* S'assure que la couleur est bien visible */
}
  #btn-confirm-operator {
  background-color: #16416d; /* Un bleu foncé */
  color: white;
  font-weight: bold;
  padding: 8px 12px;
  border-radius: 8px; /* Pour des angles arrondis */
  border: none;
  transition: background-color 0.3s ease;
}

#btn-confirm-operator:hover {
  background-color: #1a4d78; /* Un bleu plus foncé au survol */
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script></head>
<header>
<div id="header-left">
<a href="/index.html" style="
      display:inline-block;
      width:40px;
      height:40px;
      border-radius:50%;
      overflow:hidden;
      border:0px solid #0a2f51;
    " title="Accueil">
<!--<img alt="Logo" src="https://i.imgur.com/FmevFyY.png" style="width:100%; height:100%; object-fit:cover;"/> -->
<img alt="Logo" src="https://i.imgur.com/AExTPc7.png" style="width:100%; height:100%; object-fit:cover;"/>
</a>
<h1>Gestion Périmé - Pharmacie du Libron</h1>
<!-- Groupe opérateur -->
<div id="operator-form" style="margin-left:10px;">
<input id="operator" placeholder="Nom de l'opérateur" type="text"/>
<button id="btn-confirm-operator">Valider</button>
</div>
<!-- Bouton connexion -->
</div>
<div id="header-right">
<button id="btn-notif" style="position: relative; display: inline-flex; align-items: center; gap: 5px;" title="Notifications">
  <span style="position: relative; display: inline-block; width: 18px; height: 18px;">
    <img alt="Logo" src="https://i.imgur.com/em9h9Wk.png" style="width: 100%; height: 100%; object-fit: cover; vertical-align: middle;" />
    <span id="notif-badge" style="display: none; position: absolute; top: 0px; right: 0px; width: 20px; height: 20px; z-index: 2;">
      <img src="https://i.imgur.com/EIvT5ot.png" style="width: 100%; height: 100%; object-fit: cover;" />
    </span>
  </span>
  Suivi Périmés
</button>

<button onclick="location.href='historique.html'" title="Historique">
<img alt="Historique" src="https://i.imgur.com/BasLkpT.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
Historique
</button>
  <button onclick="location.href='promotion.html'" title="Promo %">
% Promo
</button>
  </button>
  <button id="btn-open-my-pdf" title="Ouvrir mon PDF personnalisé">
  <img src=https://i.imgur.com/kGXfRUa.png" style="width:18px; height:18px; vertical-align:middle;"/>
</button>
<button id="btn-logout" style="display:none;" title="Déconnexion">
<!-- <img alt="Déconnexion" src="https://i.imgur.com/Ku9oMjb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/> -->
<img alt="Déconnexion" src="https://i.imgur.com/OPA1EuF.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
Déconnexion
</button>
</div>

</header>
<main>
<div style="flex-grow:1;">
<div id="filters">
    <div class="filter-group">
        <label for="filter-zone">Zone:</label>
        <input id="filter-zone" type="text" />
    </div>
    <div class="filter-group">
        <label for="filter-month">Date:</label>
       <input id="filter-month" placeholder="MMYYYY ou YYYY" style="width: 140px;" type="text" />
    </div>
    <div class="filter-group">
        <label for="filter-name-code">Nom ou Code:</label>
        <input id="filter-name-code" type="text" />
    </div>
    <button onclick="filterTable()">Filtrer</button>
    <button onclick="clearFilter()">Réinitialiser</button>
    <button id="btn-print-table" title="EXPORTER EN PDF">
        <img src="https://i.imgur.com/WbH9qyS.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;" />
    </button>
    <ul class="autocomplete-list" id="filter-zone-suggestions" style="display: none;"></ul>
</div>
<div style="max-height: 400px; overflow-y: auto; border-radius: 6px; margin-top: 10px;"><table aria-label="Données des produits périmés" id="data-table" tabindex="0">
<thead>
<tr>
<!-- Ne PAS afficher colonne opérateur -->
<th>Date</th>
<th>Produit</th>
<th>Code</th>
<th>Qté</th>
<th>Zone</th>
<th>Vendues</th>
<th>Promo</th>
<th>Suppr</th>
</tr>
</thead>
<tbody></tbody>
</table></div>
<pre id="status"></pre>
</div>
<form id="entry-form" onsubmit="return false;" style="display: none;">
<h3>Ajouter un produit</h3>
<input id="date" placeholder="MM/YYYY" type="text"/>
  <div id="date-error">DATE<br>INVALIDE</div>
<input id="product" placeholder="Nom Boîte" type="text"/>
<input id="code" maxlength="6" minlength="6" pattern="\d{6}" placeholder="Code (6 chiffres)" required="" type="text"/>
<input id="qty" min="0" placeholder="Nb Boîtes" type="number"/>
<input autocomplete="off" id="zone" placeholder="Zone" type="text"/>
<ul class="autocomplete-list" id="zone-suggestions" style="display: none;"></ul>
<button id="btn-add" type="button">Ajouter la ligne</button>
</form>
</main>
<body>
  <div id="update-overlay">
  <div id="update-popup">
    <h2>Mise à jour - 14/08/2025</h2>
    <ul>
      <li>Nouvelles fonctionnalités : </li>
      <li>1. Le bouton "Suivi Périmés" remplace "Notification" avec 3 onglets : <br>
      - " Trimestre " => Affiche les produits qui périmeront dans les 3 prochains mois.<br>
      - " 2ème Mois " => Affiche le mois "central" du trimestre (ex : Octobre si nous sommes en Août) <br>
      - " À retirer " => Affiche les produits périmés le mois précédent, à retirer des rayons. </li>
      <li>2.Nouveau filtre : Cherchez un produit par nom ou code. </li>
      <li>3. Cette fenêtre d'information ne s'affichera qu'au démarrage et disparaîtra automatiquement une fois que vous serez connecté. </li>
      <li>4. Un icone "?" a été ajouté à côté de "% promo". Il vous donne accès à une page Google Drive pour un échange direct et propose une description détaillée des fonctionnalités de l'application. </li>
      <li>N'hésitez pas à nous faire part de vos suggestions et remarques.<br>
    <em>Violaine</em> </li>
    </ul>
    <img src="https://i.imgur.com/yqzUg16.png" alt="Logo Mises à jour" id="update-logo">
  </div>
</div>

<div aria-labelledby="notif-title" aria-modal="true" id="notification-popup" role="dialog" style="display: none;">
    <header style="display: flex; align-items: center; gap: 20px;">
  <div style="display: flex; align-items: center; gap: 20px;">
    <span id="notif-title"> Produits périmés</span>
    <div id="notif-tabs" style="margin: 0;"> <!-- ← on le déplace ici -->
      <button class="tab-button active" onclick="showTab('trimestre')">Trimestre</button>
      <button class="tab-button" onclick="showTab('2nd-month')">2ème mois</button>
      <button class="tab-button" onclick="showTab('current-month')">À retirer</button>
    </div>
  </div>
  <div class="header-buttons" style="margin-left: auto;">
    <button id="print-notif" title="Imprimer">
      <img src="https://i.imgur.com/qY1buNb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
    </button>
    <button id="close-notif" title="Fermer">
      <img src="https://i.imgur.com/7NKMuZy.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
    </button>
  </div>
</header>
    <div class="content">
        <div id="trimestre" class="tab-content active"></div>
        <div id="2nd-month" class="tab-content"></div>
        <div id="current-month" class="tab-content"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const badge = document.getElementById('notif-badge');
  const btnNotif = document.getElementById('btn-notif');
  const now = new Date();
  const monthKey = `${now.getFullYear()}-${now.getMonth()+1}`;
  if (now.getDate() >= 15 && localStorage.getItem('notifSeen') !== monthKey) {
    badge.style.display = 'inline-block';
  }
  btnNotif.addEventListener('click', () => {
    badge.style.display = 'none';
    localStorage.setItem('notifSeen', monthKey);
  });

  const operatorInput = document.getElementById('operator');
  const btnOperator = document.getElementById('btn-confirm-operator');
  if (operatorInput && btnOperator) {
    operatorInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btnOperator.click();
      }
    });
  }
});
</script>
<script>
  document.getElementById("btn-print-table").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;

    const zoneFilter = document.getElementById("filter-zone").value;
    const monthFilter = document.getElementById("filter-month").value;

    doc.setFontSize(14);
    doc.text("Résultats filtrés - Produits périmés", 10, y);
    y += 10;
    doc.setFontSize(10);
    doc.text(`Zone : ${zoneFilter || "Toutes"}`, 10, y);
    y += 6;
    doc.text(`Mois : ${monthFilter || "Tous"}`, 10, y);
    y += 10;

    const rows = document.querySelectorAll("#data-table tbody tr");
    rows.forEach((row) => {
      if (row.style.display === "none") return;

      const cells = Array.from(row.children).slice(0, 6).map(td => td.textContent.trim());
      doc.text(cells.join(" | "), 10, y);
      y += 6;
      if (y > 280) {
        doc.addPage();
        y = 10;
      }
    });

    doc.save("resultats_perimes.pdf");
  });
</script>
<script>
  const filterInput = document.getElementById('filter-zone');
  const suggestionList = document.getElementById('filter-zone-suggestions');

  filterInput.addEventListener('input', function () {
    const val = this.value.toLowerCase();
    suggestionList.innerHTML = '';
    if (val.length < 1) {
      suggestionList.style.display = 'none';
      return;
    }

    const matches = zones.filter(z => z.toLowerCase().includes(val));
    if (matches.length === 0) {
      suggestionList.style.display = 'none';
      return;
    }

    matches.forEach((zone) => {
      const li = document.createElement('li');
      li.textContent = zone;
      li.addEventListener('click', () => {
        filterInput.value = zone;
        suggestionList.innerHTML = '';
        suggestionList.style.display = 'none';
      });
      suggestionList.appendChild(li);
    });

    const rect = filterInput.getBoundingClientRect();
    suggestionList.style.top = rect.bottom + window.scrollY + 'px';
    suggestionList.style.left = rect.left + window.scrollX + 'px';
    suggestionList.style.width = filterInput.offsetWidth + 'px';
    suggestionList.style.display = 'block';
  });

  document.addEventListener('click', function (e) {
    if (!filterInput.contains(e.target) && !suggestionList.contains(e.target)) {
      suggestionList.style.display = 'none';
    }
  });
</script>
<script>
  async function deleteRow(rowIndex) {
    try {
      await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          requests: [{
            deleteDimension: {
              range: {
                sheetId: 0,
                dimension: "ROWS",
                startIndex: rowIndex - 1,
                endIndex: rowIndex
              }
            }
          }]
        }
      });
      setStatus("Ligne supprimée avec succès.");
      loadSheet();
    } catch (e) {
      setStatus("Erreur suppression : " + e.message);
    }
  }
</script>
<script>
  const filterMonthInput = document.getElementById('filter-month');
  filterMonthInput.addEventListener('input', function(e) {
  // On laisse l'utilisateur taper librement MMYYYY ou YYYY sans forcer le /
  e.target.value = e.target.value.replace(/[^\d\/]/g, ''); // empêche lettres
});

</script>
<script>
function filterTable() {
const zoneFilter = document.getElementById("filter-zone").value.trim().toLowerCase();
const monthFilter = document.getElementById("filter-month").value.trim();
// NOUVEAU : Récupérer la valeur du nouveau champ de recherche
const nameCodeFilter = document.getElementById("filter-name-code").value.trim().toLowerCase(); 
const rows = document.querySelectorAll("#data-table tbody tr");

rows.forEach((row) => {
const dateCell = row.cells[0].textContent.trim(); 
const productCell = row.cells[1].textContent.trim().toLowerCase(); // NOUVEAU : Récupérer le nom du produit
const codeCell = row.cells[2].textContent.trim().toLowerCase(); // NOUVEAU : Récupérer le code
const zoneCell = row.cells[4].textContent.trim().toLowerCase();
let show = true;

// Filtre zone
if (zoneFilter && !zoneCell.includes(zoneFilter)) {
show = false;
}

// NOUVEAU : Filtre par nom ou code
// Affiche la ligne si le filtre est vide OU si la ligne contient le texte recherché
if (nameCodeFilter && !productCell.includes(nameCodeFilter) && !codeCell.includes(nameCodeFilter)) {
show = false;
}

// Filtre mois MM/YYYY
if (monthFilter) {
let rowYear = '';
let rowMonth = '';

if (dateCell.includes('-')) {
const [yyyy, mm] = dateCell.split('-');
rowYear = yyyy;
rowMonth = mm;
}

let mFilter = null;
let yFilter = null;

if (/^\d{2}\/\d{4}$/.test(monthFilter)) {
[mFilter, yFilter] = monthFilter.split('/');
} else if (/^\d{6}$/.test(monthFilter)) {
mFilter = monthFilter.slice(0, 2);
yFilter = monthFilter.slice(2);
} else if (/^\d{4}$/.test(monthFilter)) {
yFilter = monthFilter;
}

if (yFilter && rowYear !== yFilter) show = false;
if (mFilter && rowMonth !== mFilter) show = false;
}

row.style.display = show ? "" : "none";
});
}
function clearFilter() {
document.getElementById('filter-zone').value = '';
document.getElementById('filter-month').value = '';
// NOUVEAU : Vider le nouveau champ de recherche
document.getElementById('filter-name-code').value = ''; 
filterTable();
}
</script></body>
<!-- Notification Popup -->
<script>
 // Constantes d'API Google Sheets
  const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
  const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
  const RANGE = 'Feuille1'; // Plage par défaut pour les données principales
  const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

  let tokenClient, gapiInited = false, gisInited = false, accessToken = null, operatorName = null;
  let pendingOperatorName = null; // Variable pour stocker le nom de l'opérateur temporairement

  // Initialisation de l'API Google Sheets
  function gapiLoaded() { gapi.load('client', initializeGapiClient); }
  async function initializeGapiClient() {
    await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
    gapiInited = true;
    maybeEnableButtons();
  }

  // Initialisation du client d'authentification Google Identity Services (GIS)
  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        // Cette fonction est appelée APRÈS que l'utilisateur se soit connecté via Google
        accessToken = tokenResponse.access_token;
        if (pendingOperatorName) { // Si un nom d'opérateur a été saisi avant la connexion Google
            operatorName = pendingOperatorName; // On l'assigne comme opérateur final
            
            document.getElementById('operator-form').style.display = 'none'; // Cache le formulaire opérateur
            document.getElementById('btn-logout').style.display = 'inline-block'; // Affiche le bouton déconnexion
            document.getElementById('entry-form').style.display = 'block'; // Affiche le formulaire d'ajout
            loadSheet(); // Charge les données principales
            setStatus(`Connecté en tant que ${operatorName}.`);
            
            // Masquer l'overlay de mise à jour après connexion
            const overlay = document.getElementById('update-overlay');
            if (overlay) overlay.style.display = 'none';
        } else {
            // Cas d'erreur si pendingOperatorName n'est pas défini (ne devrait pas arriver avec le nouveau flux)
            setStatus('Erreur : Nom d\'opérateur non trouvé après connexion Google.');
            console.error('Pending operator name was null after successful Google login.');
        }
        pendingOperatorName = null; // Réinitialise la variable temporaire
      },
    });
    gisInited = true;
    maybeEnableButtons(); // S'assure que tout est chargé et gère le focus initial
  }

  // Active les fonctionnalités quand les APIs sont chargées
  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('operator').focus(); // Met le focus sur le champ opérateur
      setStatus('Veuillez entrer votre nom d\'opérateur pour vous connecter.');
    }
  }

  // Affiche un message de statut en bas de page
  function setStatus(msg) {
    document.getElementById('status').textContent = msg;
  }

  // --- Nouvelle fonction pour initier la connexion (opérateur + Google) ---
  async function initiateGoogleAndOperatorLogin() {
    const op = document.getElementById('operator').value.trim();
    if (!op) {
        alert("Veuillez entrer un nom d'opérateur.");
        return;
    }
    pendingOperatorName = op; // Stocke le nom de l'opérateur temporairement

    try {
        // Déclenche la requête de jeton Google, ce qui ouvrira la popup de connexion Google si nécessaire
        await tokenClient.requestAccessToken();
        setStatus('Connexion Google en cours...'); // Message affiché pendant la connexion Google
    } catch (error) {
        console.error("Erreur lors de la requête du token Google:", error);
        setStatus("Erreur de connexion Google. Veuillez réessayer.");
        pendingOperatorName = null; // Nettoie le nom temporaire en cas d'erreur
    }
  }

  // Gestion des clics sur les boutons de connexion/déconnexion et confirmation opérateur
  // Le bouton 'btn-login' a été supprimé
  document.getElementById('btn-logout').onclick = () => {
    accessToken = null;
    operatorName = null;
    pendingOperatorName = null; // Réinitialise également la variable temporaire
    
    document.getElementById('operator-form').style.display = 'inline-flex'; // Réaffiche le formulaire opérateur
    document.getElementById('operator').value = ''; // Efface le nom de l'opérateur
    document.getElementById('btn-logout').style.display = 'none'; // Cache le bouton déconnexion
    document.getElementById('entry-form').style.display = 'none'; // Cache le formulaire d'ajout
    clearTable(); // Vide le tableau principal
    setStatus('Déconnecté.');
    document.getElementById('operator').focus(); // Remet le focus sur le champ opérateur
  };

  // Lie le bouton "Valider" à la nouvelle fonction de connexion
  document.getElementById('btn-confirm-operator').onclick = initiateGoogleAndOperatorLogin;

  // Gère la touche "Entrée" dans le champ opérateur pour déclencher la connexion
  const operatorInput = document.getElementById('operator');
  if (operatorInput) {
    operatorInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        initiateGoogleAndOperatorLogin();
      }
    });
  }

  document.getElementById('btn-add').onclick = async () => {
    if(!operatorName) {
      alert("Veuillez vous connecter et choisir un opérateur");
      return;
    }

    let rawDate = document.getElementById('date').value;
    let dateVal = "";
    if (rawDate) {
      const [month, year] = rawDate.split('/');
      if (month && year) {
        const paddedMonth = month.padStart(2, '0');
        const lastDay = new Date(year, parseInt(paddedMonth), 0).getDate();
        dateVal = `${year}-${paddedMonth}-${lastDay}`;
      }
    }
    if (!dateVal) {
      const today = new Date();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const y = today.getFullYear();
      const d = new Date(y, today.getMonth() + 1, 0).getDate();
      dateVal = `${y}-${m}-${d}`;
    }

    const productVal = document.getElementById('product').value.trim();
    const qtyVal = parseInt(document.getElementById('qty').value);
    const zoneVal = document.getElementById('zone').value.trim();

    if (!zones.includes(zoneVal)) {
  alert("Veuillez choisir une zone existante dans la liste.");
  return;
}
const codeVal = document.getElementById('code').value.trim();
if (!/^\d{6}$/.test(codeVal)) {
  alert("Le code doit contenir exactement 6 chiffres.");
  return;
}

    const soldVal = 0;
    const promoVal = 0;


    if (!productVal || isNaN(qtyVal) || !zoneVal || isNaN(soldVal) || isNaN(promoVal)) {
      alert("Veuillez remplir tous les champs correctement.");
      return;
    }
const now = new Date();
const ajoutVal = now.toLocaleString('fr-FR'); // Exemple : 12/06/2025, 09:44:31

const values = [[
  operatorName,     // invisible
  dateVal,          // ✅ Date
  productVal,       // ✅ Nom
  codeVal,          // ✅ Code
  qtyVal,           // ✅ Qté
  zoneVal,          // ✅ Zone
  soldVal,          // ✅ Vendues
  promoVal,          // ✅ Promo
  ajoutVal // ✅ Date d'ajout (dans le Google Sheet uniquement)
]];


    try {
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: 'USER_ENTERED',
        resource: { values }
      });


      loadSheet();
      setStatus('Ligne ajoutée avec succès !');
      // Réinitialise tous les champs AVANT le rechargement
document.getElementById('date').value = '';
document.getElementById('product').value = '';
document.getElementById('code').value = '';
document.getElementById('qty').value = '';
document.getElementById('zone').value = '';
document.getElementById('sold').value = '';
document.getElementById('promo').value = '';

// Traitement spécial pour le champ date
const dateInput = document.getElementById('date');
dateInput.value = '';
dateInput.dataset.raw = '';
dateInput.blur(); // enlève le focus

// Sécurité : s'il se remplit tout seul, on le vide à nouveau après 100ms
setTimeout(() => {
  dateInput.value = '';
  dateInput.removeAttribute('value'); // ⬅️ Ajout important ici
  dateInput.dataset.raw = '';
}, 200);
      // Clear form inputs
//document.getElementById('product').value = '';
//document.getElementById('code').value = '';
//document.getElementById('qty').value = '';
//document.getElementById('zone').value = '';
//document.getElementById('sold').value = '';
//document.getElementById('promo').value = '';

// Forcer l'effacement du champ date (même si un autre script le remplit après)
//const dateInput = document.getElementById('date');
//dateInput.value = '';
//dateInput.dataset.raw = ''; // utile si un masque est utilisé

//setTimeout(() => {
// dateInput.value = '';
//}, 50);

dateInput.focus();


    } catch (e) {
      setStatus('Erreur : ' + e.message);
    }
  };

  // Load sheet data, exclude operator from table display
  async function loadSheet() {
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: RANGE });
      const rows = res.result.values || [];
      renderTable(rows);
    } catch (e) {
      setStatus("Erreur de chargement : " + e.message);
    }
  }

  function clearTable() {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
  }

  // Render table without opérateur column (index 0)
  function renderTable(rows) {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
    //rows.slice(1).forEach((row, i) => {
    rows.slice(1).reverse().forEach((row, i) => {
      const tr = document.createElement('tr');
      const qte = parseInt(row[4] || '0');
const vendu = parseInt(row[6] || '0');
if (!isNaN(qte) && !isNaN(vendu) && qte === vendu) {
  tr.classList.add('ligne-vendue');
}

      // Columns: opérateur (0), produit (1), date(2), qty(3), zone(4), vendues(5), promo(6)
      // We skip opérateur (col 0)
      const cols = [1, 2, 3, 4, 5, 6];
      cols.forEach(colIndex => {
        const td = document.createElement('td');
        td.textContent = row[colIndex] || '';
        td.contentEditable = true;
       // td.dataset.row = i + 2; // Google Sheets rows start at 1 + header row
        const actualSheetRow = rows.length - i;
td.dataset.row = actualSheetRow;
        td.dataset.col = colIndex + 1; // Google Sheets columns start at 1
        td.addEventListener('blur', onCellEdit);
        tr.appendChild(td);
      });
      tr.addEventListener('click', () => {
        // Unselect all
        document.querySelectorAll('#data-table tbody tr').forEach(r => r.classList.remove('selected'));
        tr.classList.add('selected');
      });
      tbody.appendChild(tr);
    });
  }

  // Update cell in Google Sheets on edit
  async function onCellEdit(e) {
    if(!operatorName) return;
    const td = e.target;
    const newValue = td.textContent.trim();
    const row = td.dataset.row;
    const col = td.dataset.col;

    try {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `Feuille1!${columnToLetter(col)}${row}`,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [[newValue]] }
      });
      setStatus(`Cellule mise à jour (ligne ${row}, colonne ${col})`);
    } catch (err) {
      setStatus('Erreur mise à jour : ' + err.message);
    }
  }

  // Convert number to letter for column (1->A, 2->B ...)
  function columnToLetter(column) {
    let temp, letter = '';
    while(column > 0) {
      temp = (column - 1) % 26;
      letter = String.fromCharCode(temp + 65) + letter;
      column = (column - temp - 1) / 26;
    }
    return letter;
  }


  // Notification popup logic
  const notifPopup = document.getElementById('notification-popup');
  const notifContent = notifPopup.querySelector('.content');
  document.getElementById('btn-notif').onclick = () => {
    if(!operatorName) {
      alert("Connectez-vous et choisissez un opérateur pour voir les notifications.");
      return;
    }
    loadNotifications();
    notifPopup.style.display = 'flex';
  };
  document.getElementById('close-notif').onclick = () => {
    notifPopup.style.display = 'none';
  };
  document.getElementById('print-notif').onclick = () => {
    window.print();
  };

// Format "YYYY-MM" en "Mois Année" (ex : "2025-05" -> "Mai 2025")
function formatMonthYear(ym) {
  const [y, m] = ym.split('-');
  const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                  'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
  return months[parseInt(m, 10) - 1] + ' ' + y;
}

  // Load GAPI & GIS on window load
  window.onload = () => {
    gapiLoaded();
    gisLoaded();
  };</script>
<script>
if (document.getElementById('btn-history')) {
  document.getElementById('btn-history').addEventListener('click', async () => {
}
    if (!operatorName) {
      alert("Connectez-vous et choisissez un opérateur pour accéder à l'historique.");
      return;
    }
    try {
      await transferToHistorique();
      window.location.href = '/historique.html';
    } catch (e) {
      alert("Erreur lors du transfert vers historique : " + e.message);
    }
  });

  async function transferToHistorique() {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'Feuille1'
    });
    const allRows = res.result.values || [];
    if (allRows.length <= 1) return;

    const now = new Date();
    const currentYM = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    const toMove = [];
    const remaining = [allRows[0]];

    allRows.slice(1).forEach(row => {
      const dateStr = row[1];
      if (!dateStr) return;
      const d = new Date(dateStr);
      if (isNaN(d)) return;
      const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      if (ym < currentYM) toMove.push(row);
      else remaining.push(row);
    });

    if (toMove.length > 0) {
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'historique',
        valueInputOption: 'USER_ENTERED',
        resource: { values: toMove }
      });
    }

    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: 'Feuille1',
      valueInputOption: 'USER_ENTERED',
      resource: { values: remaining }
    });
    setStatus(`Transféré ${toMove.length} lignes vers "historique".`);
  }
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fields = [
    'date',
    'product',
    'code',
    'qty',
    'zone',
    'sold',
    'promo'
  ];

  fields.forEach((id, index) => {
    const input = document.getElementById(id);
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const nextField = document.getElementById(fields[index + 1]);
        if (nextField) {
          nextField.focus();
        } else {
          // Si c'est le dernier champ → clique sur le bouton
          document.getElementById('btn-add').click();
        }
      }
    });
  });
});
</script>
<script>
  const dateInput = document.getElementById('date');
  if (dateInput) {
    dateInput.addEventListener('input', function(e) {
      let val = e.target.value.replace(/[^\d]/g, '');
      if (val.length > 2) {
        val = val.slice(0,2) + '/' + val.slice(2,6);
      }
      e.target.value = val;
    });
  }
</script>
<script>
const zones = [
  "aboca", "aderma", "arko", "aromat", "avene", "bain", "bande", "bébé",
  "bien etre", "bioderma", "bi-oil", "bonbon", "brumes et senteurs", "cerave",
  "circulation", "clearskin", "collagene", "coloration", "confort", "conseil",
  "cooper geo", "cosmeto", "dentaire", "deo", "dermato", "dexeryl", "dietetique",
  "douleurs", "durex", "enfants", "forme", "frigo", "homeo", "hydratis", "intime",
  "la roche posay","LRP", "la rosee", "levres et mains", "moustik",
  "noreva", "nutergia", "nuxe", "ongles", "oreille", "pieds et mains", "pileje",
  "poux", "ronflement", "cheveux", "corps", "STUP", "svr", "tisanes", "uriage",
  "nature", "vichy", "yeux", "1ersoins", "4patte"
];

const input = document.getElementById('zone');
const list = document.getElementById('zone-suggestions');

input.addEventListener('input', function () {
  const val = this.value.toLowerCase();
  list.innerHTML = '';
  if (val.length < 1) {
    list.style.display = 'none';
    return;
  }

  const matches = zones.filter(z => z.toLowerCase().includes(val));
  if (matches.length === 0) {
    list.style.display = 'none';
    return;
  }

  matches.forEach((zone, index) => {
    const li = document.createElement('li');
    li.textContent = zone;
    li.addEventListener('click', () => {
      input.value = zone;
      list.innerHTML = '';
      list.style.display = 'none';
    });
    list.appendChild(li);
  });

  const rect = input.getBoundingClientRect();
  list.style.top = rect.bottom + window.scrollY + 'px';
  list.style.left = rect.left + window.scrollX + 'px';
  list.style.width = input.offsetWidth + 'px';
  list.style.display = 'block';
});

document.addEventListener('click', function (e) {
  if (!input.contains(e.target) && !list.contains(e.target)) {
    list.style.display = 'none';
  }
});
  function renderTable(rows) {
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';

  //rows.slice(1).forEach((row, i) => {
    rows.slice(1).reverse().forEach((row, i) => {
    const tr = document.createElement('tr');
      const qte = parseInt(row[4] || '0');
const vendu = parseInt(row[6] || '0');
if (!isNaN(qte) && !isNaN(vendu) && qte === vendu) {
  tr.classList.add('ligne-vendue');
}
    const cols = [1, 2, 3, 4, 5, 6, 7];

    cols.forEach(colIndex => {
      const td = document.createElement('td');
     td.textContent = row[colIndex] || '';
      td.contentEditable = true;
      //td.dataset.row = i + 2;
      const actualSheetRow = rows.length - i;
td.dataset.row = actualSheetRow;
      td.dataset.col = colIndex + 1;
      td.addEventListener('blur', onCellEdit);
      tr.appendChild(td);
    });

    // ✅ Ajout de la colonne "✖️"
    const tdDelete = document.createElement('td');
    tdDelete.innerHTML = '<img src="https://i.imgur.com/oStNoqu.png" style="width:15%; height:5%; object-fit:cover;"/>';
    tdDelete.style.cursor = 'pointer';
    tdDelete.style.color = '#bbb';
    tdDelete.style.fontSize = '1.1em';
    tdDelete.title = 'Supprimer cette ligne';
    tdDelete.addEventListener('mouseenter', () => tdDelete.style.color = '#888');
    tdDelete.addEventListener('mouseleave', () => tdDelete.style.color = '#bbb');
 //   tdDelete.addEventListener('click', async () => {
 //     const confirmed = confirm("Supprimer cette ligne ?");
 //     if (confirmed) {
 //       await deleteRow(i + 2);
 //     }
 //   });
      const actualSheetRow = rows.length - i;

tdDelete.addEventListener('click', async () => {
  const confirmed = confirm("Supprimer cette ligne ?");
  if (confirmed) {
    await deleteRow(actualSheetRow);
  }
});
    tr.appendChild(tdDelete);

    tr.addEventListener('click', () => {
      document.querySelectorAll('#data-table tbody tr').forEach(r => r.classList.remove('selected'));
      tr.classList.add('selected');
    });

    tbody.appendChild(tr);
  });
}
</script>
<script>
  // Filtrer en appuyant sur Entrée dans les champs
  document.addEventListener('DOMContentLoaded', function () {
    const filterZone = document.getElementById('filter-zone');
    const filterMonth = document.getElementById('filter-month');

    [filterZone, filterMonth].forEach(input => {
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          filterTable(); // fonction que tu as déjà
        }
      });
    });
  });
</script>
<footer style="
  position: fixed;
  bottom: 0;
  width: 100%;
  text-align: center;
  font-size: 0.6em;
  color: #666;
  background: #bfdbc4;
  padding: 8px 0;
  box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
  z-index: 10;
">
  Développé par Violaine Claron - Mise à jour 08/08/2025
</footer>
<script>
 function exportFilteredTableAsPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;

  const zoneFilter = document.getElementById("filter-zone").value;
  const monthFilter = document.getElementById("filter-month").value;

  doc.setFontSize(14);
  doc.text("Résultats filtrés - Produits périmés", 10, y);
  y += 10;
  doc.setFontSize(10);
  doc.text(`Zone : ${zoneFilter || "Toutes"}`, 10, y);
  y += 6;
  doc.text(`Mois : ${monthFilter || "Tous"}`, 10, y);
  y += 10;

  const rows = document.querySelectorAll("#data-table tbody tr");
  rows.forEach((row) => {
    if (row.style.display === "none") return;
    const cells = Array.from(row.children).slice(0, 6).map(td => td.textContent.trim());
    doc.text(cells.join(" | "), 10, y);
    y += 6;
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
  });

  doc.save("resultats_perimes.pdf");
}



</script>
<script>
  const suggestionList = document.getElementById('filter-zone-suggestions');

  filterInput.addEventListener('input', function () {
    const val = this.value.toLowerCase();
    suggestionList.innerHTML = '';
    if (val.length < 2) {
      suggestionList.style.display = 'none';
      return;
    }

    const matches = zones.filter(z => z.toLowerCase().includes(val));
    if (matches.length === 0) {
      suggestionList.style.display = 'none';
      return;
    }

    matches.forEach((zone) => {
      const li = document.createElement('li');
      li.textContent = zone;
      li.addEventListener('click', () => {
        filterInput.value = zone;
        suggestionList.innerHTML = '';
        suggestionList.style.display = 'none';
      });
      suggestionList.appendChild(li);
    });

    const rect = filterInput.getBoundingClientRect();
    suggestionList.style.top = rect.bottom + window.scrollY + 'px';
    suggestionList.style.left = rect.left + window.scrollX + 'px';
    suggestionList.style.width = filterInput.offsetWidth + 'px';
    suggestionList.style.display = 'block';
  });

  document.addEventListener('click', function (e) {
    if (!filterInput.contains(e.target) && !suggestionList.contains(e.target)) {
      suggestionList.style.display = 'none';
    }
  });
</script>
<script>
  async function deleteRow(rowIndex) {
    try {
      await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          requests: [{
            deleteDimension: {
              range: {
                sheetId: 0,
                dimension: "ROWS",
                startIndex: rowIndex - 1,
                endIndex: rowIndex
              }
            }
          }]
        }
      });
      setStatus("Ligne supprimée avec succès.");
      loadSheet();
    } catch (e) {
      setStatus("Erreur suppression : " + e.message);
    }
  }
</script>
<script>
 /* if (filterMonthInput) {
    filterMonthInput.addEventListener('input', function(e) {
      let val = e.target.value.replace(/[^\d]/g, '');
      if (val.length > 2) {
        val = val.slice(0,2) + '/' + val.slice(2,6);
      }
      e.target.value = val;
    });
  }*/

let currentFocus = -1;

input.addEventListener('keydown', function (e) {
  const items = list.querySelectorAll("li");
  if (!items.length) return;

  if (e.key === "ArrowDown") {
    currentFocus++;
    if (currentFocus >= items.length) currentFocus = 0;
    updateActive(items);
  } else if (e.key === "ArrowUp") {
    currentFocus--;
    if (currentFocus < 0) currentFocus = items.length - 1;
    updateActive(items);
  } else if (e.key === "Enter") {
    e.preventDefault();
    if (currentFocus > -1) {
      items[currentFocus].click();
    }
  }
});

function updateActive(items) {
  items.forEach(i => i.classList.remove("active"));
  if (items[currentFocus]) {
    items[currentFocus].classList.add("active");
    items[currentFocus].scrollIntoView({ block: "nearest" });
  }
}

</script>
<script>
document.getElementById("btn-open-my-pdf").addEventListener("click", () => {
  window.open("https://docs.google.com/document/d/1zzPXerqNLJfAJFOshI8lk1hOAcXGBd0o/edit?usp=sharing&ouid=101646951122744714292&rtpof=true&sd=true", "_blank");
});
</script>
  <script>
 const dateInputField = document.getElementById('date');
const dateErrorDiv = document.getElementById('date-error');

dateInputField.addEventListener('blur', () => {
  const val = dateInputField.value.trim();
  const parts = val.split('/');
  if (parts.length !== 2) {
    dateErrorDiv.style.display = 'block';
    return;
  }

  const [mm, yyyy] = parts;
  const parsedMonth = parseInt(mm, 10);
  const parsedYear = parseInt(yyyy, 10);

  if (isNaN(parsedMonth) || isNaN(parsedYear) || parsedMonth < 1 || parsedMonth > 12) {
    dateErrorDiv.style.display = 'block';
    return;
  }

  const enteredDate = new Date(parsedYear, parsedMonth - 1, 1);
  const now = new Date();
  now.setHours(0, 0, 0, 0); // pour éviter les bugs d’heure

  if (enteredDate < now) {
    dateErrorDiv.style.display = 'block';
  } else {
    dateErrorDiv.style.display = 'none';
  }
});

</script>
 <script>
    // Collez la fonction showTab ici
  function showTab(tabId) {
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.classList.remove('active'));

  const buttons = document.querySelectorAll('#notif-tabs .tab-button');
  buttons.forEach(button => button.classList.remove('active'));

  document.getElementById(tabId).classList.add('active');
  document.querySelector(`#notif-tabs .tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
}

async function loadNotifications() {
  const RANGE_A_ENLEVER = "Feuille2!A1:H1000";
  const parseDate = (dateStr) => {
    if (!dateStr) return null;
    let parts = dateStr.split('-');
    if (parts.length === 3) {
      // Format AAAA-MM-JJ
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }
    parts = dateStr.split('/');
    if (parts.length === 3) {
      // Format JJ/MM/AAAA
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    return null;
  };

  try {
    const resFeuille1 = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: RANGE
    });
    const dataFeuille1 = (resFeuille1.result.values || []).slice(1);

    const resFeuille2 = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: RANGE_A_ENLEVER
    });
    const dataFeuille2 = (resFeuille2.result.values || []).slice(1);

    const now = new Date();
    const currentDay = now.getDate();
    const currentMonthNumber = now.getMonth();
    const currentYearNumber = now.getFullYear();

    const grouped = {
      'trimestre': {},
      '2nd-month': [],
      'current-month': []
    };

    // Logique pour le mois précédent ("À enlever")
    const prevMonth = (currentMonthNumber - 1 + 12) % 12;
    const prevMonthYear = (currentMonthNumber === 0) ? currentYearNumber - 1 : currentYearNumber;

    dataFeuille2.forEach(row => {
      const dateStr = row[1];
      const d = parseDate(dateStr);
      if (!d) return;

      const rowMonth = d.getMonth();
      const rowYear = d.getFullYear();

      if (rowYear === prevMonthYear && rowMonth === prevMonth) {
        grouped['current-month'].push(row);
      }
    });

    // Traitement des données de la Feuille1 pour le trimestre et le 2ème mois
    dataFeuille1.forEach(row => {
      const dateStr = row[1];
      const d = parseDate(dateStr);
      if (!d) return;

      const rowMonth = d.getMonth();
      const rowYear = d.getFullYear();
      const ym = `${rowYear}-${String(rowMonth + 1).padStart(2, '0')}`;

      // Trimestre (3 prochains mois, du 15 au 14)
      let trimestreStartDate = new Date(currentYearNumber, currentMonthNumber, 15);
      let trimestreEndDate = new Date(trimestreStartDate);
      trimestreEndDate.setMonth(trimestreEndDate.getMonth() + 3);
      trimestreEndDate.setDate(14);
      
      if (currentDay > 14) {
          trimestreStartDate = new Date(currentYearNumber, currentMonthNumber, 15);
          trimestreEndDate = new Date(currentYearNumber, currentMonthNumber + 4, 14);
      } else {
          trimestreStartDate = new Date(currentYearNumber, currentMonthNumber - 1, 15);
          trimestreEndDate = new Date(currentYearNumber, currentMonthNumber + 3, 14);
      }
      
      if ((d > trimestreStartDate && d <= trimestreEndDate) || 
          (d.getFullYear() === trimestreStartDate.getFullYear() && d.getMonth() === trimestreStartDate.getMonth() && d.getDate() >= trimestreStartDate.getDate())) {
        if (!grouped['trimestre'][ym]) {
          grouped['trimestre'][ym] = [];
        }
        grouped['trimestre'][ym].push(row);
      }

      // 2ème mois du trimestre (mois central du trimestre)
      let secondMonthStartDate = new Date(currentYearNumber, currentMonthNumber + 1, 15);
      let secondMonthEndDate = new Date(currentYearNumber, currentMonthNumber + 2, 14);

      if (currentDay > 14) {
          secondMonthStartDate = new Date(currentYearNumber, currentMonthNumber + 2, 15);
          secondMonthEndDate = new Date(currentYearNumber, currentMonthNumber + 3, 14);
      }

      if ((d > secondMonthStartDate && d <= secondMonthEndDate) ||
          (d.getFullYear() === secondMonthStartDate.getFullYear() && d.getMonth() === secondMonthStartDate.getMonth() && d.getDate() >= secondMonthStartDate.getDate())) {
        grouped['2nd-month'].push(row);
      }
    });

    const formatMonthYear = (d) => {
      const months = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
      return months[d.getMonth()] + ' ' + d.getFullYear();
    };

    const renderTable = (rows) => {
      if (rows.length === 0) {
        return '<p>Aucun produit périmé pour ce mois.</p>';
      }
      rows.sort((a, b) => (a[5] || '').localeCompare(b[5] || ''));

      let tableHtml = `<table>
          <thead>
              <tr>
                  <th>Date</th><th>Nom</th><th>Code</th><th>Qté</th><th>Zone</th><th>Vendues</th><th>Promo</th>
              </tr>
          </thead>
          <tbody>`;

      rows.forEach(row => {
        const qte = parseInt(row[4] || '0');
        const vendu = parseInt(row[6] || '0');
        const isSoldOut = !isNaN(qte) && !isNaN(vendu) && qte === vendu;
        tableHtml += `<tr class="${isSoldOut ? 'ligne-vendue' : ''}">`;
        [1, 2, 3, 4, 5, 6, 7].forEach(ci => {
          tableHtml += `<td>${row[ci] || ''}</td>`;
        });
        tableHtml += '</tr>';
      });
      tableHtml += '</tbody></table>';
      return tableHtml;
    };

    // Rendu pour le trimestre
    let trimestreHtml = '';
    const sortedTrimestreMonths = Object.keys(grouped['trimestre']).sort();
    if (sortedTrimestreMonths.length === 0) {
      trimestreHtml = '<p>Aucun produit périmé pour le trimestre.</p>';
    } else {
      sortedTrimestreMonths.forEach(ym => {
        const [y, m] = ym.split('-');
        const d = new Date(y, m - 1, 1);
        trimestreHtml += `<h3>${formatMonthYear(d)}</h3>`;
        trimestreHtml += renderTable(grouped['trimestre'][ym]);
      });
    }
    document.getElementById('trimestre').innerHTML = trimestreHtml;

    // Rendu pour le 2ème mois (mois + 2)
    const secondMonthTitleDate = new Date(currentYearNumber, currentMonthNumber + (currentDay > 14 ? 2 : 1));
    document.getElementById('2nd-month').innerHTML = `<h3>${formatMonthYear(secondMonthTitleDate)}</h3>` + renderTable(grouped['2nd-month']);

    // Rendu pour le mois précédent ("À enlever")
    const prevMonthDate = new Date(now.getFullYear(), now.getMonth() - 1);
    const prevMonthTitle = formatMonthYear(prevMonthDate);
    document.getElementById('current-month').innerHTML = `<h3>${prevMonthTitle}</h3>` + renderTable(grouped['current-month']);

  } catch (e) {
    console.error("Erreur chargement notifications :", e);
    const notifContent = document.getElementById('notification-popup').querySelector('.content');
    notifContent.innerHTML = `<p>Erreur chargement notifications : ${e.message}</p>`;
  }
}
</script>
  <script>
  document.getElementById('btn-login').addEventListener('click', () => {
    const overlay = document.getElementById('update-overlay');
    if (overlay) overlay.style.display = 'none';
  });
</script>
</body>
</html>


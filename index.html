<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>App Google Sheets - Écriture</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h2>Connexion Google Sheets API - Écriture de données</h2>
  <button id="authorize_button">Connexion</button>
  <button id="signout_button" style="display:none;">Déconnexion</button>
  <button id="append_button" style="display:none;">Ajouter une ligne</button>

  <pre id="content" style="margin-top: 20px;"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1!A1:C1'; // Assure-toi que "Feuille1" correspond bien au nom exact de ta feuille

    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton = document.getElementById('signout_button');
    const appendButton = document.getElementById('append_button');
    const content = document.getElementById('content');

    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    function initClient() {
      gapi.client.init({
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(() => {
        const authInstance = gapi.auth2.getAuthInstance();
        authInstance.isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(authInstance.isSignedIn.get());
        authorizeButton.onclick = () => authInstance.signIn();
        signoutButton.onclick = () => authInstance.signOut();
        appendButton.onclick = appendRow;
      }).catch(error => {
        content.textContent = 'Erreur initialisation : ' + JSON.stringify(error, null, 2);
      });
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'inline-block';
        appendButton.style.display = 'inline-block';
        content.textContent = 'Connecté. Prêt à ajouter une ligne.';
      } else {
        authorizeButton.style.display = 'inline-block';
        signoutButton.style.display = 'none';
        appendButton.style.display = 'none';
        content.textContent = 'Déconnecté.';
      }
    }

    function appendRow() {
      const values = [
        ["NomExemple", "PrenomExemple", new Date().toLocaleString()]
      ];
      const body = { values: values };

      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: "USER_ENTERED",
        insertDataOption: "INSERT_ROWS",
        resource: body
      }).then(response => {
        content.textContent = 'Ligne ajoutée avec succès ! Détails :\n' + JSON.stringify(response.result.updates, null, 2);
      }).catch(error => {
        content.textContent = 'Erreur lors de l\'ajout : ' + (error.result?.error?.message || error.message);
      });
    }

    handleClientLoad();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Historique des produits périmés</title>
  <style>
    :root {
      --bleu-glacial: #bcd7ed;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f9f9f9;
    }
    header {
      background-color: var(--bleu-glacial);
      color: #0a2f51;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    #header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #header-left a {
      display:inline-block;
      width:40px;
      height:40px;
      border-radius:50%;
      overflow:hidden;
      border:2px solid #0a2f51;
    }
    #header-left img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
    h1 {
      margin: 0;
      font-size: 1.3em;
    }
    #filters {
      display: flex;
      gap: 15px;
      margin: 20px;
      align-items: flex-end;
    }
    #filters input, #filters button {
      padding: 5px 8px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #filters button {
      background-color: var(--bleu-glacial);
      color: #0a2f51;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    #filters button:hover {
      background-color: #a6c6e1;
    }
    table {
      width: calc(100% - 40px);
      margin: 20px;
      border-collapse: collapse;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: center;
    }
    tbody tr:nth-child(odd) {
      background-color: rgba(188, 215, 237, 0.15);
    }
  </style>
</head>
<body>

<header>
  <div id="header-left">
    <a href="/index.html" title="Accueil">
      <img src="https://raw.githubusercontent.com/ton-utilisateur/ta-bibliotheque/main/logo.png" alt="Logo">
    </a>
    <h1>Historique des produits périmés</h1>
  </div>
</header>

<section id="filters">
  <label>Filtrer par zone:</label>
  <input type="text" id="filter-zone" placeholder="Ex: Zone A" />
  <label>Mois (MM/YYYY):</label>
  <input type="month" id="filter-month" />
  <button onclick="applyFilters()">Filtrer</button>
  <button onclick="resetFilters()">Réinitialiser</button>
</section>

<table id="history-table">
  <thead>
    <tr>
      <th>Produit</th>
      <th>Date</th>
      <th>Qté</th>
      <th>Zone</th>
      <th>Vendues</th>
      <th>Promo</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="6">Chargement...</td></tr>
  </tbody>
</table>

<script src="https://apis.google.com/js/api.js"></script>
<script>
const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
const RANGE = 'historique';

window.onload = () => {
  gapi.load('client', async () => {
    await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
    loadData();
  });
};

let allData = [];

async function loadData() {
  try {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: RANGE
    });
    allData = res.result.values || [];
    renderTable(allData);
  } catch (e) {
    document.querySelector('#history-table tbody').innerHTML = '<tr><td colspan="6">Erreur chargement données.</td></tr>';
  }
}

function renderTable(data) {
  const tbody = document.querySelector('#history-table tbody');
  tbody.innerHTML = '';
  data.slice(1).forEach(row => {
    const tr = document.createElement('tr');
    const cols = [1, 2, 3, 4, 5, 6];
    cols.forEach(i => {
      const td = document.createElement('td');
      td.textContent = row[i] || '';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function applyFilters() {
  const zone = document.getElementById('filter-zone').value.toLowerCase();
  const month = document.getElementById('filter-month').value; // yyyy-mm
  const filtered = allData.filter((row, idx) => {
    if (idx === 0) return false;
    const rowZone = (row[4] || '').toLowerCase();
    const date = row[2] || '';
    const matchZone = zone ? rowZone.includes(zone) : true;
    const matchMonth = month ? date.startsWith(month) : true;
    return matchZone && matchMonth;
  });
  renderTable([allData[0], ...filtered]);
}

function resetFilters() {
  document.getElementById('filter-zone').value = '';
  document.getElementById('filter-month').value = '';
  renderTable(allData);
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion P√©rim√© - Pharmacie du Libron</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f9f9f9;
    }
    header {
      background-color: #0d6efd;
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header h1 {
      margin: 0;
      font-size: 1.4em;
      user-select: none;
    }
    .left-buttons, .right-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 0.9em;
      background: white;
      color: #0d6efd;
      transition: background-color 0.3s, color 0.3s;
    }
    button:hover {
      background-color: #0b5ed7;
      color: white;
    }
    button:disabled {
      background: #ccc;
      color: #666;
      cursor: default;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      user-select: none;
    }
    input, select {
      margin: 5px;
      padding: 6px 8px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* Masquer colonne op√©rateur compl√®tement */
    #data-table th.operator-col,
    #data-table td.operator-col {
      display: none;
    }

    /* Popup notifications centr√©e */
    #popup-notif {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 400px;
      max-height: 500px;
      overflow-y: auto;
      background: white;
      border: 1px solid #0d6efd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      padding: 20px 20px 40px 20px;
      transform: translate(-50%, -50%);
      z-index: 2000;
    }
    #popup-notif .close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      color: #0d6efd;
      user-select: none;
    }
    #popup-notif h3 {
      margin-top: 0;
      color: #0d6efd;
    }
    #popup-notif table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #popup-notif th, #popup-notif td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      font-size: 0.9em;
      text-align: center;
    }
    #btn-print-notif {
      margin-bottom: 10px;
      padding: 6px 12px;
      background: #0d6efd;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95em;
    }
    #btn-print-notif:hover {
      background: #0b5ed7;
    }

    #status {
      margin-top: 10px;
      font-style: italic;
      color: #555;
      padding-left: 10px;
    }

    /* Style cellule √©ditable */
    td.editable {
      cursor: pointer;
      background-color: #f0f8ff;
      user-select: text;
    }
    td.editable:hover {
      background-color: #d0e4ff;
    }
    td.editable input[type="number"] {
      width: 80px;
      font-size: 1em;
      padding: 2px 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <header>
    <div class="left-buttons">
      <h1>Gestion P√©rim√© - Pharmacie du Libron</h1>
      <button id="btn-choose-operator" style="margin-left:20px;">Choix Op√©rateur</button>
    </div>
    <div class="right-buttons">
      <button id="btn-notif" title="Notifications">üîî</button>
      <button id="btn-history" title="Historique">‚è≥</button>
      <button id="btn-logout" title="D√©connexion" style="display:none;">üîí D√©connexion</button>
    </div>
  </header>

  <div id="operator-form" style="display:none; padding: 10px;">
    <label>Nom Op√©rateur :</label>
    <select id="operator">
      <option value="">-- Choisir --</option>
      <option>Op1</option>
      <option>Op2</option>
      <option>Op3</option>
      <option>Op4</option>
    </select>
    <button id="btn-confirm-operator">Valider</button>
  </div>

  <div id="entry-form" style="display:none; margin-top: 20px; padding: 0 10px;">
    <h3>Ajouter un produit</h3>
    <input type="date" id="date" />
    <input type="text" id="product" placeholder="Nom Bo√Æte" />
    <input type="number" id="qty" placeholder="Nb Bo√Ætes" />
    <input type="text" id="zone" placeholder="Zone" />
    <input type="number" id="sold" placeholder="Nb vendus" />
    <input type="number" id="promo" placeholder="Nb promo" />
    <button id="btn-add">Ajouter la ligne</button>
  </div>

  <div style="padding: 10px;">
    <label>Filtrer Zone :</label>
    <input type="text" id="filter-zone" />
    <label>Mois (MM/YYYY) :</label>
    <input type="text" id="filter-month" placeholder="ex: 06/2025" />
    <button onclick="filterTable()">Filtrer</button>
  </div>

  <table id="data-table">
    <thead>
      <tr>
        <th class="operator-col">Op√©rateur</th>
        <th>Produit</th>
        <th>Date</th>
        <th>Qt√©</th>
        <th>Zone</th>
        <th>Vendues</th>
        <th>Promo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <pre id="status"></pre>

  <!-- Popup notification -->
  <div id="popup-notif">
    <span class="close-btn" title="Fermer">&times;</span>
    <h3>Produits p√©rim√©s 3 mois suivants</h3>
    <button id="btn-print-notif">Imprimer</button>
    <div id="notif-content">Chargement...</div>
  </div>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1';
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    let tokenClient, gapiInited = false, gisInited = false, accessToken = null, operatorName = null;
    let sheetRows = []; // Contiendra les donn√©es brutes avec op√©rateur pour modification

    // Chargement des APIs Google
    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() {
      await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
      gapiInited = true;
      maybeEnableButtons();
    }
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            document.getElementById('status').textContent = 'Erreur d\'authentification';
            return;
          }
          accessToken = tokenResponse.access_token;
          document.getElementById('operator-form').style.display = 'block';
          document.getElementById('btn-choose-operator').style.display = 'none';
          document.getElementById('btn-logout').style.display = 'inline-block';
          document.getElementById('status').textContent = 'Connect√©. Choisissez un op√©rateur.';
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('btn-choose-operator').disabled = false;
      }
    }

    // Event bouton connexion choix op√©rateur
    document.getElementById('btn-choose-operator').onclick = () => {
      if (!accessToken) {
        tokenClient.requestAccessToken();
      } else {
        document.getElementById('operator-form').style.display = 'block';
        document.getElementById('entry-form').style.display = 'none';
      }
    };

    // Confirmation op√©rateur
    document.getElementById('btn-confirm-operator').onclick = () => {
      const op = document.getElementById('operator').value;
      if (!op) return alert("Choisir un op√©rateur");
      operatorName = op;
      document.getElementById('operator-form').style.display = 'none';
      document.getElementById('entry-form').style.display = 'block';
      loadSheet();
      document.getElementById('status').textContent = `Connect√© en tant que : ${operatorName}`;
    };

    // D√©connexion
    document.getElementById('btn-logout').onclick = () => {
      accessToken = null;
      operatorName = null;
      sheetRows = [];
      document.getElementById('btn-choose-operator').style.display = 'inline-block';
      document.getElementById('btn-logout').style.display = 'none';
      document.getElementById('operator-form').style.display = 'none';
      document.getElementById('entry-form').style.display = 'none';
      document.getElementById('status').textContent = "D√©connect√©.";
      clearTable();
    };

    // Charger donn√©es de la feuille Google Sheets
    async function loadSheet() {
      if (!accessToken) return;
      gapi.client.setToken({ access_token: accessToken });
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
        });
        const values = response.result.values || [];
        // On stocke les donn√©es ligne par ligne (y compris op√©rateur) dans sheetRows pour modif
        sheetRows = values.map((row, i) => ({
          rowIndex: i + 1, // Ligne dans la feuille (1-based)
          operator: row[0] || '',
          product: row[1] || '',
          date: row[2] || '',
          qty: row[3] || '',
          zone: row[4] || '',
          sold: row[5] || '',
          promo: row[6] || ''
        }));
        refreshTable();
      } catch (e) {
        document.getElementById('status').textContent = "Erreur chargement feuille : " + e.message;
      }
    }

    // Rafra√Æchir tableau affich√© (filtrage inclus)
    function refreshTable() {
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      let filtered = sheetRows;

      // Filtrer sur op√©rateur (unique)
      if (operatorName) filtered = filtered.filter(r => r.operator === operatorName);

      // Filtrer zone et mois
      const zoneFilter = document.getElementById('filter-zone').value.trim().toLowerCase();
      if(zoneFilter) {
        filtered = filtered.filter(r => r.zone.toLowerCase().includes(zoneFilter));
      }
      const monthFilter = document.getElementById('filter-month').value.trim();
      if(monthFilter) {
        filtered = filtered.filter(r => {
          if(!r.date) return false;
          // format date en ISO "yyyy-mm-dd"
          let d = new Date(r.date);
          if(isNaN(d)) return false;
          const m = ("0"+(d.getMonth()+1)).slice(-2);
          const y = d.getFullYear();
          return monthFilter === `${m}/${y}`;
        });
      }

      for(let row of filtered) {
        const tr = document.createElement('tr');

        // Colonne op√©rateur cach√©e (mais pr√©sente pour garder alignement)
        const tdOp = document.createElement('td');
        tdOp.className = 'operator-col';
        tdOp.textContent = row.operator;
        tr.appendChild(tdOp);

        // Produit
        const tdProd = document.createElement('td');
        tdProd.textContent = row.product;
        tr.appendChild(tdProd);

        // Date
        const tdDate = document.createElement('td');
        tdDate.textContent = row.date;
        tr.appendChild(tdDate);

        // Qt√© √©ditable
        const tdQty = document.createElement('td');
        tdQty.className = 'editable';
        tdQty.dataset.field = 'qty';
        tdQty.dataset.rowIndex = row.rowIndex;
        tdQty.textContent = row.qty;
        tr.appendChild(tdQty);

        // Zone
        const tdZone = document.createElement('td');
        tdZone.textContent = row.zone;
        tr.appendChild(tdZone);

        // Vendues √©ditable
        const tdSold = document.createElement('td');
        tdSold.className = 'editable';
        tdSold.dataset.field = 'sold';
        tdSold.dataset.rowIndex = row.rowIndex;
        tdSold.textContent = row.sold;
        tr.appendChild(tdSold);

        // Promo √©ditable
        const tdPromo = document.createElement('td');
        tdPromo.className = 'editable';
        tdPromo.dataset.field = 'promo';
        tdPromo.dataset.rowIndex = row.rowIndex;
        tdPromo.textContent = row.promo;
        tr.appendChild(tdPromo);

        tbody.appendChild(tr);
      }
    }

    // Vider tableau (ex d√©connexion)
    function clearTable() {
      document.querySelector('#data-table tbody').innerHTML = '';
    }

    // Ajouter une nouvelle ligne (bouton ajouter)
    document.getElementById('btn-add').onclick = async () => {
      if (!accessToken) return alert("Vous devez √™tre connect√©");
      const date = document.getElementById('date').value;
      const product = document.getElementById('product').value.trim();
      const qty = document.getElementById('qty').value.trim();
      const zone = document.getElementById('zone').value.trim();
      const sold = document.getElementById('sold').value.trim();
      const promo = document.getElementById('promo').value.trim();
      if (!date || !product || !qty || !zone) return alert("Veuillez remplir au moins date, produit, qt√©e, zone");

      const newRow = [operatorName, product, date, qty, zone, sold || '0', promo || '0'];

      try {
        gapi.client.setToken({ access_token: accessToken });
        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
          valueInputOption: "USER_ENTERED",
          insertDataOption: "INSERT_ROWS",
          resource: {
            values: [newRow]
          }
        });
        document.getElementById('status').textContent = "Ligne ajout√©e.";
        // Rafra√Æchir donn√©es
        await loadSheet();

        // Clear form
        document.getElementById('date').value = '';
        document.getElementById('product').value = '';
        document.getElementById('qty').value = '';
        document.getElementById('zone').value = '';
        document.getElementById('sold').value = '';
        document.getElementById('promo').value = '';
      } catch (e) {
        alert("Erreur ajout ligne : " + e.message);
      }
    };

    // Edition inline des cellules Qt√©, Vendues, Promo
    document.querySelector('#data-table tbody').addEventListener('click', function(e) {
      const td = e.target.closest('td.editable');
      if(!td) return;

      if(td.querySelector('input')) return; // d√©j√† en √©dition

      const oldValue = td.textContent;
      td.textContent = '';

      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.value = oldValue || '0';
      td.appendChild(input);
      input.focus();

      // Gestion sortie de champ (blur ou entr√©e)
      function save() {
        let val = input.value.trim();
        if(val === '' || isNaN(val) || Number(val) < 0) val = '0';
        td.removeChild(input);
        td.textContent = val;

        // Mise √† jour dans sheetRows et Google Sheets
        const rowIndex = parseInt(td.dataset.rowIndex, 10);
        const field = td.dataset.field;

        // Trouver ligne dans sheetRows
        const row = sheetRows.find(r => r.rowIndex === rowIndex);
        if(!row) return;

        row[field] = val;

        updateSheetCell(rowIndex, field, val);
      }

      input.onblur = save;
      input.onkeydown = function(ev) {
        if(ev.key === 'Enter') {
          input.blur();
        }
        if(ev.key === 'Escape') {
          td.removeChild(input);
          td.textContent = oldValue;
        }
      };
    });

    // Mappage champ √† colonne Google Sheet (0-based)
    const fieldToCol = {
      qty: 3,
      sold: 5,
      promo: 6
    };

    // Mise √† jour d'une cellule dans Google Sheets via API
    async function updateSheetCell(rowIndex, field, value) {
      if(!accessToken) return;
      gapi.client.setToken({ access_token: accessToken });

      const colIndex = fieldToCol[field];
      if(colIndex === undefined) return;

      // Adresse cellule ex: D2 (col 3 => D, ligne 2)
      const colLetter = String.fromCharCode('A'.charCodeAt(0) + colIndex);
      const cellAddress = `${colLetter}${rowIndex}`;

      try {
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${RANGE}!${cellAddress}`,
          valueInputOption: "USER_ENTERED",
          resource: { values: [[value]] }
        });
        document.getElementById('status').textContent = `Mise √† jour OK ligne ${rowIndex}, champ ${field}`;
      } catch(e) {
        document.getElementById('status').textContent = "Erreur mise √† jour : " + e.message;
      }
    }

    // Filtrer tableau
    function filterTable() {
      refreshTable();
    }

    // Notification popup
    const popup = document.getElementById('popup-notif');
    document.getElementById('btn-notif').onclick = async () => {
      if(!accessToken) {
        alert("Connectez-vous d'abord");
        return;
      }
      popup.style.display = 'block';
      await loadNotification();
    };
    popup.querySelector('.close-btn').onclick = () => popup.style.display = 'none';

    // Imprimer notification
    document.getElementById('btn-print-notif').onclick = () => {
      const content = document.getElementById('notif-content').innerHTML;
      const printWindow = window.open('', '', 'width=600,height=600');
      printWindow.document.write('<html><head><title>Impression p√©rim√©s</title></head><body>');
      printWindow.document.write(content);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    };

    // Charger notifications p√©rim√©s (sur 3 mois √† partir du 15 du mois courant)
    async function loadNotification() {
      const notifContent = document.getElementById('notif-content');
      notifContent.innerHTML = "Chargement...";
      if(sheetRows.length === 0) {
        await loadSheet();
      }

      const today = new Date();
      const checkDate = new Date(today.getFullYear(), today.getMonth(), 15);
      // 3 mois suivants
      const limitDate = new Date(checkDate.getFullYear(), checkDate.getMonth() + 3, 0);

      // Filtrer p√©rim√©s entre checkDate et limitDate
      const filtered = sheetRows.filter(r => {
        if(!r.date) return false;
        let d = new Date(r.date);
        if(isNaN(d)) return false;
        return d >= checkDate && d <= limitDate;
      });

      if(filtered.length === 0) {
        notifContent.innerHTML = "<p>Aucun produit p√©rim√© dans les 3 mois.</p>";
        return;
      }

      // Grouper par mois
      const groups = {};
      filtered.forEach(r => {
        const d = new Date(r.date);
        const key = `${("0"+(d.getMonth()+1)).slice(-2)}/${d.getFullYear()}`;
        if(!groups[key]) groups[key] = [];
        groups[key].push(r);
      });

      let html = '';
      for(let month in groups) {
        html += `<h4>${month}</h4><table><thead><tr>
          <th>Produit</th><th>Date</th><th>Qt√©</th><th>Zone</th><th>Vendues</th><th>Promo</th>
          </tr></thead><tbody>`;
        groups[month].forEach(r => {
          html += `<tr>
            <td>${r.product}</td><td>${r.date}</td><td>${r.qty}</td><td>${r.zone}</td><td>${r.sold}</td><td>${r.promo}</td>
          </tr>`;
        });
        html += '</tbody></table>';
      }
      notifContent.innerHTML = html;
    }

    window.onload = () => {
      document.getElementById('btn-choose-operator').disabled = true;
      // Charger Google API
      gapiLoaded();
      gisLoaded();
    }
  </script>

</body>
</html>

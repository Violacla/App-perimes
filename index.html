<!DOCTYPE html>
<html>
  <head>
    <title>App Péremise - Test Google Sheets</title>
    <script src="https://apis.google.com/js/api.js"></script>
  </head>
  <body>
    <h2>Connexion Google Sheets API</h2>
    <button id="authorize_button">Connexion</button>
    <button id="signout_button" style="display:none;">Déconnexion</button>

    <pre id="content" style="margin-top: 20px;"></pre>

    <script>
      const CLIENT_ID = '896851814479-3ptbunq6dp62seo6s2unq0uff4vvvirq.apps.googleusercontent.com';
      const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
      const RANGE = 'A1:E20';

      const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

      const authorizeButton = document.getElementById('authorize_button');
      const signoutButton = document.getElementById('signout_button');
      const content = document.getElementById('content');

      function initClient() {
        console.log("Initialisation client...");
        gapi.client.init({
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(() => {
          console.log("Client initialisé");
          const authInstance = gapi.auth2.getAuthInstance();
          authInstance.isSignedIn.listen(updateSigninStatus);
          updateSigninStatus(authInstance.isSignedIn.get());

          authorizeButton.onclick = () => {
            console.log("Bouton Connexion cliqué");
            authInstance.signIn();
          };

          signoutButton.onclick = () => {
            console.log("Bouton Déconnexion cliqué");
            authInstance.signOut();
          };
        }, (error) => {
          console.error("Erreur init client", error);
          content.textContent = 'Erreur initialisation : ' + JSON.stringify(error, null, 2);
        });
      }

      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          console.log("Utilisateur connecté");
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          listData();
        } else {
          console.log("Utilisateur non connecté");
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
          content.textContent = '';
        }
      }

      function listData() {
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE
        }).then(response => {
          const rows = response.result.values;
          if (rows && rows.length) {
            content.textContent = rows.map(row => row.join(' | ')).join('\n');
          } else {
            content.textContent = 'Aucune donnée trouvée.';
          }
        }, error => {
          console.error("Erreur récupération données", error);
          content.textContent = 'Erreur : ' + error.result.error.message;
        });
      }

      function onLoad() {
        console.log("Chargement de l'API Google...");
        gapi.load('client:auth2', initClient);
      }

      window.onload = onLoad;
    </script>
  </body>
</html>

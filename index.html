<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Gestion Perim√© - Pharmacie du Libron</title>
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
<script src="https://apis.google.com/js/api.js"></script>
<style>
  /* Styles pour l'autocompl√©tion des listes */
  .autocomplete-list {
  position: absolute;
  background-color: white;
  border: 1px solid #ccc;
  border-radius: 4px;
  list-style: none;
  margin: 0;
  padding: 0;
  max-height: 150px;
  overflow-y: auto;
  width: 250px;
  z-index: 999;
}

.autocomplete-list li {
  padding: 8px 10px;
  cursor: pointer;
  color: black;
}

.autocomplete-list li:hover,
.autocomplete-list li.active {
 background-color: #86bf8e; /* Couleur de survol pour les suggestions */
  color: white;
}

  /* Variables de couleurs */
  :root {
    --bleu-glacial: #bcd7ed; /* Bleu clair */
  }

  /* Styles g√©n√©raux du corps de page */
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #fffefc; /* Fond blanc cass√© */
  }

  /* Styles de l'en-t√™te */
  header {
    background-color: var(--bleu-glacial);
    color: #163f5b; /* Couleur du texte de l'en-t√™te */
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  }

  #header-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  #header-left > h1 {
    margin: 0;
    font-size: 1.3em;
  }

  /* Styles des boutons g√©n√©raux de l'en-t√™te */
  button {
    cursor: pointer;
    border: none;
    background: transparent;
    font-size: 1em;
    color: black;
    padding: 6px 10px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: rgba(255 255 255 / 0.3); /* Effet de survol l√©ger */
  }

  /* Ic√¥nes utilis√©es */
  .icon {
    font-size: 1.2em;
    margin-right: 6px;
  }

  /* Boutons de droite de l'en-t√™te */
  #header-right {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  /* Formulaire d'op√©rateur */
  #operator-form {
    margin-left: 10px;
    display: inline-flex; /* Assure que les √©l√©ments sont sur la m√™me ligne */
    align-items: center; /* Aligne verticalement les √©l√©ments */
    gap: 10px; /* Espace entre les √©l√©ments du formulaire op√©rateur */
  }

  #operator-form input {
    padding: 8px;
    font-size: 1em;
    border-radius: 5px; /* Angles arrondis */
    border: 1px solid #0a2f51; /* Contour bleu fonc√© */
    box-sizing: border-box; /* Inclut le padding et le border dans la largeur */
  }

  #operator-form button {
    background-color: #0a2f51; /* Fond bleu fonc√© */
    color: white; /* Texte blanc */
    font-weight: bold; /* Texte en gras */
    padding: 8px 12px;
    border-radius: 5px; /* Angles arrondis */
    border: 1px solid #0a2f51; /* Contour bleu fonc√© */
    transition: background-color 0.3s ease;
  }
  #operator-form button:hover {
    background-color: #163f5b; /* Bleu fonc√© un peu plus clair au survol */
  }


  /* Layout principal de la page */
  main {
    display: flex;
    margin: 20px;
  }

  /* Formulaire pour ajouter des entr√©es (√† droite) */
 #entry-form {
  width: 320px;
  background: #f2f7f2; /* Couleur de fond vert tr√®s clair, presque blanc */
  padding: 15px 20px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  margin-left: 20px;
  margin-top: 20px; /* Alignement du haut avec les filtres */
  height: 360px; /* Hauteur fixe pour le bloc */
}

  #entry-form h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: normal;
  }
  #entry-form input {
    background-color: #e1f4e4; /* Fond vert tr√®s clair pour les champs */
    width: 100%;
    margin: 6px 0;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  #entry-form button {
    width: 100%;
    background-color: #bfdbc4; /* Vert pastel pour le bouton */
    color: black;
    font-weight: bold;
    margin-top: 10px;
  }
  #entry-form button:hover {
    background-color: #86bf8e; /* Vert plus fonc√© au survol */
  }

  /* Styles du tableau principal */
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    border-radius: 6px;
    overflow: hidden;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px 10px;
    text-align: center;
  }

  /* Couleur de fond altern√©e pour les lignes du tableau */
  tbody tr:nth-child(odd) {
    background-color: #ede2e6; /* Rose tr√®s clair */
  }

  /* Surlignage de la ligne s√©lectionn√©e */
  tbody tr.selected {
    background-color: #f2b4bb!important; /* Rose vif */
  }

  /* Cellules √©ditables */
  tbody td {
    cursor: text;
  }

  /* Section des filtres */
  #filters {
    background-color: #dce5dd; /* Couleur de fond verte */
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end; /* ALIGN√â: Aligne les √©l√©ments en bas pour les boutons */
    margin-bottom: 20px;
  }
  /* Groupe de label + input pour les filtres */
  .filter-group {
    display: flex;
    flex-direction: column; /* Empile le label au-dessus de l'input */
    align-items: flex-start;
  }
  #filters label {
    font-weight: bold;
    color: #0a2f51; /* Couleur du texte des labels */
    margin-bottom: 5px; /* Espace sous le label */
    display: block;
  }
  #filters input, #filters select {
    padding: 8px;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #filters button {
    background-color: #87c08f; /* Vert pour les boutons de filtre */
    color: black;
    border: none;
    cursor: pointer;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 5px;
    margin-top: auto; /* Pousse les boutons vers le bas de leur conteneur flex */
  }
  #filters button:hover {
    background-color: #5d9e63; /* Vert plus fonc√© au survol */
    color: white;
  }
  /* Style du texte √† l'int√©rieur des champs de saisie (placeholder) */
  #filters input::placeholder {
    color: #87c08f; /* Vert pastel pour le placeholder */
    opacity: 1; /* S'assure que la couleur est bien visible */
  }

  /* Texte de statut */
  #status {
    margin: 10px 20px;
    font-weight: bold;
    color: #0a2f51;
  }

  /* Styles pour la popup de notification */
  #notification-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    width: 1300px;
    max-height: 92vh;
    overflow-y: auto;
    z-index: 9999;
    display: none; /* Masqu√© par d√©faut */
    flex-direction: column;
  }
  #notification-popup header {
    display: flex;
    justify-content: space-between;
    align-items: center; /* Alignement centr√© pour les √©l√©ments de l'en-t√™te de la popup */
    padding: 10px 20px;
    background-color: var(--bleu-glacial);
    color: #163f5b;
    border-radius: 10px 10px 0 0;
  }
  #notif-tabs {
    display: flex;
    gap: 10px;
    margin-left: auto; /* Aligne les onglets √† droite du titre */
  }
  .header-buttons {
    display: flex;
    gap: 10px;
  }
  .tab-button {
    background-color: transparent;
    color: #163f5b; /* Texte du bouton d'onglet par d√©faut */
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s, color 0.3s;
    border-radius: 5px 5px 0 0;
  }
  .tab-button:hover,
  .tab-button.active {
    background-color: #85b9dd; /* Fond bleu fonc√© au survol et pour l'onglet actif */
    color: white; /* Texte blanc au survol et pour l'onglet actif */
  }
  .tab-content {
    display: none; /* Contenu de l'onglet masqu√© par d√©faut */
    padding: 15px;
    overflow-y: auto;
    max-height: calc(92vh - 80px); /* Hauteur calcul√©e pour le contenu */
    color: black;
  }
  .tab-content h3 {
    text-align: left;
    color: black;
  }
  .tab-content.active {
    display: block;
  }
  .ligne-vendue td {
  text-decoration: line-through;
  background-color: #d8c0ca !important; /* Couleur de fond pour les lignes vendues */
  color: #efe8eb; /* Couleur du texte pour les lignes vendues */
}
  /* Styles pour l'impression (cache tout sauf la popup de notification) */
  @media print {
    body > :not(#notification-popup) {
      display: none;
    }
    #notification-popup {
      position: static !important;
      transform: none !important;
      top: auto !important;
      left: auto !important;
      width: 100% !important;
      height: auto !important;
      max-height: none !important;
      overflow: visible !important;
      margin: 0 !important;
      padding: 0 !important;
      border-radius: 0 !important;
      display: block !important;
    }
    #notification-popup .tab-content:not(.active) {
      display: none !important;
    }
    #notification-popup #notif-tabs,
    #notification-popup .header-buttons {
      display: none !important;
    }
    html, body {
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    #notification-popup .tab-content,
    #notification-popup .content {
      max-height: none !important;
      overflow: visible !important;
    }
  }
  /* Style pour les messages d'erreur de date */
  #date-error {
  display: none;
  background-color: white;
  color: #87c08f;
  padding: 10px;
  margin: 10px 0;
  border: 3px solid #87c08f;
  border-radius: 10px;
  font-weight: bold;
  text-align: center;
  font-size: 2.5em;
  max-width: 90%;
  margin: 0 auto 10px auto;
}
/* Overlay de mise √† jour au d√©marrage */
#update-overlay {
  position: fixed;
  top: 60px; /* Laisse le bandeau de l'en-t√™te visible */
  left: 0;
  width: 100%;
  height: calc(100% - 60px);
  background-color: rgba(188, 215, 237, 0.9); /* Bleu glacial transparent */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9998;
}

#update-popup {
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.25);
  max-width: 600px;
  text-align: center;
  font-size: 1.1em;
}

#update-popup h2 {
  margin-top: 0;
  color: #87c08f; /* Vert */
}

#update-popup ul {
  list-style: none;
  padding-left: 0;
  text-align: left;
  margin-bottom: 20px;
}

#update-popup ul li::before {
  content: "üîπ "; /* Puce personnalis√©e */
}

#update-logo {
  display: block;
  margin: 20px auto 0 auto;
  width: 70px;
  height: auto;
}
  
/* Styles du bouton de connexion - NE SERA PLUS UTILIS√â */
#btn-login {
  display: none !important; /* Masqu√© de mani√®re forc√©e */
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<header>
<div id="header-left">
<a href="/index.html" style="
      display:inline-block;
      width:40px;
      height:40px;
      border-radius:50%;
      overflow:hidden;
      border:0px solid #0a2f51;
    " title="Accueil">
<img alt="Logo" src="https://i.imgur.com/AExTPc7.png" style="width:100%; height:100%; object-fit:cover;"/>
</a>
<h1>Gestion P√©rim√© - Pharmacie du Libron</h1>
<!-- Groupe op√©rateur - MAINTENANT VISIBLE PAR DEFAUT -->
<div id="operator-form" style="display:inline-flex; margin-left:10px;">
<input id="operator" placeholder="Nom de l'op√©rateur" type="text"/>
<button id="btn-confirm-operator">Valider</button>
</div>
<!-- Bouton connexion - SUPPRIM√â -->
</div>
<div id="header-right">
<button id="btn-notif" style="position: relative; display: inline-flex; align-items: center; gap: 5px;" title="Notifications">
  <span style="position: relative; display: inline-block; width: 18px; height: 18px;">
    <img alt="Logo" src="https://i.imgur.com/em9h9Wk.png" style="width: 100%; height: 100%; object-fit: cover; vertical-align: middle;" />
    <span id="notif-badge" style="display: none; position: absolute; top: 0px; right: 0px; width: 20px; height: 20px; z-index: 2;">
      <img src="https://i.imgur.com/EIvT5ot.png" style="width: 100%; height: 100%; object-fit: cover;" />
    </span>
  </span>
  Suivi P√©rim√©s
</button>

<button onclick="location.href='historique.html'" title="Historique">
<img alt="Historique" src="https://i.imgur.com/BasLkpT.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
Historique
</button>
  <button onclick="location.href='promotion.html'" title="Promo %">
% Promo
</button>
  <button id="btn-open-my-pdf" title="Ouvrir mon PDF personnalis√©">
  <img src="https://i.imgur.com/kGXfRUa.png" style="width:18px; height:18px; vertical-align:middle;"/>
</button>
<button id="btn-logout" style="display:none;" title="D√©connexion">
<img alt="D√©connexion" src="https://i.imgur.com/OPA1EuF.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
D√©connexion
</button>
</div>

</header>
<main>
<div style="flex-grow:1;">
<div id="filters">
    <div class="filter-group">
        <label for="filter-zone">Zone:</label>
        <input id="filter-zone" type="text" />
    </div>
    <div class="filter-group">
        <label for="filter-month">Date:</label>
        <input id="filter-month" placeholder="MM/YYYY ou YYYY" style="width: 140px;" type="text" />
    </div>
    <div class="filter-group">
        <label for="filter-name-code">Nom ou Code:</label>
        <input id="filter-name-code" type="text" />
    </div>
    <button onclick="filterTable()">Filtrer</button>
    <button onclick="clearFilter()">R√©initialiser</button>
    <button id="btn-print-table" title="EXPORTER EN PDF">
        <img src="https://i.imgur.com/WbH9qyS.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;" />
    </button>
    <ul class="autocomplete-list" id="filter-zone-suggestions" style="display: none;"></ul>
</div>
<div style="max-height: 400px; overflow-y: auto; border-radius: 6px; margin-top: 10px;"><table aria-label="Donn√©es des produits p√©rim√©s" id="data-table" tabindex="0">
<thead>
<tr>
<!-- Ne PAS afficher colonne op√©rateur -->
<th>Date</th>
<th>Produit</th>
<th>Code</th>
<th>Qt√©</th>
<th>Zone</th>
<th>Vendues</th>
<th>Promo</th>
<th>Suppr</th>
</tr>
</thead>
<tbody></tbody>
</table></div>
<pre id="status"></pre>
</div>
<form id="entry-form" onsubmit="return false;" style="display: none;">
<h3>Ajouter un produit</h3>
<input id="date" placeholder="MM/YYYY" type="text"/>
  <div id="date-error">DATE<br>INVALIDE</div>
<input id="product" placeholder="Nom Bo√Æte" type="text"/>
<input id="code" maxlength="6" minlength="6" pattern="\d{6}" placeholder="Code (6 chiffres)" required="" type="text"/>
<input id="qty" min="0" placeholder="Nb Bo√Ætes" type="number"/>
<input autocomplete="off" id="zone" placeholder="Zone" type="text"/>
<ul class="autocomplete-list" id="zone-suggestions" style="display: none;"></ul>
<button id="btn-add" type="button">Ajouter la ligne</button>
</form>
</main>
<!-- Popup de mise √† jour (s'affiche au d√©marrage, dispara√Æt √† la connexion) -->
  <div id="update-overlay">
  <div id="update-popup">
    <h2>Mise √† jour - 14/08/2025</h2>
    <ul>
      <li>Nouvelles fonctionnalit√©s : </li>
      <li>1.La connection a √©t√© modifi√© : la saisie du nom de l'op√©rateur suivie de la touche Entr√©e ou d'un clic sur "Valider" lance directement la connexion Google. </li>
      <li>2. Le bouton "Suivi P√©rim√©s" remplace "Notification" avec 3 onglets : <br>
      - " Trimestre " => Affiche les produits qui p√©rimeront dans les 3 prochains mois.<br>
      - " 2√®me Mois " => Affiche le mois "central" du trimestre (ex : Octobre si nous sommes en Ao√ªt) <br>
      - " √Ä retirer " => Affiche les produits p√©rim√©s le mois pr√©c√©dent, √† retirer des rayons. </li>
      <li>3. Cette fen√™tre d'information ne s'affichera qu'au d√©marrage et dispara√Ætra automatiquement une fois que vous serez connect√©. </li>
      <li>4. Un icone "?" a √©t√© ajout√© √† c√¥t√© de "% promo". Il vous donne acc√®s √† une page Google Drive pour un √©change direct et propose une description d√©taill√©e des fonctionnalit√©s de l'application. </li>
      <li>N'h√©sitez pas √† nous faire part de vos suggestions et remarques.<br>
    <em>Violaine</em> </li>
    </ul>
    <img src="https://i.imgur.com/yqzUg16.png" alt="Logo Mises √† jour" id="update-logo">
  </div>
</div>

<!-- Popup de notification (Suivi P√©rim√©s) -->
<div aria-labelledby="notif-title" aria-modal="true" id="notification-popup" role="dialog" style="display: none;">
    <header style="display: flex; align-items: center; gap: 20px;">
  <div style="display: flex; align-items: center; gap: 20px;">
    <span id="notif-title"> Produits p√©rim√©s</span>
    <div id="notif-tabs" style="margin: 0;">
      <button class="tab-button active" onclick="showTab('trimestre')">Trimestre</button>
      <button class="tab-button" onclick="showTab('2nd-month')">2√®me mois</button>
      <button class="tab-button" onclick="showTab('current-month')">√Ä retirer</button>
    </div>
  </div>
  <div class="header-buttons" style="margin-left: auto;">
    <button id="print-notif" title="Imprimer">
      <img src="https://i.imgur.com/qY1buNb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
    </button>
    <button id="close-notif" title="Fermer">
      <img src="https://i.imgur.com/7NKMuZy.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
    </button>
  </div>
</header>
    <div class="content">
        <div id="trimestre" class="tab-content active"></div>
        <div id="2nd-month" class="tab-content"></div>
        <div id="current-month" class="tab-content"></div>
    </div>
</div>

<footer style="
  position: fixed;
  bottom: 0;
  width: 100%;
  text-align: center;
  font-size: 0.6em;
  color: #666;
  background: #bfdbc4;
  padding: 8px 0;
  box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
  z-index: 10;
">
  D√©velopp√© par Violaine Claron - Mise √† jour 08/08/2025
</footer>

<script>
  // Constantes d'API Google Sheets
  const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
  const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
  const RANGE = 'Feuille1'; // Plage par d√©faut pour les donn√©es principales
  const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

  let tokenClient, gapiInited = false, gisInited = false, accessToken = null, operatorName = null;
  let pendingOperatorName = null; // Variable pour stocker le nom de l'op√©rateur temporairement

  // Initialisation de l'API Google Sheets
  function gapiLoaded() { gapi.load('client', initializeGapiClient); }
  async function initializeGapiClient() {
    await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
    gapiInited = true;
    maybeEnableButtons();
  }

  // Initialisation du client d'authentification Google Identity Services (GIS)
  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        // Cette fonction est appel√©e APR√àS que l'utilisateur se soit connect√© via Google
        accessToken = tokenResponse.access_token;
        if (pendingOperatorName) { // Si un nom d'op√©rateur a √©t√© saisi avant la connexion Google
            operatorName = pendingOperatorName; // On l'assigne comme op√©rateur final
            
            document.getElementById('operator-form').style.display = 'none'; // Cache le formulaire op√©rateur
            document.getElementById('btn-logout').style.display = 'inline-block'; // Affiche le bouton d√©connexion
            document.getElementById('entry-form').style.display = 'block'; // Affiche le formulaire d'ajout
            loadSheet(); // Charge les donn√©es principales
            setStatus(`Connect√© en tant que ${operatorName}.`);
            
            // Masquer l'overlay de mise √† jour apr√®s connexion
            const overlay = document.getElementById('update-overlay');
            if (overlay) overlay.style.display = 'none';
        } else {
            // Cas d'erreur si pendingOperatorName n'est pas d√©fini (ne devrait pas arriver avec le nouveau flux)
            setStatus('Erreur : Nom d\'op√©rateur non trouv√© apr√®s connexion Google.');
            console.error('Pending operator name was null after successful Google login.');
        }
        pendingOperatorName = null; // R√©initialise la variable temporaire
      },
    });
    gisInited = true;
    maybeEnableButtons(); // S'assure que tout est charg√© et g√®re le focus initial
  }

  // Active les fonctionnalit√©s quand les APIs sont charg√©es
  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('operator').focus(); // Met le focus sur le champ op√©rateur
      setStatus('Veuillez entrer votre nom d\'op√©rateur pour vous connecter.');
    }
  }

  // Affiche un message de statut en bas de page
  function setStatus(msg) {
    document.getElementById('status').textContent = msg;
  }

  // --- Nouvelle fonction pour initier la connexion (op√©rateur + Google) ---
  async function initiateGoogleAndOperatorLogin() {
    const op = document.getElementById('operator').value.trim();
    if (!op) {
        alert("Veuillez entrer un nom d'op√©rateur.");
        return;
    }
    pendingOperatorName = op; // Stocke le nom de l'op√©rateur temporairement

    try {
        // D√©clenche la requ√™te de jeton Google, ce qui ouvrira la popup de connexion Google si n√©cessaire
        await tokenClient.requestAccessToken();
        setStatus('Connexion Google en cours...'); // Message affich√© pendant la connexion Google
    } catch (error) {
        console.error("Erreur lors de la requ√™te du token Google:", error);
        setStatus("Erreur de connexion Google. Veuillez r√©essayer.");
        pendingOperatorName = null; // Nettoie le nom temporaire en cas d'erreur
    }
  }

  // Gestion des clics sur les boutons de connexion/d√©connexion et confirmation op√©rateur
  // Le bouton 'btn-login' a √©t√© supprim√©
  document.getElementById('btn-logout').onclick = () => {
    accessToken = null;
    operatorName = null;
    pendingOperatorName = null; // R√©initialise √©galement la variable temporaire
    
    document.getElementById('operator-form').style.display = 'inline-flex'; // R√©affiche le formulaire op√©rateur
    document.getElementById('operator').value = ''; // Efface le nom de l'op√©rateur
    document.getElementById('btn-logout').style.display = 'none'; // Cache le bouton d√©connexion
    document.getElementById('entry-form').style.display = 'none'; // Cache le formulaire d'ajout
    clearTable(); // Vide le tableau principal
    setStatus('D√©connect√©.');
    document.getElementById('operator').focus(); // Remet le focus sur le champ op√©rateur
  };

  // Lie le bouton "Valider" √† la nouvelle fonction de connexion
  document.getElementById('btn-confirm-operator').onclick = initiateGoogleAndOperatorLogin;

  // G√®re la touche "Entr√©e" dans le champ op√©rateur pour d√©clencher la connexion
  const operatorInput = document.getElementById('operator');
  if (operatorInput) {
    operatorInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        initiateGoogleAndOperatorLogin();
      }
    });
  }

  // Logique du bouton "Ajouter la ligne"
  document.getElementById('btn-add').onclick = async () => {
    if(!operatorName) {
      alert("Veuillez vous connecter et choisir un op√©rateur.");
      return;
    }

    let rawDate = document.getElementById('date').value;
    let dateVal = "";
    if (rawDate) {
      const [month, year] = rawDate.split('/');
      if (month && year) {
        const paddedMonth = month.padStart(2, '0');
        const lastDay = new Date(year, parseInt(paddedMonth), 0).getDate();
        dateVal = `${year}-${paddedMonth}-${lastDay}`;
      }
    }
    if (!dateVal) { // Date par d√©faut si non saisie
      const today = new Date();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const y = today.getFullYear();
      const d = new Date(y, today.getMonth() + 1, 0).getDate();
      dateVal = `${y}-${m}-${d}`;
    }

    const productVal = document.getElementById('product').value.trim();
    const qtyVal = parseInt(document.getElementById('qty').value);
    const zoneVal = document.getElementById('zone').value.trim();
    const codeVal = document.getElementById('code').value.trim();

    // Validations
    if (!zones.includes(zoneVal)) {
      alert("Veuillez choisir une zone existante dans la liste.");
      return;
    }
    if (!/^\d{6}$/.test(codeVal)) {
      alert("Le code doit contenir exactement 6 chiffres.");
      return;
    }
    if (!productVal || isNaN(qtyVal) || !zoneVal) { // Pas besoin de valider soldVal et promoVal car ils sont 0
      alert("Veuillez remplir tous les champs obligatoires (Nom Bo√Æte, Nb Bo√Ætes, Zone).");
      return;
    }

    const soldVal = 0; // Valeur par d√©faut
    const promoVal = 0; // Valeur par d√©faut
    const now = new Date();
    const ajoutVal = now.toLocaleString('fr-FR'); // Date d'ajout au format local

    const values = [[
      operatorName,     // Colonne A (invisible dans le tableau)
      dateVal,          // Colonne B (Date de p√©remption)
      productVal,       // Colonne C (Nom du produit)
      codeVal,          // Colonne D (Code produit)
      qtyVal,           // Colonne E (Quantit√©)
      zoneVal,          // Colonne F (Zone)
      soldVal,          // Colonne G (Vendues)
      promoVal,         // Colonne H (Promo)
      ajoutVal          // Colonne I (Date d'ajout, uniquement dans Google Sheet)
    ]];

    try {
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: 'USER_ENTERED',
        resource: { values }
      });

      loadSheet(); // Recharge le tableau principal
      setStatus('Ligne ajout√©e avec succ√®s !');
      // R√©initialise les champs du formulaire apr√®s ajout
      document.getElementById('date').value = '';
      document.getElementById('product').value = '';
      document.getElementById('code').value = '';
      document.getElementById('qty').value = '';
      document.getElementById('zone').value = '';
      // Assurez-vous que les champs 'sold' et 'promo' ne sont pas remis √† z√©ro s'ils n'existent pas dans le formulaire
      const soldInput = document.getElementById('sold');
      if(soldInput) soldInput.value = '';
      const promoInput = document.getElementById('promo');
      if(promoInput) promoInput.value = '';

      const dateInput = document.getElementById('date');
      dateInput.value = '';
      dateInput.dataset.raw = '';
      dateInput.blur();
      setTimeout(() => { dateInput.value = ''; dateInput.removeAttribute('value'); dateInput.dataset.raw = ''; }, 200);
      dateInput.focus();

    } catch (e) {
      setStatus('Erreur : ' + e.message);
    }
  };

  // Charge les donn√©es de la feuille principale et rend le tableau
  async function loadSheet() {
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: RANGE });
      const rows = res.result.values || [];
      renderTable(rows);
    } catch (e) {
      setStatus("Erreur de chargement : " + e.message);
    }
  }

  // Vide le tableau principal
  function clearTable() {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
  }

  // Rend le tableau principal (exclut la colonne op√©rateur)
  function renderTable(rows) {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
    rows.slice(1).reverse().forEach((row, i) => { // Inverse l'ordre pour afficher les derni√®res entr√©es en premier
      const tr = document.createElement('tr');
      const qte = parseInt(row[4] || '0');
      const vendu = parseInt(row[6] || '0');
      if (!isNaN(qte) && !isNaN(vendu) && qte === vendu) {
        tr.classList.add('ligne-vendue'); // Ajoute la classe si stock est z√©ro
      }

      // Indices des colonnes √† afficher (bas√©s sur votre Google Sheet)
      // Colonne B (index 1) = Date
      // Colonne C (index 2) = Produit
      // Colonne D (index 3) = Code
      // Colonne E (index 4) = Qt√©
      // Colonne F (index 5) = Zone
      // Colonne G (index 6) = Vendues
      // Colonne H (index 7) = Promo
      const colsToDisplay = [1, 2, 3, 4, 5, 6, 7];

      colsToDisplay.forEach(colIndex => {
        const td = document.createElement('td');
        td.textContent = row[colIndex] || '';
        td.contentEditable = true; // Rendre la cellule √©ditable
        const actualSheetRow = rows.length - i; // Calcul la ligne r√©elle dans Google Sheets
        td.dataset.row = actualSheetRow;
        td.dataset.col = colIndex + 1; // Col + 1 car les colonnes Sheets commencent √† 1
        td.addEventListener('blur', onCellEdit); // Met √† jour la feuille quand la cellule perd le focus
        tr.appendChild(td);
      });

      // Ajout de la colonne "Suppr" (ic√¥ne croix)
      const tdDelete = document.createElement('td');
      tdDelete.innerHTML = '<img src="https://i.imgur.com/oStNoqu.png" style="width:15%; height:5%; object-fit:cover;"/>';
      tdDelete.style.cursor = 'pointer';
      tdDelete.style.color = '#bbb';
      tdDelete.style.fontSize = '1.1em';
      tdDelete.title = 'Supprimer cette ligne';
      tdDelete.addEventListener('mouseenter', () => tdDelete.style.color = '#888');
      tdDelete.addEventListener('mouseleave', () => tdDelete.style.color = '#bbb');
      tdDelete.addEventListener('click', async () => {
        const confirmed = confirm("Supprimer cette ligne ?"); // Utilisation de confirm() pour la suppression
        if (confirmed) {
          const rowToDelete = rows.length - i; // Ligne r√©elle √† supprimer
          await deleteRow(rowToDelete);
        }
      });
      tr.appendChild(tdDelete);

      // Gestion de la s√©lection de ligne
      tr.addEventListener('click', () => {
        document.querySelectorAll('#data-table tbody tr').forEach(r => r.classList.remove('selected'));
        tr.classList.add('selected');
      });
      tbody.appendChild(tr);
    });
  }

  // Met √† jour une cellule dans Google Sheets
  async function onCellEdit(e) {
    if(!operatorName) return; // Ne permet pas la modification si non connect√©
    const td = e.target;
    const newValue = td.textContent.trim();
    const row = td.dataset.row;
    const col = td.dataset.col;

    try {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `Feuille1!${columnToLetter(col)}${row}`,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [[newValue]] }
      });
      setStatus(`Cellule mise √† jour (ligne ${row}, colonne ${col})`);
    } catch (err) {
      setStatus('Erreur mise √† jour : ' + err.message);
    }
  }

  // Convertit l'index de colonne num√©rique en lettre (1->A, 2->B...)
  function columnToLetter(column) {
    let temp, letter = '';
    while(column > 0) {
      temp = (column - 1) % 26;
      letter = String.fromCharCode(temp + 65) + letter;
      column = (column - temp - 1) / 26;
    }
    return letter;
  }

  // --- Fonctions pour la popup de notification "Suivi P√©rim√©s" ---

  // Gestion de l'affichage des onglets dans la popup de notification
  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none'); // Cache tous les contenus d'onglets
    document.getElementById(tabId).style.display = 'block'; // Affiche le contenu de l'onglet actif

    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); // Retire la classe active de tous les boutons
    document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active'); // Ajoute la classe active au bouton cliqu√©
  }

  // Charge et filtre les donn√©es pour la popup de notification
  async function loadNotifications() {
      const RANGE_A_ENLEVER = "Feuille2!A1:H1000"; // Plage pour les produits √† retirer
      // 'RANGE' est d√©j√† d√©fini globalement pour Feuille1

      const parseDate = (dateStr) => { // Fonction utilitaire pour parser les dates
          if (!dateStr) return null;
          let parts = dateStr.split('-');
          if (parts.length === 3) { return new Date(parts[0], parts[1] - 1, parts[2]); } // Format AAAA-MM-JJ
          parts = dateStr.split('/');
          if (parts.length === 3) { return new Date(parts[2], parts[1] - 1, parts[0]); } // Format JJ/MM/AAAA
          return null;
      };

      try {
          // --- Calcul de la date de r√©f√©rence d√©cal√©e au 15 du mois ---
          const now = new Date();
          let referenceDate = new Date(now.getFullYear(), now.getMonth(), 15);
          // Si nous sommes le 15 ou apr√®s, la date de r√©f√©rence passe au 15 du mois suivant
          if (now.getDate() >= 15) {
              referenceDate.setMonth(referenceDate.getMonth() + 1);
          }
          const currentMonthRef = referenceDate.getMonth();
          const currentYearRef = referenceDate.getFullYear();
          // --- Fin du calcul de la date de r√©f√©rence ---

          // R√©cup√©ration des donn√©es des deux feuilles Google Sheets
          const resFeuille1 = await gapi.client.sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: RANGE // Donn√©es principales (Feuille1)
          });
          const dataFeuille1 = (resFeuille1.result.values || []).slice(1); // Exclut l'en-t√™te

          const resFeuille2 = await gapi.client.sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: RANGE_A_ENLEVER // Donn√©es "√Ä retirer" (Feuille2)
          });
          const dataFeuille2 = (resFeuille2.result.values || []).slice(1); // Exclut l'en-t√™te

          let grouped = {
              'trimestre': {}, // Les produits du trimestre sont group√©s par mois (cl√©s "AAAA-MM")
              '2nd-month': [], // Liste simple pour les produits du 2√®me mois
              'current-month': [] // Liste simple pour les produits "√Ä retirer" (mois pr√©c√©dent)
          };

          // --- Logique de filtrage "√Ä retirer" (bas√©e sur Feuille2) ---
          // Il s'agit du mois PR√âC√âDENT la date de r√©f√©rence
          const prevMonthRef = (currentMonthRef - 1 + 12) % 12; // G√®re le passage de janvier √† d√©cembre
          const prevMonthYearRef = (currentMonthRef === 0) ? currentYearRef - 1 : currentYearRef;

          dataFeuille2.forEach(row => {
              const datePeremption = parseDate(row[1]); // La date de p√©remption est en colonne B (index 1) dans Feuille2
              if (datePeremption && !isNaN(datePeremption)) {
                  const rowMonth = datePeremption.getMonth();
                  const rowYear = datePeremption.getFullYear();

                  if (rowYear === prevMonthYearRef && rowMonth === prevMonthRef) {
                      grouped['current-month'].push(row);
                  }
              }
          });

          // --- Logique de filtrage "Trimestre" et "2√®me mois" (bas√©e sur Feuille1) ---
          // Ces calculs se font par rapport √† la 'referenceDate' (le 15 du mois)
          dataFeuille1.forEach(row => {
              const datePeremption = parseDate(row[1]); // La date de p√©remption est en colonne B (index 1) dans Feuille1
              if (datePeremption && !isNaN(datePeremption)) {
                  const rowMonth = datePeremption.getMonth();
                  const rowYear = datePeremption.getFullYear();
                  const ym = `${rowYear}-${String(rowMonth + 1).padStart(2, '0')}`; // Cl√© de groupement "AAAA-MM"

                  // Calcul de la diff√©rence en mois entre la date de p√©remption et la date de r√©f√©rence
                  const diffFromRef = (rowYear - currentYearRef) * 12 + (rowMonth - currentMonthRef);

                  // Pour le trimestre (inclut le mois de r√©f√©rence, le mois suivant, et le mois d'apr√®s)
                  if (diffFromRef >= 0 && diffFromRef <= 2) {
                      if (!grouped['trimestre'][ym]) {
                          grouped['trimestre'][ym] = [];
                      }
                      grouped['trimestre'][ym].push(row);
                  }

                  // Pour le "2√®me mois" (sp√©cifiquement le mois de r√©f√©rence + 1)
                  if (diffFromRef === 1) {
                      grouped['2nd-month'].push(row);
                  }
              }
          });

          // --- Fonctions utilitaires locales pour le rendu des tableaux de notification ---
          // Convertit "Date" en "Mois Ann√©e" (ex: "Mai 2025")
          const formatMonthYearLocal = (d) => {
              const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                              'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
              return months[d.getMonth()] + ' ' + d.getFullYear();
          };

          // G√©n√®re le HTML pour un tableau de produits
          const renderNotificationTableContent = (rowsToRender) => {
              if (rowsToRender.length === 0) {
                  return '<p>Aucun produit p√©rim√© pour ce mois.</p>';
              }
              // Trie les lignes par date de p√©remption
              rowsToRender.sort((a, b) => {
                  const dateA = parseDate(a[1]);
                  const dateB = parseDate(b[1]);
                  if (dateA && dateB) return dateA.getTime() - dateB.getTime();
                  return 0;
              });

              let tableHtml = `<table>
                  <thead>
                      <tr>
                          <th>Date</th><th>Nom</th><th>Code</th><th>Qt√©</th><th>Zone</th><th>Vendues</th><th>Promo</th>
                      </tr>
                  </thead>
                  <tbody>`;

              rowsToRender.forEach(row => {
                  const qte = parseInt(row[4] || '0'); // Quantit√© en stock
                  const vendu = parseInt(row[6] || '0'); // Quantit√© vendue
                  const isSoldOut = !isNaN(qte) && !isNaN(vendu) && qte === vendu; // V√©rifie si le stock est √† z√©ro
                  tableHtml += `<tr class="${isSoldOut ? 'ligne-vendue' : ''}">`;
                  // Colonnes affich√©es dans la popup: Date(1), Nom(2), Code(3), Qt√©(4), Zone(5), Vendues(6), Promo(7)
                  [1, 2, 3, 4, 5, 6, 7].forEach(colIndex => {
                      tableHtml += `<td>${row[colIndex] || ''}</td>`;
                  });
                  tableHtml += '</tr>';
              });
              tableHtml += '</tbody></table>';
              return tableHtml;
          };
          // --- Fin des fonctions utilitaires locales ---


          // --- Rendu final des contenus dans les divs des onglets ---

          // Rendu pour l'onglet "√Ä retirer" (le mois PR√âC√âDENT la date de r√©f√©rence)
          const prevMonthDateForTitle = new Date(referenceDate.getFullYear(), referenceDate.getMonth() - 1, 1);
          const prevMonthTitle = formatMonthYearLocal(prevMonthDateForTitle);
          document.getElementById('current-month').innerHTML = `<h3>${prevMonthTitle}</h3>` + renderNotificationTableContent(grouped['current-month']);

          // Rendu pour l'onglet "2√®me mois" (le mois de r√©f√©rence + 1)
          const monthPlus1Date = new Date(referenceDate.getFullYear(), referenceDate.getMonth() + 1, 1);
          const monthPlus1Title = formatMonthYearLocal(monthPlus1Date);
          document.getElementById('2nd-month').innerHTML = `<h3>${monthPlus1Title} <span style="font-style: italic; font-weight: normal;">- En promotion</span></h3>` + renderNotificationTableContent(grouped['2nd-month']);

          // Rendu pour l'onglet "Trimestre" (group√© par mois)
          let trimestreHtml = '';
          const sortedTrimestreMonths = Object.keys(grouped['trimestre']).sort(); // Trie les mois du trimestre
          
          if (sortedTrimestreMonths.length === 0) {
              trimestreHtml = '<p>Aucun produit p√©rim√© pour le trimestre.</p>';
          } else {
              sortedTrimestreMonths.forEach(ym => {
                  const [y, m] = ym.split('-');
                  const d = new Date(y, m - 1, 1);
                  let titleSuffix = '';
                  // Calcul de la diff√©rence en mois par rapport √† la date de r√©f√©rence pour chaque mois du trimestre
                  const monthDiff = (d.getFullYear() - currentYearRef) * 12 + (d.getMonth() - currentMonthRef);

                  if (monthDiff === 0) { // C'est le 1er mois du trimestre (mois de r√©f√©rence)
                      titleSuffix = ' <span style="font-style: italic; font-weight: normal;">- En promotion</span>';
                  } else if (monthDiff === 1) { // C'est le 2√®me mois du trimestre
                      titleSuffix = ' <span style="font-style: italic; font-weight: normal;">- En promotion</span>';
                  } else if (monthDiff === 2) { // C'est le 3√®me mois du trimestre
                      titleSuffix = ' <span style="font-style: italic; font-weight: normal;">- Mettre en avant dans les rayons</span>';
                  }
                  trimestreHtml += `<h3>${formatMonthYearLocal(d)}${titleSuffix}</h3>`;
                  trimestreHtml += renderNotificationTableContent(grouped['trimestre'][ym]);
              });
          }
          document.getElementById('trimestre').innerHTML = trimestreHtml;

          // Afficher la popup et l'onglet par d√©faut (trimestre)
          document.getElementById("notification-popup").style.display = "flex"; // S'assure que la popup est visible
          showTab('trimestre'); // Active l'onglet "Trimestre" par d√©faut

      } catch (e) {
          console.error("Erreur lors du chargement des notifications:", e);
          const notifContent = document.getElementById('notification-popup').querySelector('.content');
          notifContent.innerHTML = `<p>Erreur chargement notifications : ${e.message}</p>`;
      }
  }

  // --- √âcouteurs d'√©v√©nements pour les boutons de notification ---
  document.getElementById('btn-notif').addEventListener('click', () => {
    if(!operatorName) { // V√©rifie si l'op√©rateur est connect√© avant d'ouvrir
      alert("Connectez-vous et choisissez un op√©rateur pour voir les notifications.");
      return;
    }
    loadNotifications(); // Appelle la fonction loadNotifications qui charge et affiche
    // Le badge sera masqu√© une fois la popup ouverte (logique d√©j√† existante)
    const badge = document.getElementById('notif-badge');
    const now = new Date();
    const monthKey = `${now.getFullYear()}-${now.getMonth()+1}`;
    badge.style.display = 'none';
    localStorage.setItem('notifSeen', monthKey);
  });
  
  document.getElementById("close-notif").addEventListener("click", () => {
    document.getElementById("notification-popup").style.display = "none";
  });
  document.getElementById('print-notif').onclick = () => {
    window.print(); // Fonction d'impression
  };

  // --- Fonctions de filtrage du tableau principal ---
  function filterTable() {
    const zoneFilter = document.getElementById("filter-zone").value.trim().toLowerCase();
    const monthFilter = document.getElementById("filter-month").value.trim();
    const nameCodeFilter = document.getElementById("filter-name-code").value.trim().toLowerCase(); 
    const rows = document.querySelectorAll("#data-table tbody tr");

    rows.forEach((row) => {
      const dateCell = row.cells[0].textContent.trim(); 
      const productCell = row.cells[1].textContent.trim().toLowerCase();
      const codeCell = row.cells[2].textContent.trim().toLowerCase();
      const zoneCell = row.cells[5].textContent.trim().toLowerCase(); // Zone est maintenant √† l'index 5 (colonne F)
      let show = true;

      // Filtre par zone
      if (zoneFilter && !zoneCell.includes(zoneFilter)) {
        show = false;
      }

      // Filtre par nom ou code
      if (nameCodeFilter && !productCell.includes(nameCodeFilter) && !codeCell.includes(nameCodeFilter)) {
        show = false;
      }

      // Filtre par mois MM/YYYY ou YYYY
      if (monthFilter) {
        let rowYear = '';
        let rowMonth = '';

        // Assurez-vous que la date est au bon format (YYYY-MM-DD)
        if (dateCell.includes('-')) {
          const [yyyy, mm] = dateCell.split('-');
          rowYear = yyyy;
          rowMonth = mm;
        }

        let mFilter = null;
        let yFilter = null;

        if (/^\d{2}\/\d{4}$/.test(monthFilter)) { // Format MM/YYYY
          [mFilter, yFilter] = monthFilter.split('/');
        } else if (/^\d{6}$/.test(monthFilter)) { // Format MMYYYY
          mFilter = monthFilter.slice(0, 2);
          yFilter = monthFilter.slice(2);
        } else if (/^\d{4}$/.test(monthFilter)) { // Format YYYY
          yFilter = monthFilter;
        }

        if (yFilter && rowYear !== yFilter) show = false;
        if (mFilter && String(parseInt(rowMonth, 10)).padStart(2, '0') !== mFilter) show = false; // Compare les mois format√©s
      }
      row.style.display = show ? "" : "none";
    });
  }

  function clearFilter() {
    document.getElementById('filter-zone').value = '';
    document.getElementById('filter-month').value = '';
    document.getElementById('filter-name-code').value = ''; 
    filterTable(); // Applique les filtres apr√®s effacement
  }

  // --- Logic pour les champs de formulaire et les interactions ---
  document.addEventListener('DOMContentLoaded', () => {
    // Logique du badge de notification
    const badge = document.getElementById('notif-badge');
    const btnNotif = document.getElementById('btn-notif');
    const now = new Date();
    const monthKey = `${now.getFullYear()}-${now.getMonth()+1}`;
    // Affiche le badge si on est apr√®s le 15 du mois et que la notif n'a pas √©t√© vue
    if (now.getDate() >= 15 && localStorage.getItem('notifSeen') !== monthKey) {
      badge.style.display = 'inline-block';
    }
    // Masque le badge quand on clique sur "Suivi P√©rim√©s"
    btnNotif.addEventListener('click', () => {
      badge.style.display = 'none';
      localStorage.setItem('notifSeen', monthKey);
    });

    // Gestion du focus pour l'op√©rateur (touche Entr√©e)
    // Cette partie est maintenant d√©plac√©e vers les eventListeners du bouton de validation de l'op√©rateur
    // pour d√©clencher initiateGoogleAndOperatorLogin.

    // Gestion de la navigation avec Entr√©e dans le formulaire d'ajout
    const fields = [
      'date', 'product', 'code', 'qty', 'zone', 
    ];
    fields.forEach((id, index) => {
      const input = document.getElementById(id);
      if(input) { 
        input.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const nextField = document.getElementById(fields[index + 1]);
            if (nextField) {
              nextField.focus();
            } else {
              document.getElementById('btn-add').click(); 
            }
          }
        });
      }
    });

    // Formatage auto de la date (MM/YYYY)
    const dateInput = document.getElementById('date');
    if (dateInput) {
      dateInput.addEventListener('input', function(e) {
        let val = e.target.value.replace(/[^\d]/g, ''); 
        if (val.length > 2) {
          val = val.slice(0,2) + '/' + val.slice(2,6); 
        }
        e.target.value = val;
      });
      // Validation de la date au "blur" (quand le champ perd le focus)
      const dateErrorDiv = document.getElementById('date-error');
      dateInput.addEventListener('blur', () => {
        const val = dateInput.value.trim();
        const parts = val.split('/');
        if (parts.length !== 2) {
          dateErrorDiv.style.display = 'block'; return;
        }
        const [mm, yyyy] = parts;
        const parsedMonth = parseInt(mm, 10);
        const parsedYear = parseInt(yyyy, 10);
        if (isNaN(parsedMonth) || isNaN(parsedYear) || parsedMonth < 1 || parsedMonth > 12) {
          dateErrorDiv.style.display = 'block'; return;
        }
        const enteredDate = new Date(parsedYear, parsedMonth - 1, 1);
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        if (enteredDate < now) {
          dateErrorDiv.style.display = 'block';
        } else {
          dateErrorDiv.style.display = 'none';
        }
      });
    }

    // Logic for zone autocomplete suggestions
    const zones = [
      "aboca", "aderma", "arko", "aromat", "avene", "bain", "bande", "b√©b√©",
      "bien etre", "bioderma", "bi-oil", "bonbon", "brumes et senteurs", "cerave",
      "circulation", "clearskin", "collagene", "coloration", "confort", "conseil",
      "cooper geo", "cosmeto", "dentaire", "deo", "dermato", "dexeryl", "dietetique",
      "douleurs", "durex", "enfants", "forme", "frigo", "homeo", "hydratis", "intime",
      "la roche posay","LRP", "la rosee", "levres et mains", "moustik",
      "noreva", "nutergia", "nuxe", "ongles", "oreille", "pieds et mains", "pileje",
      "poux", "ronflement", "cheveux", "corps", "STUP", "svr", "tisanes", "uriage",
      "nature", "vichy", "yeux", "1ersoins", "4patte"
    ];
    const inputZone = document.getElementById('zone');
    const listZoneSuggestions = document.getElementById('zone-suggestions');

    if(inputZone && listZoneSuggestions) { // V√©rifie si les √©l√©ments existent
      inputZone.addEventListener('input', function () {
        const val = this.value.toLowerCase();
        listZoneSuggestions.innerHTML = '';
        if (val.length < 1) { // Affiche les suggestions d√®s la premi√®re lettre
          listZoneSuggestions.style.display = 'none';
          return;
        }
        const matches = zones.filter(z => z.toLowerCase().includes(val));
        if (matches.length === 0) {
          listZoneSuggestions.style.display = 'none';
          return;
        }
        matches.forEach((zone) => {
          const li = document.createElement('li');
          li.textContent = zone;
          li.addEventListener('click', () => {
            inputZone.value = zone;
            listZoneSuggestions.innerHTML = '';
            listZoneSuggestions.style.display = 'none';
          });
          listZoneSuggestions.appendChild(li);
        });
        const rect = inputZone.getBoundingClientRect();
        listZoneSuggestions.style.top = rect.bottom + window.scrollY + 'px';
        listZoneSuggestions.style.left = rect.left + window.scrollX + 'px';
        listZoneSuggestions.style.width = inputZone.offsetWidth + 'px';
        listZoneSuggestions.style.display = 'block';
      });

      document.addEventListener('click', function (e) {
        if (!inputZone.contains(e.target) && !listZoneSuggestions.contains(e.target)) {
          listZoneSuggestions.style.display = 'none';
        }
      });

      // Gestion de la navigation clavier pour les suggestions de zone
      let currentFocusZone = -1;
      inputZone.addEventListener('keydown', function (e) {
        const items = listZoneSuggestions.querySelectorAll("li");
        if (!items.length) return;

        if (e.key === "ArrowDown") {
          currentFocusZone++;
          if (currentFocusZone >= items.length) currentFocusZone = 0;
          updateActiveSuggestion(items, currentFocusZone);
        } else if (e.key === "ArrowUp") {
          currentFocusZone--;
          if (currentFocusZone < 0) currentFocusZone = items.length - 1;
          updateActiveSuggestion(items, currentFocusZone);
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (currentFocusZone > -1) {
            items[currentFocusZone].click();
          }
        }
      });

      function updateActiveSuggestion(items, focusIndex) {
        items.forEach(i => i.classList.remove("active"));
        if (items[focusIndex]) {
          items[focusIndex].classList.add("active");
          items[focusIndex].scrollIntoView({ block: "nearest" });
        }
      }
    }
  }); // Fin de DOMContentLoaded

  // --- Chargement initial des APIs Google ---
  window.onload = () => {
    gapiLoaded();
    gisLoaded();
  };
</script>
</body>
</html>

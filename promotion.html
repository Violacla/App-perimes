<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>Promotion - Pharmacie du Libron</title>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fffefc;
            margin: 0;
            color: #0a2f51; /* Couleur de texte principale */
        }
        header {
            background-color: #bcd7ed;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        #header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        h1 {
            margin: 0;
            color: #0a2f51;
            font-size: 1.3em;
        }
        button {
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1em;
            border: none;
            border-radius: 4px;
            background-color: #bcd7ed;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #a6c6e1;
        }
        table {
            width: 90%; /* Ajust√© pour une meilleure visibilit√© */
            max-width: 1200px; /* Largeur maximale pour les grands √©crans */
            border-collapse: collapse;
            background-color: white;
            margin: 20px auto; /* Centrage et marges */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px; /* Bords arrondis pour le tableau */
            overflow: hidden; /* Assure que les coins arrondis sont visibles */
        }
        th, td {
            border: 1px solid #e0e0e0; /* Bordures plus claires */
            padding: 10px 12px; /* Espacement interne */
            text-align: center;
        }
        th {
            background-color: #e6f0f7; /* Fond d'en-t√™te de tableau */
            font-weight: bold;
            color: #163f5b;
            position: sticky; /* En-t√™tes fixes au d√©filement */
            top: 0;
            z-index: 1; /* S'assure que les en-t√™tes restent au-dessus */
        }
        tbody tr:nth-child(odd) {
            background-color: #f9f9f9; /* Lignes impaires l√©g√®rement grises */
        }
        tbody tr:hover {
            background-color: #e0f2f7; /* Effet de survol sur les lignes */
        }
        #status {
            text-align: center;
            color: #0a2f51;
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
        }
        #login-block {
            display:flex;
            align-items:center;
            gap:10px;
        }
        #operator {
            padding:8px;
            border-radius:6px;
            border:1px solid #ccc;
        }
        #btn-validate {
            background-color: #0a2f51;
            color: #bcd7ed;
            font-weight: bold;
            padding: 12px 24px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        #btn-validate:hover {
            background-color: #083049;
            transform: translateY(-2px);
        }
        #login-error {
            color:red;
            margin:0;
            font-size: 0.9em;
        }
        /* Cache la colonne "Date ajout feuille 1" et "Is_Additional_Promo" */
        th:nth-child(9), /* Date ajout feuille 1 */
        td:nth-child(9),
        th:nth-child(12), /* Is_Additional_Promo */
        td:nth-child(12) {
            display: none;
        }
        
        /* Styles pour les titres de groupe dans les tableaux */
        .group-title-row td {
            background:#d3f0dd !important; /* Vert clair pour les titres de groupe */
            font-weight:bold;
            text-align:left;
            padding-left: 30px !important;
        }

        /* Styles pour la nouvelle table de promo suppl√©mentaire */
        #additional-promo-section {
            width: 90%;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f2f7f2; /* Vert tr√®s clair, presque blanc */
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        #additional-promo-section h2 {
            text-align: center;
            color: #0a2f51;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        /* Removed #add-additional-promo-form styles as the form is removed */

        #additional-promo-table {
            border: 2px solid #86bf8e; /* Bordure verte distinctive */
        }
        #additional-promo-table th {
            background-color: #bfdbc4; /* Fond vert pastel pour l'en-t√™te */
        }
        #additional-promo-table tbody tr:nth-child(odd) {
            background-color: #e8f5e9; /* Fond vert tr√®s clair pour les lignes impaires */
        }
        #additional-promo-table tbody tr:hover {
            background-color: #d1eccf; /* Effet de survol vert clair */
        }
    </style>
</head>
<body>
<header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #bcd7ed; box-shadow: 0 2px 5px rgba(0,0,0,0.15);">
    <div id="header-left" style="display: flex; align-items: center; gap: 15px;">
        <a href="/index.html" title="Accueil" style="display:inline-block; width:40px; height:40px; border-radius:50%; overflow:hidden; margin-right:10px;">
            <img alt="Logo" src="https://i.imgur.com/AExTPc7.png" style="width:100%; height:100%; object-fit:cover;"/>
        </a>
        <h1 style="margin: 0; color: #0a2f51;">Gestion Promotions - Pharmacie du Libron</h1>
    </div>
    <div id="login-block" style="display:flex; align-items:center; gap:10px;">
        <input type="number" id="operator" placeholder="Code op√©rateur" style="padding:8px; border-radius:6px; border:1px solid #ccc;">
        <button id="btn-validate">Valider</button>
        <p id="login-error" style="color:red; margin:0;"></p>
    </div>
    <div style="display: flex; gap: 10px;">
        <button onclick="window.location.href='index.html'">
            <img alt="Accueil" src="https://i.imgur.com/T8E0o39.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Accueil
        </button>
        <button onclick="location.href='historique.html'" title="Historique">
            <img alt="Historique" src="https://i.imgur.com/BasLkpT.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Historique
        </button>
        <button onclick="window.print()">
            <img src="https://i.imgur.com/qY1buNb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Imprimer
        </button>
        <button id="btn-sync" style="background-color: #0a2f51; color: white;">Synchroniser</button>
        <button id="btn-logout" style="display:none;">
            <img alt="D√©connexion" src="https://i.imgur.com/OPA1EuF.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            D√©connexion
        </button>
    </div>
</header>

<table id="data-table">
    <thead>
    <tr>
        <th>Date</th>
        <th>Nom produit</th>
        <th>Code</th>
        <th>Prix unitaire</th>
        <th>Zone</th>
        <th>Qt√©</th>
        <th>% Promo</th> <!-- Rendu √©ditable -->
        <th>Prix finale</th>
        <th>Supprimer</th> <!-- Colonne de suppression pour les promos r√©guli√®res -->
    </tr>
    </thead>
    <tbody>
        <!-- Les promotions "Mois en cours" et "Mois suivant" seront ins√©r√©es ici -->
    </tbody>
</table>

<div id="additional-promo-section">
    <h2>üöÄ Liste suppl√©mentaire en promo</h2>
    <!-- The form to add additional promos is removed. Users will mark them directly in Google Sheet. -->
    <table id="additional-promo-table">
        <thead>
        <tr>
            <th>Date</th>
            <th>Nom produit</th>
            <th>Code</th>
            <th>Prix unitaire</th>
            <th>Zone</th>
            <th>Qt√©</th>
            <th>% Promo</th>
            <th>Prix final</th>
            <th>Supprimer</th>
        </tr>
        </thead>
        <tbody>
            <!-- Les promotions suppl√©mentaires seront ins√©r√©es ici -->
        </tbody>
    </table>
</div>

<pre id="status">Chargement...</pre>

<script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const SOURCE_RANGE = 'Feuille1!A:K'; // Source range for synchronization
    // TARGET_RANGE now includes column L (Is_Additional_Promo)
    const TARGET_RANGE = 'Feuille3!A:L'; 

    let tokenClient;
    let accessToken = null;
    let isGapiReady = false;
    let isGisReady = false;
    let operatorCode = null; // Stores the validated operator code

    // Initializes the Google Sheets API client
    function gapiLoaded() {
        gapi.load('client', async () => {
            await gapi.client.init({
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
            });
            isGapiReady = true;
            checkAndInitialize();
        });
    }

    // Initializes the Google Identity Services (GIS) client
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: "https://www.googleapis.com/auth/spreadsheets",
            callback: async (response) => {
                accessToken = response.access_token;
                gapi.client.setToken({ access_token: accessToken });
                document.getElementById('login-block').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'inline-block';
                document.getElementById('btn-sync').style.display = 'inline-block';
                await loadAllPromos(); // Loads all data after connection
                document.getElementById('status').textContent = `Connect√© avec code op√©rateur ${operatorCode}.`;
            }
        });
        isGisReady = true;
        checkAndInitialize();
    }

    // Checks if both APIs are loaded and initializes validation listeners
    function checkAndInitialize() {
        if (isGapiReady && isGisReady) {
            document.getElementById('btn-validate').onclick = validateOperator;
            document.getElementById('operator').addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    validateOperator();
                }
            });
            // Initial focus on operator input
            document.getElementById('operator').focus();
        }
    }

    // Validates the operator code and initiates Google login
    function validateOperator() {
        const op = parseInt(document.getElementById("operator").value);
        // Authorized operator codes: 1 (pharmacy) 6 (receiver) 7 (preparer)
        if ([1, 6, 7].includes(op)) {
            operatorCode = op; // Stores the validated operator code
            document.getElementById("login-error").textContent = "";
            tokenClient.requestAccessToken(); // Triggers the Google login popup
        } else {
            document.getElementById("login-error").textContent = "Acc√®s refus√©. Code op√©rateur non autoris√©.";
        }
    }

    // Logout function
    document.getElementById('btn-logout').onclick = () => {
        accessToken = null;
        operatorCode = null;
        document.getElementById('login-block').style.display = 'flex';
        document.getElementById('btn-logout').style.display = 'none';
        document.getElementById('btn-sync').style.display = 'none';
        document.getElementById('status').textContent = 'D√©connect√©.';
        document.querySelector('#data-table tbody').innerHTML = '';
        document.querySelector('#additional-promo-table tbody').innerHTML = ''; // Clears the new table as well
        document.getElementById('operator').value = '';
        document.getElementById('operator').focus(); // Returns focus to the operator field
    };

    // Synchronization function (Sheet1 to Sheet3 for auto promos)
    document.getElementById('btn-sync').onclick = async () => {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter d\'abord.';
            return;
        }
        document.getElementById('status').textContent = 'Synchronisation en cours...';
        await synchronizeSheets();
        await loadAllPromos();
        document.getElementById('status').textContent = 'Synchronisation termin√©e !';
    };
    
    // Synchronizes Sheet1 (source) to Sheet3 (promo target), preserving modified prices and additional promos
    async function synchronizeSheets() {
        try {
            const resSource = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: SOURCE_RANGE
            });
            const resTarget = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: TARGET_RANGE
            });
            const sourceRows = resSource.result.values || [];
            const targetRows = resTarget.result.values || [];

            if (sourceRows.length === 0) {
                document.getElementById('status').textContent = 'Feuille1 est vide. Aucune donn√©e √† synchroniser.';
                return;
            }

            // Filters products from Sheet1 that have a promo percentage (>0)
            const promoRowsFromSource = sourceRows.slice(1).filter(row => parseFloat(row[7]) > 0); // row[7] is the '%'

            // Creates a map of existing promos in Sheet3 by product code to facilitate updates
            // Distinguishes by code and promo type (regular vs additional)
            const existingRegularPromos = new Map();
            const existingAdditionalPromos = []; // To store additional promos that are not synchronized
            if (targetRows.length > 1) {
                targetRows.slice(1).forEach(row => {
                    // Check if row has enough columns before accessing index 11
                    const isAdditional = (row.length > 11 && row[11] === 'TRUE'); 
                    const code = row[3]; // Code is in column D (index 3)
                    if (code) {
                        if (!isAdditional) {
                            existingRegularPromos.set(code, row);
                        } else {
                            existingAdditionalPromos.push(row);
                        }
                    }
                });
            }

            const newTargetRows = [];
            const sourceHeader = sourceRows[0] || [];
            // Ensures that Sheet3's header is correct, including column K "Prix_modifi√©" and L "Is_Additional_Promo"
            const targetHeader = targetRows[0] && targetRows[0].length >= 12 ? targetRows[0] : [...sourceHeader.slice(0, 10), 'Prix_modifi√©', 'Is_Additional_Promo'];
            newTargetRows.push(targetHeader);

            // 1. Handles regular promotions (from Sheet1)
            promoRowsFromSource.forEach(sourceRow => {
                const code = sourceRow[3];
                const existingRow = existingRegularPromos.get(code);

                const datePeremption = new Date(sourceRow[1]); // Column B: Expiry Date
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const diff = (datePeremption.getFullYear() - currentYear) * 12 + (datePeremption.getMonth() - currentMonth);

                let defaultPercentage = 0;
                if (diff === 0) { // Current month
                    defaultPercentage = 50;
                } else if (diff === 1) { // Next month
                    defaultPercentage = 30;
                }

                if (existingRow) {
                    const updatedRow = [...existingRow]; // Creates a copy of the existing row from Sheet3
                    
                    // Updates row data from Sheet1
                    // Except columns K "Prix_modifi√©" and L "Is_Additional_Promo", as they must be preserved
                    for (let i = 0; i < 11; i++) { // Iterates through columns A to K (index 0 to 10)
                        if (i !== 10) { // Index 10 is the modified price column (K)
                             updatedRow[i] = sourceRow[i]; // Copies the value from Sheet1
                        }
                    }
                    // Column L is implicitly handled by the fact that these are regular promos
                    updatedRow[11] = 'FALSE'; // Ensures this row is marked as not additional

                    // If the percentage in Sheet3 (column H) is empty or 0, apply the default based on month.
                    // Otherwise, preserve the existing percentage.
                    if (!updatedRow[7] || parseFloat(updatedRow[7]) === 0) {
                        updatedRow[7] = defaultPercentage; // Set default percentage based on month
                    }

                    // If modified price in Sheet3 (column K) is empty, use unit price from Sheet1 (column J)
                    // Otherwise, preserve existing modified price in Sheet3
                    if (!updatedRow[10] || updatedRow[10].trim() === '') {
                        updatedRow[10] = sourceRow[9]; // sourceRow[9] is the base unit price from Sheet1 (column J)
                    }

                    newTargetRows.push(updatedRow);
                } else {
                    // If the product does not exist in Sheet3, adds it.
                    // Ensures the new row has 12 columns (A-L)
                    const newRow = [...sourceRow];
                    while(newRow.length < 12) newRow.push(''); // Fills with empty strings if needed
                    newRow[10] = newRow[9]; // Initializes Prix_modifi√© with Unit price from Feuille1 (col J)
                    newRow[11] = 'FALSE'; // Marks as regular promotion

                    // Set default percentage for new regular promos
                    if (!newRow[7] || parseFloat(newRow[7]) === 0) {
                        newRow[7] = defaultPercentage;
                    }
                    newTargetRows.push(newRow);
                }
            });

            // 2. Re-add existing additional promotions
            existingAdditionalPromos.forEach(row => {
                // Ensures these rows are well preserved with their edited values
                newTargetRows.push(row);
            });

            // Sends updated data to Sheet3
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Feuille3!A1', // Starts updating from A1
                valueInputOption: 'RAW',
                resource: { values: newTargetRows }
            });
            
            console.log("Feuille3 synchronis√©e. Les prix modifi√©s et les promos suppl√©mentaires ont √©t√© conserv√©s.");
        } catch (error) {
            console.error("Erreur de synchronisation:", error);
            document.getElementById('status').textContent = `Erreur lors de la synchronisation: ${error.message}`;
        }
    }

    // Loads all data from the promotion sheet (Sheet3)
    async function loadAllPromos() {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter d\'abord.';
            return;
        }
        try {
            document.getElementById('status').textContent = 'Chargement des promotions...';

            const resFeuille3 = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: TARGET_RANGE // Sheet3
            });
            const allPromoRows = resFeuille3.result.values || [];
            await cleanOldEntries(allPromoRows); // Cleans old entries from Sheet3 (only regular ones)

            renderAllPromos(allPromoRows); // Renders both tables
            document.getElementById('status').textContent = 'Promotions loaded.';
        } catch (e) {
            document.getElementById('status').textContent = `Erreur de chargement: ${e.message}`;
            console.error("Erreur de chargement des feuilles:", e);
        }
    }

    // Renders both promotion tables (Current/Next Month and Additional)
    function renderAllPromos(allPromoRows) {
        const tbodyMain = document.querySelector("#data-table tbody");
        const tbodyAdditional = document.querySelector("#additional-promo-table tbody");
        tbodyMain.innerHTML = "";
        tbodyAdditional.innerHTML = "";
        
        let moisEnCours = [];
        let moisSuivant = [];
        let facingCount = 0; // Counter for 3rd month products to highlight
        let additionalPromos = [];

        // Skip header row
        const dataRows = allPromoRows.slice(1);

        dataRows.forEach((row, index) => {
            // Ensure row has enough columns (at least 12 for Is_Additional_Promo)
            if (row.length < 12) { 
                // Pad row with empty strings if it's too short for 'Is_Additional_Promo' column
                while(row.length < 12) row.push('');
            }

            const isAdditional = (row[11] === 'TRUE'); // Column L (index 11) for Is_Additional_Promo
            
            // Calculate originalRowIndex for saving changes back to the sheet
            // +2 because of header row in Sheet and 0-based index vs 1-based row number
            const originalRowIndex = index + 2; 

            const produit = row[2] || ''; // Column C
            const code = row[3] || ''; // Column D
            const zone = row[5] || ''; // Column F
            const qty = row[4] || ''; // Column E (Quantity)
            let percentageFromSheet = parseFloat((row[7] || "0").replace(/[^\d.,]/g, '').replace(',', '.')) || 0; // Column H (% Promo) - Now editable
            const prixUnitaire = parseFloat((row[10] || "").replace(/[^\d.,]/g, '').replace(',', '.')) || parseFloat((row[9] || "0").replace(/[^\d.,]/g, '').replace(',', '.')) || 0; // Column K (Prix_modifi√©) or J (Prix unitaire Feuille1)


            let percentageToDisplay = percentageFromSheet; // Use the percentage from sheet by default

            // Calculate final price based on the actual percentage from the sheet
            let prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);

            if (!isAdditional) {
                // Logic for Regular Promotions (Current Month / Next Month)
                const dateStr = row[1]; // Column B: Expiry Date
                const date = new Date(dateStr);
                
                if (!isNaN(date.getTime())) { // Ensure date is valid
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    const diff = (date.getFullYear() - currentYear) * 12 + (date.getMonth() - currentMonth);
                    
                    if (diff === 0) { // Current month
                        if (percentageFromSheet === 0 || isNaN(percentageFromSheet)) { // Check original sheet value
                            percentageToDisplay = 50; // Default to 50% for display if 0 or empty
                        }
                        prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);
                        moisEnCours.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                    } else if (diff === 1) { // Next month
                        if (percentageFromSheet === 0 || isNaN(percentageFromSheet)) { // Check original sheet value
                            percentageToDisplay = 30; // Default to 30% for display if 0 or empty
                        }
                        prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);
                        moisSuivant.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                    } else if (diff === 2) { // 3rd month (Facing)
                        facingCount++;
                    }
                }
            } else {
                // Logic for Additional Promotions
                const dateStr = row[1] || ''; // Date can be empty for these, but present in row[1]
                // For additional promos, percentage is already from row[7] (H) with default 50
                // So no need to adjust percentageToDisplay here for display, it comes directly from the sheet
                additionalPromos.push({
                    dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated,
                    originalRowIndex // row index in Sheet3
                });
            }
        });
        
        // Sort current and next month promos
        moisEnCours.sort((a, b) => new Date(a.dateStr) - new Date(b.dateStr));
        moisSuivant.sort((a, b) => new Date(a.dateStr) - new Date(b.dateStr));

        // Sort additional promos by product name
        additionalPromos.sort((a, b) => a.produit.localeCompare(b.produit));


        // Function to add a group of rows to the main table
        function appendGroup(targetTbody, title, group, isThirdMonthFacing = false) {
            if (group.length === 0 && !isThirdMonthFacing) return;

            const trTitle = document.createElement("tr");
            trTitle.classList.add('group-title-row'); // Adds a class for group titles
            const td = document.createElement("td");
            td.colSpan = 9; // Adjusted for 9 columns
            td.textContent = title;
            trTitle.appendChild(td);
            targetTbody.appendChild(trTitle);

            group.forEach(item => {
                const tr = document.createElement("tr");
                const tdDate = document.createElement("td"); tdDate.textContent = item.dateStr;
                const tdProduit = document.createElement("td"); tdProduit.textContent = item.produit;
                const tdCode = document.createElement("td"); tdCode.textContent = item.code;
                const tdPrixUnit = document.createElement("td"); tdPrixUnit.textContent = item.prixUnitaire.toFixed(2); tdPrixUnit.contentEditable = true; // Unit price editable
                const tdZone = document.createElement("td"); tdZone.textContent = item.zone;
                const tdQty = document.createElement("td"); tdQty.textContent = item.qty; // Qty
                
                const tdPercentage = document.createElement("td"); // New editable percentage cell
                tdPercentage.textContent = item.percentage.toFixed(0) + "%"; 
                tdPercentage.contentEditable = true; 
                
                const tdPrixFinal = document.createElement("td"); tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";
                
                // Delete button for regular promos
                const tdDelete = document.createElement("td");
                tdDelete.innerHTML = '<img src="https://i.imgur.com/oStNoqu.png" style="width:20px; height:20px; cursor:pointer;" title="Supprimer cette ligne">';
                tdDelete.onclick = async () => {
                    const confirmDelete = confirm(`Voulez-vous vraiment supprimer "${item.produit}" ?`);
                    if (confirmDelete) {
                        await deleteRowFromSheet(TARGET_RANGE, item.originalRowIndex);
                    }
                };

                // Event listener for unit price modification (Column K / index 10 in Sheet3)
                tdPrixUnit.addEventListener("blur", async () => {
                    const cleaned = tdPrixUnit.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
                    const newPrix = parseFloat(cleaned) || 0;
                    
                    // Updates local object and displayed final price
                    item.prixUnitaire = newPrix;
                    item.prixFinal = newPrix * (1 - item.percentage / 100); // Uses current percentage
                    tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";

                    // Saves new value to Column K of Sheet3 (index 11 when using columnToLetter)
                    await saveCellToSheet(TARGET_RANGE, item.originalRowIndex, 11, newPrix);
                });

                // Event listener for percentage modification (Column H / index 7 in Sheet3)
                tdPercentage.addEventListener("blur", async () => {
                    const cleaned = tdPercentage.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
                    const newPct = parseFloat(cleaned) || 0;
                    
                    // Updates local object and displayed final price
                    item.percentage = newPct;
                    item.prixFinal = item.prixUnitaire * (1 - newPct / 100); // Uses current unit price
                    tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";
                    tdPercentage.textContent = newPct.toFixed(0) + "%"; // Updates displayed text

                    // Saves new value to Column H of Sheet3 (index 8 when using columnToLetter)
                    await saveCellToSheet(TARGET_RANGE, item.originalRowIndex, 8, newPct);
                });


                tr.appendChild(tdDate);
                tr.appendChild(tdProduit);
                tr.appendChild(tdCode);
                tr.appendChild(tdPrixUnit);
                tr.appendChild(tdZone);
                tr.appendChild(tdQty);
                tr.appendChild(tdPercentage); // Now editable
                tr.appendChild(tdPrixFinal);
                tr.appendChild(tdDelete); // Add delete button for regular promos too
                targetTbody.appendChild(tr);
            });

            if (isThirdMonthFacing && facingCount > 0) {
                const finalRow = document.createElement("tr");
                const tdFacing = document.createElement("td");
                tdFacing.colSpan = 9; // Adjusted for 9 columns
                tdFacing.style = "font-style: italic; text-align:left; padding-top:10px; background:#f0f8ff;";
                tdFacing.textContent = `Les ${facingCount} produits du 3·µâ mois doivent √™tre mis en avant dans les rayons. ‚ùó`;
                finalRow.appendChild(tdFacing);
                targetTbody.appendChild(finalRow);
            }
        }
        
        // Renders automatic promotions
        appendGroup(tbodyMain, `üì¶ Mois en cours (-50% par d√©faut) - ${new Date().toLocaleString('fr-FR', { month: 'long', year: 'numeric' })}`, moisEnCours);
        const nextMonthDate = new Date();
        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
        appendGroup(tbodyMain, `üì¶ Mois suivant (-30% par d√©faut) - ${nextMonthDate.toLocaleString('fr-FR', { month: 'long', year: 'numeric' })}`, moisSuivant);
        appendGroup(tbodyMain, "", [], true); // To display the 3rd month message if facingCount > 0


        // Renders "Liste suppl√©mentaire en promo"
        additionalPromos.forEach(item => {
            const tr = document.createElement("tr");
            const tdDate = document.createElement("td"); tdDate.textContent = item.dateStr;
            const tdProduit = document.createElement("td"); tdProduit.textContent = item.produit;
            const tdCode = document.createElement("td"); tdCode.textContent = item.code;
            const tdPrixUnit = document.createElement("td"); tdPrixUnit.textContent = item.prixUnitaire.toFixed(2); tdPrixUnit.contentEditable = true; // Unit price editable
            const tdZone = document.createElement("td"); tdZone.textContent = item.zone;
            const tdQty = document.createElement("td"); tdQty.textContent = item.qty;
            const tdPercentage = document.createElement("td"); tdPercentage.textContent = item.percentage.toFixed(0) + "%"; tdPercentage.contentEditable = true; // Percentage editable
            const tdPrixFinal = document.createElement("td"); tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨"; // Calculated final price

            // Delete button for the row
            const tdDelete = document.createElement("td");
            tdDelete.innerHTML = '<img src="https://i.imgur.com/oStNoqu.png" style="width:20px; height:20px; cursor:pointer;" title="Supprimer cette ligne">';
            tdDelete.onclick = async () => {
                const confirmDelete = confirm(`Voulez-vous vraiment supprimer "${item.produit}" de la liste suppl√©mentaire ?`);
                if (confirmDelete) {
                    await deleteRowFromSheet(TARGET_RANGE, item.originalRowIndex);
                }
            };
            
            // Event listener for unit price modification in Sheet3 (column K / index 10)
            tdPrixUnit.addEventListener("blur", async () => {
                const cleaned = tdPrixUnit.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
                const newPrix = parseFloat(cleaned) || 0;
                
                // Updates local object and displayed final price
                item.prixUnitaire = newPrix;
                item.prixFinal = newPrix * (1 - item.percentage / 100);
                tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";

                // Saves new value to Column K of Sheet3 (index 11 when using columnToLetter)
                await saveCellToSheet(TARGET_RANGE, item.originalRowIndex, 11, newPrix);
            });

            // Event listener for percentage modification in Sheet3 (column H / index 7)
            tdPercentage.addEventListener("blur", async () => {
                const cleaned = tdPercentage.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
                const newPct = parseFloat(cleaned) || 0;
                
                // Updates local object and displayed final price
                item.percentage = newPct;
                item.prixFinal = item.prixUnitaire * (1 - newPct / 100);
                tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";
                tdPercentage.textContent = newPct.toFixed(0) + "%"; // Updates displayed text

                // Saves new value to Column H of Sheet3 (index 8 when using columnToLetter)
                await saveCellToSheet(TARGET_RANGE, item.originalRowIndex, 8, newPct);
            });

            tr.appendChild(tdDate);
            tr.appendChild(tdProduit);
            tr.appendChild(tdCode);
            tr.appendChild(tdPrixUnit);
            tr.appendChild(tdZone);
            tr.appendChild(tdQty);
            tr.appendChild(tdPercentage);
            tr.appendChild(tdPrixFinal);
            tr.appendChild(tdDelete);
            tbodyAdditional.appendChild(tr);
        });

        document.getElementById("status").textContent = 'Donn√©es de promotions charg√©es et tri√©es.';
    }

    // Function to add a product to the additional list (Sheet3)
    // REMOVED: This function and its associated button are no longer needed
    // as users will directly mark rows in Google Sheet for additional promos.

    // Generic function to save a cell to any sheet
    async function saveCellToSheet(rangePrefix, rowIndex, colIndex, newValue) {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter pour sauvegarder.';
            return;
        }
        const sheetName = rangePrefix.split('!')[0]; // Extracts sheet name (e.g., "Feuille3")
        
        try {
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${sheetName}!${columnToLetter(colIndex)}${rowIndex}`,
                valueInputOption: 'RAW',
                resource: { values: [[newValue]] }
            });
            console.log(`Cellule mise √† jour dans ${sheetName} (ligne ${rowIndex}, colonne ${colIndex})`);
            document.getElementById('status').textContent = `Cellule mise √† jour dans ${sheetName}.`;
        } catch (error) {
            console.error(`Erreur lors de la mise √† jour de la cellule dans ${sheetName}:`, error);
            document.getElementById('status').textContent = `Erreur lors de la sauvegarde dans ${sheetName}.`;
        }
    }

    // Function to delete a row from the sheet (Sheet3)
    async function deleteRowFromSheet(rangePrefix, rowIndex) {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter pour supprimer.';
            return;
        }
        const sheetName = rangePrefix.split('!')[0];
        try {
            // Read all data first
            const res = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: sheetName // Get all data from the sheet
            });
            let rows = res.result.values || [];

            // Remove the row at the specified index (adjusting for header and 0-based array)
            // rowIndex from render function is 1-based (starts at 2 for data rows)
            // So, for 0-based array, it's rowIndex - 1
            if (rowIndex > 0 && rowIndex <= rows.length) {
                rows.splice(rowIndex - 1, 1); // Remove 1 row at (rowIndex - 1)
            } else {
                console.error("Invalid row index for deletion:", rowIndex);
                document.getElementById('status').textContent = "Erreur: Index de ligne invalide pour la suppression.";
                return;
            }

            // Write the modified data back to the sheet
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${sheetName}!A1`, // Start writing from A1
                valueInputOption: 'RAW',
                resource: { values: rows }
            });
            document.getElementById('status').textContent = `Ligne supprim√©e de ${sheetName}.`;
            await loadAllPromos(); // Reload to reflect changes
        } catch (error) {
            console.error(`Erreur lors de la suppression de la ligne dans ${sheetName}:`, error);
            document.getElementById('status').textContent = `Erreur lors de la suppression: ${error.message}`;
        }
    }


    // Converts numeric column index to letter (1->A, 2->B...)
    function columnToLetter(column) {
        let temp, letter = '';
        while(column > 0) {
            temp = (column - 1) % 26;
            letter = String.fromCharCode(temp + 65) + letter;
            column = (column - temp - 1) / 26;
        }
        return letter;
    }

    // Cleans old entries (only applies to regular promos in Sheet3)
    async function cleanOldEntries(allRows) {
        const now = new Date();
        const header = allRows[0];
        
        // Filter rows to keep:
        // 1. The header row
        // 2. Rows that are NOT additional promos (row[11] is not 'TRUE') AND have a future or current date
        // 3. Rows that ARE additional promos (row[11] is 'TRUE') regardless of date (as they are manually managed)
        const filteredRows = allRows.filter((row, i) => {
            if (i === 0) return true; // Always keep the header row
            if (row.length < 12) { // If row is too short, treat as regular promo for cleaning purposes
                const datePeremption = new Date(row[1]); // Date is in column B (index 1)
                return !isNaN(datePeremption.getTime()) && datePeremption >= now;
            }
            const isAdditional = (row[11] === 'TRUE');
            if (isAdditional) {
                return true; // Keep additional promos regardless of date
            } else {
                const datePeremption = new Date(row[1]); // Date is in column B (index 1)
                return !isNaN(datePeremption.getTime()) && datePeremption >= now;
            }
        });

        // If rows were removed, update the sheet.
        if (filteredRows.length !== allRows.length) {
            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: TARGET_RANGE, // Update all of Sheet3
                    valueInputOption: 'RAW',
                    resource: { values: filteredRows }
                });
                console.log("Nettoyage automatique effectu√© (Feuille3) pour les promos r√©guli√®res.");
            } catch (error) {
                console.error("Erreur lors du nettoyage de Feuille3 :", error);
                document.getElementById('status').textContent = `Erreur lors du nettoyage automatique: ${error.message}`;
            }
        } else {
             console.log("Aucune ancienne entr√©e de promotion r√©guli√®re √† nettoyer dans Feuille3.");
        }
    }

    // Initial loading of Google APIs
    window.onload = () => {
        gapiLoaded();
        gisLoaded();
    };
</script>
<footer style="
    position: fixed;
    bottom: 0;
    width: 100%;
    text-align: center;
    font-size: 0.6em;
    color: #666;
    background: #bfdbc4;
    padding: 8px 0;
    box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
    z-index: 10;
">
    D√©velopp√© par Violaine Claron - Mise √† jour
</footer>
</body>
</html>

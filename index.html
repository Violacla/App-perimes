<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suivi App Périmés - Google Sheets</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h2>Connexion Google Sheets API + Opérateur</h2>

  <button id="btn-login" style="display:none;">Se connecter</button>
  <button id="btn-logout" style="display:none;">Déconnexion</button>
  <button id="btn-append" style="display:none;">Ajouter une ligne</button>

  <div id="operator-form" style="display:none; margin-top: 20px;">
    <label for="operator">Sélectionnez votre nom :</label>
    <select id="operator">
      <option value="">-- Choisir --</option>
      <option value="Op1">Op1</option>
      <option value="Op2">Op2</option>
      <option value="Op3">Op3</option>
      <option value="Op3">Op4</option>
      <option value="Op3">Op5</option>
      <option value="Op3">Op6</option>
      <option value="Op3">Op7</option>
      <option value="Op3">Op8</option>
      <option value="Op3">Op9</option>
    </select>
    <button id="btn-confirm-operator">Valider</button>
  </div>

  <pre id="status"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1!';
    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const btnAppend = document.getElementById('btn-append');
    const status = document.getElementById('status');
    const operatorForm = document.getElementById('operator-form');
    const operatorSelect = document.getElementById('operator');
    const btnConfirmOperator = document.getElementById('btn-confirm-operator');

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let accessToken = null;
    let operatorName = null;

    // 1. Charger client Google
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: DISCOVERY_DOCS,
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // 2. Charger Google Identity Services
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            status.textContent = 'Erreur auth : ' + tokenResponse.error;
            return;
          }
          accessToken = tokenResponse.access_token;
          status.textContent = 'Connecté. Veuillez choisir votre nom.';
          operatorForm.style.display = 'block';
          btnLogin.style.display = 'none';
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        btnLogin.style.display = 'inline-block';
      }
    }

    btnLogin.onclick = () => {
      tokenClient.requestAccessToken();
    };

    btnLogout.onclick = () => {
      accessToken = null;
      operatorName = null;
      btnLogin.style.display = 'inline-block';
      btnLogout.style.display = 'none';
      btnAppend.style.display = 'none';
      operatorForm.style.display = 'none';
      status.textContent = 'Déconnecté.';
    };

    btnConfirmOperator.onclick = () => {
      const selected = operatorSelect.value;
      if (!selected) {
        alert("Merci de sélectionner un nom.");
        return;
      }
      operatorName = selected;
      operatorForm.style.display = 'none';
      btnAppend.style.display = 'inline-block';
      btnLogout.style.display = 'inline-block';
      status.textContent = 'Bienvenue ' + operatorName + '. Vous pouvez maintenant ajouter une ligne.';
    };

    btnAppend.onclick = async () => {
      if (!accessToken || !operatorName) {
        status.textContent = 'Veuillez vous connecter et valider un nom.';
        return;
      }

      try {
        const values = [[operatorName, "ProduitTest", new Date().toLocaleString()]];
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
          valueInputOption: 'USER_ENTERED',
          insertDataOption: 'INSERT_ROWS',
          resource: { values }
        });
        status.textContent = '✅ Ligne ajoutée !\n' + JSON.stringify(response.result.updates, null, 2);
      } catch (err) {
        status.textContent = 'Erreur : ' + (err.result?.error?.message || err.message);
      }
    };

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>

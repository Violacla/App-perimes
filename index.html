<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ajout Google Sheets (GIS)</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h2>Connexion et ajout à Google Sheets</h2>
  <div id="g_id_onload"
       data-client_id="777828681958-e93ppgnalai8espma506kml39n2lakd1.apps.googleusercontent.com"
       data-context="use"
       data-ux_mode="popup"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin" data-type="standard"></div>

  <button id="append_button" style="display:none;">Ajouter une ligne</button>
  <pre id="content" style="margin-top: 20px;"></pre>

  <script>
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Stock!A1:C1';
    const API_KEY = 'AIzaSyBHLlV9AXg7Wpyl3flKZ2PaRBCt9fCv0eg';
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    const content = document.getElementById('content');
    const appendButton = document.getElementById('append_button');

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: 'TON_CLIENT_ID.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: (tokenResponse) => {
          gapi.client.setToken(tokenResponse);
          appendButton.style.display = 'inline-block';
          content.textContent = '✅ Connecté. Prêt à ajouter une ligne.';
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        tokenClient.requestAccessToken();
      }
    }

    function handleCredentialResponse(response) {
      // Non utilisé ici car nous utilisons `tokenClient.requestAccessToken()`
    }

    appendButton.onclick = () => {
      const values = [
        ["Nom", "Prénom", new Date().toLocaleString()]
      ];
      const body = { values: values };

      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: "USER_ENTERED",
        resource: body
      }).then(response => {
        content.textContent = '✅ Ligne ajoutée :\n' + JSON.stringify(response.result.updates, null, 2);
      }).catch(error => {
        content.textContent = '❌ Erreur : ' + (error.result?.error?.message || error.message);
      });
    };

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Google Sheets API avec GIS (écriture)</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    button { margin: 5px; }
  </style>
</head>
<body>
  <h2>Connexion Google Sheets API - Écriture de données</h2>
  
  <button id="login_button">Connexion</button>
  <button id="logout_button" style="display:none;">Déconnexion</button>
  <button id="append_button" style="display:none;">Ajouter une ligne</button>
  
  <pre id="content" style="white-space: pre-wrap; margin-top: 20px;"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Stock!A1:C1'; // modifie selon ta feuille

    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    const loginButton = document.getElementById('login_button');
    const logoutButton = document.getElementById('logout_button');
    const appendButton = document.getElementById('append_button');
    const content = document.getElementById('content');

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let accessToken = null;

    // 1. Chargement et initialisation de la Google API client library
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: '', // Optionnel si pas besoin d'API Key
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // 2. Initialisation Google Identity Services
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // on définit après
      });
      gisInited = true;
      maybeEnableButtons();
    }

    // Activer boutons si init finies
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        loginButton.disabled = false;
      }
    }

    loginButton.onclick = () => {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          content.textContent = 'Erreur de connexion : ' + resp.error;
          return;
        }
        accessToken = resp.access_token;
        content.textContent = 'Connecté avec succès !\nToken : ' + accessToken;
        loginButton.style.display = 'none';
        logoutButton.style.display = 'inline-block';
        appendButton.style.display = 'inline-block';
      };

      if (!accessToken) {
        // Demande le token d'accès
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        // Renouvelle token sans prompt
        tokenClient.requestAccessToken({ prompt: '' });
      }
    };

    logoutButton.onclick = () => {
      accessToken = null;
      google.accounts.oauth2.revoke(accessToken);
      content.textContent = 'Déconnecté.';
      loginButton.style.display = 'inline-block';
      logoutButton.style.display = 'none';
      appendButton.style.display = 'none';
    };

    appendButton.onclick = async () => {
      if (!accessToken) {
        content.textContent = 'Vous devez être connecté.';
        return;
      }
      try {
        gapi.client.setToken({ access_token: accessToken });
        const values = [
          ["NomExemple", "PrenomExemple", new Date().toLocaleString()]
        ];
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
          valueInputOption: "USER_ENTERED",
          resource: { values }
        });
        content.textContent = 'Ligne ajoutée avec succès !\n' + JSON.stringify(response.result.updates, null, 2);
      } catch (err) {
        content.textContent = 'Erreur lors de l\'ajout : ' + err.message;
      }
    };

    // Chargement des librairies
    window.onload = () => {
      loginButton.disabled = true;
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>


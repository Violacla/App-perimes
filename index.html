<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Gestion Perim√© - Pharmacie du Libron</title>
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
<script src="https://apis.google.com/js/api.js"></script>
<style>
  /* Styles pour l'autocompl√©tion des listes */
  .autocomplete-list {
  position: absolute;
  background-color: white;
  border: 1px solid #ccc;
  border-radius: 4px;
  list-style: none;
  margin: 0;
  padding: 0;
  max-height: 150px;
  overflow-y: auto;
  width: 250px;
  z-index: 999;
}

.autocomplete-list li {
  padding: 8px 10px;
  cursor: pointer;
  color: black;
}

.autocomplete-list li:hover,
.autocomplete-list li.active {
 background-color: #86bf8e; /* Couleur de survol pour les suggestions */
  color: white;
}

  /* Variables de couleurs */
  :root {
    --bleu-glacial: #bcd7ed; /* Bleu clair */
  }

  /* Styles g√©n√©raux du corps de page */
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #fffefc; /* Fond blanc cass√© */
  }

  /* Styles de l'en-t√™te */
  header {
    background-color: var(--bleu-glacial);
    color: #163f5b; /* Couleur du texte de l'en-t√™te */
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  }

  #header-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  #header-left > h1 {
    margin: 0;
    font-size: 1.3em;
  }

  /* Styles des boutons g√©n√©raux de l'en-t√™te */
  button {
    cursor: pointer;
    border: none;
    background: transparent;
    font-size: 1em;
    color: black;
    padding: 6px 10px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: rgba(255 255 255 / 0.3); /* Effet de survol l√©ger */
  }

  /* Ic√¥nes utilis√©es */
  .icon {
    font-size: 1.2em;
    margin-right: 6px;
  }

  /* Boutons de droite de l'en-t√™te */
  #header-right {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  /* Formulaire d'op√©rateur */
  #operator-form {
    margin-left: 10px;
    display: inline-flex; /* Assure que les √©l√©ments sont sur la m√™me ligne */
    align-items: center; /* Aligne verticalement les √©l√©ments */
    gap: 10px; /* Espace entre les √©l√©ments du formulaire op√©rateur */
  }

  #operator-form input {
    padding: 8px;
    font-size: 1em;
    border-radius: 5px; /* Angles arrondis */
    border: 1px solid #0a2f51; /* Contour bleu fonc√© */
    box-sizing: border-box; /* Inclut le padding et le border dans la largeur */
  }

  #operator-form button {
    background-color: #0a2f51; /* Fond bleu fonc√© */
    color: white; /* Texte blanc */
    font-weight: bold; /* Texte en gras */
    padding: 8px 12px;
    border-radius: 5px; /* Angles arrondis */
    border: 1px solid #0a2f51; /* Contour bleu fonc√© */
    transition: background-color 0.3s ease;
  }
  #operator-form button:hover {
    background-color: #163f5b; /* Bleu fonc√© un peu plus clair au survol */
  }


  /* Layout principal de la page */
  main {
    display: flex;
    margin: 20px;
  }

  /* Formulaire pour ajouter des entr√©es (√† droite) */
 #entry-form {
  width: 320px;
  background: #f2f7f2; /* Couleur de fond vert tr√®s clair, presque blanc */
  padding: 15px 20px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  margin-left: 20px;
  margin-top: 3px; /* Alignement du haut avec les filtres */
  height: 485px; /* Hauteur fixe pour le bloc */
}

  #entry-form h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: normal;
  }
  #entry-form input {
    background-color: #e1f4e4; /* Fond vert tr√®s clair pour les champs */
    width: 100%;
    margin: 6px 0;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  #entry-form button {
    width: 100%;
    background-color: #bfdbc4; /* Vert pastel pour le bouton */
    color: black;
    font-weight: bold;
    margin-top: 10px;
  }
  #entry-form button:hover {
    background-color: #86bf8e; /* Vert plus fonc√© au survol */
  }

  /* Styles du tableau principal */
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    border-radius: 6px;
    overflow: hidden;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px 10px;
    text-align: center;
  }

  /* Couleur de fond altern√©e pour les lignes du tableau */
  tbody tr:nth-child(odd) {
    background-color: #ede2e6; /* Rose tr√®s clair */
  }

  /* Surlignage de la ligne s√©lectionn√©e */
  tbody tr.selected {
    background-color: #f2b4bb!important; /* Rose vif */
  }

  /* Cellules √©ditables */
  tbody td {
    cursor: text;
  }

  /* Section des filtres */
  #filters {
    background-color: #f2f7f2; /* Couleur de fond verte */
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end; /* ALIGN√â: Aligne les √©l√©ments en bas pour les boutons */
    margin-bottom: 20px;
  }
  /* Groupe de label + input pour les filtres */
  .filter-group {
    display: flex;
    flex-direction: column; /* Empile le label au-dessus de l'input */
    align-items: flex-start;
  }
  #filters label {
    font-weight: bold;
    color: #0a2f51; /* Couleur du texte des labels */
    margin-bottom: 5px; /* Espace sous le label */
    display: block;
  }
  #filters input, #filters select {
    padding: 8px;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #filters button {
    background-color: #bfdbc4; /* Vert pour les boutons de filtre */
    color: black;
    border: none;
    cursor: pointer;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 5px;
    margin-top: auto; /* Pousse les boutons vers le bas de leur conteneur flex */
  }
  #filters button:hover {
    background-color: #5d9e63; /* Vert plus fonc√© au survol */
    color: white;
  }
  /* Style du texte √† l'int√©rieur des champs de saisie (placeholder) */
  #filters input::placeholder {
    color: #87c08f; /* Vert pastel pour le placeholder */
    opacity: 1; /* S'assure que la couleur est bien visible */
  }

  /* Texte de statut */
  #status {
    margin: 10px 20px;
    font-weight: bold;
    color: #0a2f51;
  }

  /* Styles pour la popup de notification */
  #notification-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    width: 1300px;
    max-height: 92vh;
    overflow-y: auto;
    z-index: 9999;
    display: none; /* Masqu√© par d√©faut */
    flex-direction: column;
  }
  #notification-popup header {
    display: flex;
    justify-content: space-between;
    align-items: center; /* Alignement centr√© pour les √©l√©ments de l'en-t√™te de la popup */
    padding: 10px 20px;
    background-color: var(--bleu-glacial);
    color: #163f5b;
    border-radius: 10px 10px 0 0;
  }
  #notif-tabs {
    display: flex;
    gap: 10px;
    margin-left: auto; /* Aligne les onglets √† droite du titre */
  }
  .header-buttons {
    display: flex;
    gap: 10px;
  }
  .tab-button {
    background-color: transparent;
    color: #163f5b; /* Texte du bouton d'onglet par d√©faut */
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s, color 0.3s;
    border-radius: 5px 5px 0 0;
  }
  .tab-button:hover,
  .tab-button.active {
    background-color: #85b9dd; /* Fond bleu fonc√© au survol et pour l'onglet actif */
    color: white; /* Texte blanc au survol et pour l'onglet actif */
  }
  .tab-content {
    display: none; /* Contenu de l'onglet masqu√© par d√©faut */
    padding: 15px;
    overflow-y: auto;
    max-height: calc(92vh - 80px); /* Hauteur calcul√©e pour le contenu */
    color: black;
  }
  .tab-content h3 {
    text-align: left;
    color: black;
  }
  .tab-content.active {
    display: block;
  }
  .ligne-vendue td {
  text-decoration: line-through;
  background-color: #d8c0ca !important; /* Couleur de fond pour les lignes vendues */
  color: #efe8eb; /* Couleur du texte pour les lignes vendues */
}
  /* Styles pour l'impression (cache tout sauf la popup de notification) */
  @media print {
    body > :not(#notification-popup) {
      display: none;
    }
    #notification-popup {
      position: static !important;
      transform: none !important;
      top: auto !important;
      left: auto !important;
      width: 100% !important;
      height: auto !important;
      max-height: none !important;
      overflow: visible !important;
      margin: 0 !important;
      padding: 0 !important;
      border-radius: 0 !important;
      display: block !important;
    }
    #notification-popup .tab-content:not(.active) {
      display: none !important;
    }
    #notification-popup #notif-tabs,
    #notification-popup .header-buttons {
      display: none !important;
    }
    html, body {
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    #notification-popup .tab-content,
    #notification-popup .content {
      max-height: none !important;
      overflow: visible !important;
    }
  }
  /* Style pour les messages d'erreur de date */
  #date-error {
  display: none;
  background-color: white;
  color: #87c08f;
  padding: 10px;
  margin: 10px 0;
  border: 3px solid #87c08f;
  border-radius: 10px;
  font-weight: bold;
  text-align: center;
  font-size: 2.5em;
  max-width: 90%;
  margin: 0 auto 10px auto;
}
/* Overlay de mise √† jour au d√©marrage */
#update-overlay {
  position: fixed;
  top: 60px; /* Laisse le bandeau de l'en-t√™te visible */
  left: 0;
  width: 100%;
  height: calc(100% - 60px);
  background-color: rgba(188, 215, 237, 0.9); /* Bleu glacial transparent */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9998;
}

#update-popup {
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.25);
  max-width: 600px;
  text-align: center;
  font-size: 1.1em;
}

#update-popup h2 {
  margin-top: 0;
  color: #87c08f; /* Vert */
}

#update-popup ul {
  list-style: none;
  padding-left: 0;
  text-align: left;
  margin-bottom: 20px;
}

#update-popup ul li::before {
  content: "üîπ "; /* Puce personnalis√©e */
}

#update-logo {
  display: block;
  margin: 20px auto 0 auto;
  width: 70px;
  height: auto;
}
  
/* Styles du bouton de connexion - NE SERA PLUS UTILIS√â */
#btn-login {
  display: none !important; /* Masqu√© de mani√®re forc√©e */
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<header>
<div id="header-left">
<a href="/index.html" style="
      display:inline-block;
      width:40px;
      height:40px;
      border-radius:50%;
      overflow:hidden;
      border:0px solid #0a2f51;
    " title="Accueil">
<img alt="Logo" src="https://i.imgur.com/AExTPc7.png" style="width:100%; height:100%; object-fit:cover;"/>
</a>
<h1>Gestion P√©rim√© - Pharmacie du Libron</h1>
<div id="operator-form" style="display:inline-flex; margin-left:10px;">
<input id="operator" placeholder="Nom de l'op√©rateur" type="text"/>
<button id="btn-confirm-operator">Valider</button>
</div>
</div>
<div id="header-right">
<button id="btn-notif" style="position: relative; display: inline-flex; align-items: center; gap: 5px;" title="Notifications">
  <span style="position: relative; display: inline-block; width: 18px; height: 18px;">
    <img alt="Logo" src="https://i.imgur.com/em9h9Wk.png" style="width: 100%; height: 100%; object-fit: cover; vertical-align: middle;" />
    <span id="notif-badge" style="display: none; position: absolute; top: 0px; right: 0px; width: 20px; height: 20px; z-index: 2;">
      <img src="https://i.imgur.com/EIvT5ot.png" style="width: 100%; height: 100%; object-fit: cover;" />
    </span>
  </span>
  Suivi P√©rim√©s
</button>

<button onclick="location.href='historique.html'" title="Historique">
<img alt="Historique" src="https://i.imgur.com/BasLkpT.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
Historique
</button>
  <button onclick="location.href='promotion.html'" title="Promo %">
% Promo
</button>
  <button id="btn-open-my-pdf" title="Ouvrir mon PDF personnalis√©">
  <img src="https://i.imgur.com/kGXfRUa.png" style="width:18px; height:18px; vertical-align:middle;"/>
</button>
<button id="btn-logout" style="display:none;" title="D√©connexion">
<img alt="D√©connexion" src="https://i.imgur.com/OPA1EuF.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
D√©connexion
</button>
</div>

</header>
<main>
<div style="flex-grow:1;">
<div id="filters">
    <div class="filter-group">
        <label for="filter-zone">Zone:</label>
        <input id="filter-zone" type="text" />
    </div>
    <div class="filter-group">
        <label for="filter-month">Date:</label>
        <input id="filter-month" placeholder="MM/YYYY ou YYYY" style="width: 140px;" type="text" />
    </div>
    <div class="filter-group">
        <label for="filter-name-code">Nom ou Code:</label>
        <input id="filter-name-code" type="text" />
    </div>
    <button onclick="filterTable()">Filtrer</button>
    <button onclick="clearFilter()">R√©initialiser</button>
    <button id="btn-print-table" title="EXPORTER EN PDF">
        <img src="https://i.imgur.com/WbH9qyS.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;" />
    </button>
    <ul class="autocomplete-list" id="filter-zone-suggestions" style="display: none;"></ul>
</div>
<div style="max-height: 400px; overflow-y: auto; border-radius: 6px; margin-top: 10px;"><table aria-label="Donn√©es des produits p√©rim√©s" id="data-table" tabindex="0">
<thead>
<tr>
<th>Date</th>
<th>Produit</th>
<th>Code</th>
<th>Qt√©</th>
<th>Zone</th>
<th>Vendues</th>
<th>Promo</th>
<th>Suppr</th>
</tr>
</thead>
<tbody></tbody>
</table></div>
<pre id="status"></pre>
</div>
<form id="entry-form" onsubmit="return false;" style="display: none;">
<h3>Ajouter un produit</h3>
<input id="date" placeholder="MM/YYYY" type="text"/>
<div id="date-error">DATE<br>INVALIDE</div>
<input id="product" placeholder="Nom Bo√Æte" type="text"/>
<input id="code" maxlength="6" minlength="6" pattern="\d{6}" placeholder="Code (6 chiffres)" required="" type="text"/>
<input id="qty" min="0" placeholder="Nb Bo√Ætes" type="number"/>
<input autocomplete="off" id="zone" placeholder="Zone" type="text"/>
<ul class="autocomplete-list" id="zone-suggestions" style="display: none;"></ul>
<button id="btn-add" type="button">Ajouter la ligne</button>
</form>
</main>
<div id="update-overlay">
  <div id="update-popup">
    <h2>Mise √† jour - 14/08/2025</h2>
    <ul>
      <li>Nouvelles fonctionnalit√©s : </li>
      <li>1.La connection a √©t√© modifi√© : la saisie du nom de l'op√©rateur suivie de la touche Entr√©e ou d'un clic sur "Valider" lance directement la connexion Google. </li>
      <li>2. Le bouton "Suivi P√©rim√©s" remplace "Notification" avec 3 onglets : <br> - " Trimestre " => Affiche les produits qui p√©rimeront dans les 3 prochains mois.<br> - " 2√®me Mois " => Affiche le mois "central" du trimestre (ex : Octobre si nous sommes en Ao√ªt) <br> - " √Ä retirer " => Affiche les produits p√©rim√©s le mois pr√©c√©dent, √† retirer des rayons. </li>
      <li>3. Cette fen√™tre d'information ne s'affichera qu'au d√©marrage et dispara√Ætra automatiquement une fois que vous serez connect√©. </li>
      <li>4. Un icone "?" a √©t√© ajout√© √† c√¥t√© de "% promo". Il vous donne acc√®s √† une page Google Drive pour un √©change direct et propose une description d√©taill√©e des fonctionnalit√©s de l'application. </li>
      <li>N'h√©sitez pas √† nous faire part de vos suggestions et remarques.<br> <em>Violaine</em> </li>
    </ul>
    <img src="https://i.imgur.com/yqzUg16.png" alt="Logo Mises √† jour" id="update-logo">
  </div>
</div>
<div aria-labelledby="notif-title" aria-modal="true" id="notification-popup" role="dialog" style="display: none;">
 <header style="display: flex; align-items: center; gap: 20px;">
  <div style="display: flex; align-items: center; gap: 20px;">
  <span id="notif-title"> Produits p√©rim√©s</span>
  <div id="notif-tabs" style="margin: 0;"> <button class="tab-button active" onclick="showTab('trimestre')">Trimestre</button>
    <button class="tab-button" onclick="showTab('2nd-month')">2√®me mois</button>
    <button class="tab-button" onclick="showTab('current-month')">√Ä retirer</button>
  </div>
  </div>
  <div class="header-buttons" style="margin-left: auto;">
  <button id="print-notif" title="Imprimer">
    <img src="https://i.imgur.com/qY1buNb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
  </button>
  <button id="close-notif" title="Fermer">
    <img src="https://i.imgur.com/7NKMuZy.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
  </button>
  </div>
 </header>
 <div class="content">
  <div id="trimestre" class="tab-content active"></div>
  <div id="2nd-month" class="tab-content"></div>
  <div id="current-month" class="tab-content"></div>
 </div>
</div>
<script>
  let gapiLoaded = false;
  let gDriveClient;
  const SPREADSHEET_ID = '123x-aX3u97sQdO_y-P754Q4G15Q4f6789g';
  let dataFromSheet = [];
  const zonesFromSheet = [];
  const entriesForNotif = [];
  const today = new Date();
  const currentMonth = today.getMonth() + 1;
  const currentYear = today.getFullYear();
  const nextMonth = (currentMonth % 12) + 1;
  const nextYear = currentMonth === 12 ? currentYear + 1 : currentYear;
  const monthAfterNext = (nextMonth % 12) + 1;
  const yearAfterNext = nextMonth === 12 ? nextYear + 1 : nextYear;

  const todayKey = `${today.getFullYear()}-${today.getMonth() + 1}`;
  
  const MONTHS_IN_FRENCH = [
      "", "Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin",
      "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"
  ];

  function getMonthName(monthNumber) {
      return MONTHS_IN_FRENCH[monthNumber] || "";
  }
  
  window.initClient = () => {
    google.accounts.oauth2.initTokenClient({
        client_id: '109965306634-6i5c35g9s16p649q1032g58189680a6b.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.metadata.readonly',
        callback: (response) => {
          if (response.access_token) {
            gapiLoaded = true;
            gDriveClient = google.accounts.oauth2.initTokenClient({
                client_id: '109965306634-6i5c35g9s16p649q1032g58189680a6b.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.readonly',
                callback: (response) => {
                    if (response.access_token) {
                        gapi.client.setToken(response);
                        loadGapi();
                    }
                }
            });
            gapi.client.setToken(response);
            loadGapi();
          }
        },
    });
  };

  window.loadGapi = () => {
    gapi.client.load('sheets', 'v4').then(() => {
      // Les API sont charg√©es, on peut maintenant utiliser gapi.client.sheets
      if (document.getElementById('btn-login')) {
        document.getElementById('btn-login').style.display = 'none';
        document.getElementById('operator-form').style.display = 'inline-flex';
        document.getElementById('entry-form').style.display = 'block';
      }
      hideUpdatePopup();
      fetchData();
    });
  };

  function displayStatus(message, isError = false) {
    const status = document.getElementById('status');
    status.textContent = message;
    status.style.color = isError ? 'red' : '#0a2f51';
  }

  function hideUpdatePopup() {
    const overlay = document.getElementById('update-overlay');
    if (overlay) {
      overlay.style.display = 'none';
    }
  }

  async function fetchData() {
      displayStatus('Chargement des donn√©es...');
      try {
          const response = await gapi.client.sheets.spreadsheets.values.get({
              spreadsheetId: SPREADSHEET_ID,
              range: 'A:G', // Adjust range if needed
          });
          dataFromSheet = response.result.values || [];
          renderTable(dataFromSheet);
          extractZonesAndPopulateAutocomplete(dataFromSheet);
          processNotifications(dataFromSheet);
          displayStatus(`Donn√©es charg√©es. ${dataFromSheet.length - 1} entr√©es trouv√©es.`);
          // Met √† jour le nom de l'op√©rateur dans la table
          const operatorName = document.getElementById('operator').value;
          document.getElementById('operator-form').style.display = 'none';
      } catch (error) {
          console.error('Erreur lors du chargement des donn√©es:', error);
          displayStatus('Erreur lors du chargement des donn√©es. V√©rifiez la console pour plus de d√©tails.', true);
      }
  }

  function renderTable(data, tableId = 'data-table') {
      const tableBody = document.getElementById(tableId).querySelector('tbody');
      tableBody.innerHTML = ''; // Clear existing data
      if (data.length <= 1) return; // No data besides header

      // Skip header row for rendering
      data.slice(1).forEach((row, index) => {
          const tr = document.createElement('tr');
          const isSold = row[5] === '1'; // "Vendues" column
          const isPromo = row[6] === '1'; // "Promo" column
          if (isSold) {
              tr.classList.add('ligne-vendue');
          }
          tr.dataset.rowIndex = index + 1; // Store original row index (0-based) in a data attribute

          // Use the correct cell value for "Vendues" and "Promo"
          const venduesValue = isSold ? '‚úÖ' : '';
          const promoValue = isPromo ? '‚úÖ' : '';

          tr.innerHTML = `
            <td contenteditable="true" data-col="0">${row[0]}</td>
            <td contenteditable="true" data-col="1">${row[1]}</td>
            <td contenteditable="true" data-col="2">${row[2]}</td>
            <td contenteditable="true" data-col="3">${row[3]}</td>
            <td contenteditable="true" data-col="4">${row[4]}</td>
            <td class="checkbox-cell" data-col="5">${venduesValue}</td>
            <td class="checkbox-cell" data-col="6">${promoValue}</td>
            <td><button class="delete-btn" data-row-index="${index + 1}">‚úñ</button></td>
          `;
          tableBody.appendChild(tr);
      });
  }

  function renderNotificationTables(entries, tabId) {
      const tableContainer = document.getElementById(tabId);
      tableContainer.innerHTML = ''; // Clear previous content

      // Group entries by month
      const groupedByMonth = entries.reduce((acc, entry) => {
          const monthYear = entry[0]; // Assuming date is in format "MM/YYYY"
          if (!acc[monthYear]) {
              acc[monthYear] = [];
          }
          acc[monthYear].push(entry);
          return acc;
      }, {});

      // Create a table for each month
      for (const monthYear in groupedByMonth) {
          const monthEntries = groupedByMonth[monthYear];
          const [month, year] = monthYear.split('/');
          const monthName = getMonthName(parseInt(month, 10));

          const table = document.createElement('table');
          table.setAttribute('aria-label', `Produits p√©rim√©s en ${monthName} ${year}`);
          table.classList.add('notif-table');
          table.innerHTML = `
              <thead>
                  <tr>
                      <th colspan="7" style="text-align: left;">
                          <h3>P√©rime en ${monthName} ${year}</h3>
                      </th>
                  </tr>
                  <tr>
                      <th>Date</th>
                      <th>Produit</th>
                      <th>Code</th>
                      <th>Qt√©</th>
                      <th>Zone</th>
                      <th>Vendues</th>
                      <th>Promo</th>
                  </tr>
              </thead>
              <tbody></tbody>
          `;
          const tbody = table.querySelector('tbody');

          monthEntries.forEach(row => {
              const tr = document.createElement('tr');
              const isSold = row[5] === '1'; // "Vendues" column
              const isPromo = row[6] === '1'; // "Promo" column
              if (isSold) {
                  tr.classList.add('ligne-vendue');
              }
              const venduesValue = isSold ? '‚úÖ' : '';
              const promoValue = isPromo ? '‚úÖ' : '';

              tr.innerHTML = `
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td>${row[2]}</td>
                <td>${row[3]}</td>
                <td>${row[4]}</td>
                <td class="checkbox-cell">${venduesValue}</td>
                <td class="checkbox-cell">${promoValue}</td>
              `;
              tbody.appendChild(tr);
          });
          tableContainer.appendChild(table);
      }
  }
  
  function filterTable() {
    const filterZone = document.getElementById('filter-zone').value.toLowerCase();
    const filterMonth = document.getElementById('filter-month').value.toLowerCase().replace('/', '');
    const filterNameCode = document.getElementById('filter-name-code').value.toLowerCase();

    const filteredData = dataFromSheet.filter((row, index) => {
        // Always include the header row
        if (index === 0) return true;
        
        const rowZone = row[4] ? row[4].toLowerCase() : '';
        const rowMonthYear = row[0] ? row[0].toLowerCase().replace('/', '') : '';
        const rowProduct = row[1] ? row[1].toLowerCase() : '';
        const rowCode = row[2] ? row[2].toLowerCase() : '';

        // Check for empty filters first
        const zoneMatch = filterZone === '' || rowZone.includes(filterZone);
        const monthMatch = filterMonth === '' || rowMonthYear.includes(filterMonth);
        const nameCodeMatch = filterNameCode === '' || rowProduct.includes(filterNameCode) || rowCode.includes(filterNameCode);

        return zoneMatch && monthMatch && nameCodeMatch;
    });

    renderTable(filteredData);
}

  function clearFilter() {
    document.getElementById('filter-zone').value = '';
    document.getElementById('filter-month').value = '';
    document.getElementById('filter-name-code').value = '';
    renderTable(dataFromSheet);
  }

  function addEntry(date, product, code, qty, zone) {
      if (!gapiLoaded) {
          displayStatus('Erreur: Veuillez vous connecter d\'abord.', true);
          return;
      }
      if (!date || !product || !code || !qty || !zone) {
          displayStatus('Erreur: Tous les champs sont requis.', true);
          return;
      }

      const row = [date, product, code, qty, zone, '0', '0'];
      const body = {
          values: [row]
      };
      gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: 'A:G',
          valueInputOption: 'USER_ENTERED',
          resource: body,
      }).then((response) => {
          displayStatus(`Ligne ajout√©e pour ${product}.`);
          fetchData(); // Reload table after adding
          document.getElementById('entry-form').reset();
      }, (reason) => {
          console.error('Erreur lors de l\'ajout de la ligne:', reason);
          displayStatus('Erreur lors de l\'ajout de la ligne.', true);
      });
  }

  function deleteEntry(rowIndex) {
      if (!gapiLoaded) {
          displayStatus('Erreur: Veuillez vous connecter d\'abord.', true);
          return;
      }
      const rangeToDelete = `A${rowIndex + 1}:G${rowIndex + 1}`;
      const request = {
          spreadsheetId: SPREADSHEET_ID,
          resource: {
              requests: [{
                  deleteDimension: {
                      range: {
                          sheetId: 0, // Assuming first sheet
                          dimension: 'ROWS',
                          startIndex: rowIndex,
                          endIndex: rowIndex + 1,
                      }
                  }
              }]
          }
      };

      gapi.client.sheets.spreadsheets.batchUpdate(request).then((response) => {
          displayStatus(`Ligne ${rowIndex} supprim√©e.`);
          fetchData(); // Reload table after deleting
      }, (reason) => {
          console.error('Erreur lors de la suppression de la ligne:', reason);
          displayStatus('Erreur lors de la suppression de la ligne.', true);
      });
  }

  function updateEntry(rowIndex, colIndex, newValue) {
    if (!gapiLoaded) return;
    
    // Validate date format
    if (colIndex === 0) {
        if (!/^\d{2}\/\d{4}$/.test(newValue)) {
            displayStatus('Erreur: Format de date incorrect (MM/YYYY).', true);
            return;
        }
    }
    
    // Validate code format
    if (colIndex === 2) {
        if (!/^\d{6}$/.test(newValue)) {
            displayStatus('Erreur: Le code doit √™tre compos√© de 6 chiffres.', true);
            return;
        }
    }

    const range = `R${rowIndex + 1}C${colIndex + 1}`;
    gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: range,
        valueInputOption: 'USER_ENTERED',
        resource: {
            values: [
                [newValue]
            ]
        },
    }).then((response) => {
        displayStatus(`Cellule mise √† jour.`);
        fetchData(); // Reload data after update
    }, (reason) => {
        console.error('Erreur lors de la mise √† jour de la cellule:', reason);
        displayStatus('Erreur lors de la mise √† jour de la cellule.', true);
    });
}
  
  function extractZonesAndPopulateAutocomplete(data) {
    const zonesSet = new Set();
    data.slice(1).forEach(row => {
        if (row[4]) {
            zonesSet.add(row[4].trim().toLowerCase());
        }
    });
    // Convert to array and sort
    const sortedZones = Array.from(zonesSet).sort();

    const zoneInput = document.getElementById('zone');
    const zoneSuggestions = document.getElementById('zone-suggestions');
    const filterZoneInput = document.getElementById('filter-zone');
    const filterZoneSuggestions = document.getElementById('filter-zone-suggestions');

    // Autocomplete for add form
    setupAutocomplete(zoneInput, zoneSuggestions, sortedZones);

    // Autocomplete for filter
    setupAutocomplete(filterZoneInput, filterZoneSuggestions, sortedZones);
  }

  function setupAutocomplete(inputElement, suggestionsListElement, dataList) {
    inputElement.addEventListener('input', () => {
        const value = inputElement.value.toLowerCase().trim();
        suggestionsListElement.innerHTML = '';
        suggestionsListElement.style.display = value ? 'block' : 'none';

        if (value) {
            const filteredData = dataList.filter(item => item.startsWith(value));
            filteredData.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                li.addEventListener('click', () => {
                    inputElement.value = item;
                    suggestionsListElement.style.display = 'none';
                });
                suggestionsListElement.appendChild(li);
            });
        }
    });

    document.addEventListener('click', (e) => {
        if (!inputElement.contains(e.target) && !suggestionsListElement.contains(e.target)) {
            suggestionsListElement.style.display = 'none';
        }
    });
  }
  
  function processNotifications(data) {
    const trimestreContent = document.getElementById('trimestre');
    const secondMonthContent = document.getElementById('2nd-month');
    const currentMonthContent = document.getElementById('current-month');
    const notifBadge = document.getElementById('notif-badge');

    const trimestreEntries = [];
    const secondMonthEntries = [];
    const currentMonthEntries = [];

    const now = new Date();
    const currentDay = now.getDate();
    const currentMonthNumber = now.getMonth();
    const currentYearNumber = now.getFullYear();

    data.slice(1).forEach(row => {
        if (row[0] && row[5] !== '1') {
            const [monthStr, yearStr] = row[0].split('/');
            const month = parseInt(monthStr, 10) - 1; // 0-indexed month
            const year = parseInt(yearStr, 10);
            
            if (isNaN(month) || isNaN(year)) return;

            const productDate = new Date(year, month, 1);
            
            // Trimestre (3 prochains mois, du 15 au 14)
            let trimestreStartDate = new Date(currentYearNumber, currentMonthNumber, 15);
            let trimestreEndDate = new Date(trimestreStartDate);
            trimestreEndDate.setMonth(trimestreEndDate.getMonth() + 3);
            trimestreEndDate.setDate(14);
            
            // Logique pour le 15 du mois au 14 du mois suivant
            if (currentDay > 14) {
                trimestreStartDate = new Date(currentYearNumber, currentMonthNumber, 15);
                trimestreEndDate = new Date(currentYearNumber, currentMonthNumber + 4, 14);
            } else {
                trimestreStartDate = new Date(currentYearNumber, currentMonthNumber - 1, 15);
                trimestreEndDate = new Date(currentYearNumber, currentMonthNumber + 3, 14);
            }
            
            if (productDate >= trimestreStartDate && productDate <= trimestreEndDate) {
                trimestreEntries.push(row);
            }

            // 2√®me mois du trimestre (mois central du trimestre)
            let secondMonthStartDate = new Date(currentYearNumber, currentMonthNumber + 1, 15);
            let secondMonthEndDate = new Date(currentYearNumber, currentMonthNumber + 2, 14);

            if (currentDay > 14) {
                secondMonthStartDate = new Date(currentYearNumber, currentMonthNumber + 2, 15);
                secondMonthEndDate = new Date(currentYearNumber, currentMonthNumber + 3, 14);
            }
            
            if (productDate >= secondMonthStartDate && productDate <= secondMonthEndDate) {
                secondMonthEntries.push(row);
            }
            
            // √Ä retirer (p√©rim√©s le mois pr√©c√©dent)
            let previousMonthDate = new Date();
            previousMonthDate.setMonth(previousMonthDate.getMonth() - 1);
            
            if (productDate.getMonth() === previousMonthDate.getMonth() && productDate.getFullYear() === previousMonthDate.getFullYear()) {
                currentMonthEntries.push(row);
            }
        }
    });

    renderNotificationTables(trimestreEntries, 'trimestre');
    renderNotificationTables(secondMonthEntries, '2nd-month');
    renderNotificationTables(currentMonthEntries, 'current-month');

    // G√®re le badge de notification
    if (trimestreEntries.length > 0) {
        notifBadge.style.display = 'inline-block';
    } else {
        notifBadge.style.display = 'none';
    }
  }

  function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const btnAdd = document.getElementById('btn-add');
    const form = document.getElementById('entry-form');
    const tableBody = document.getElementById('data-table').querySelector('tbody');
    const btnNotif = document.getElementById('btn-notif');
    const notifPopup = document.getElementById('notification-popup');
    const closeNotif = document.getElementById('close-notif');
    const printNotif = document.getElementById('print-notif');
    const btnPrintTable = document.getElementById('btn-print-table');

    // Bouton de connexion et formulaire op√©rateur
    const operatorInput = document.getElementById('operator');
    const btnConfirmOperator = document.getElementById('btn-confirm-operator');
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');

    if (btnLogin) {
        btnLogin.addEventListener('click', () => {
            google.accounts.oauth2.initTokenClient({
                client_id: '109965306634-6i5c35g9s16p649q1032g58189680a6b.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.metadata.readonly',
                callback: (response) => {
                    if (response.access_token) {
                        gapiLoaded = true;
                        gapi.client.setToken(response);
                        loadGapi();
                        // Change UI
                        btnLogin.style.display = 'none';
                        document.getElementById('operator-form').style.display = 'inline-flex';
                        btnLogout.style.display = 'inline-block';
                        hideUpdatePopup();
                    }
                },
            }).requestAccessToken();
        });
    }

    if (btnConfirmOperator) {
        btnConfirmOperator.addEventListener('click', () => {
            const operatorName = operatorInput.value.trim();
            if (operatorName) {
                document.getElementById('entry-form').style.display = 'block';
                document.getElementById('operator-form').style.display = 'none';
                displayStatus(`Bienvenue, ${operatorName}.`);
                fetchData();
            } else {
                alert('Veuillez entrer votre nom.');
            }
        });
    }

    if (operatorInput) {
      operatorInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          btnConfirmOperator.click();
        }
      });
    }

    if (btnLogout) {
        btnLogout.addEventListener('click', () => {
            google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {
                gapiLoaded = false;
                location.reload();
            });
        });
    }

    // Gestion du bouton Ajouter
    if (btnAdd) {
        btnAdd.addEventListener('click', () => {
            const date = document.getElementById('date').value.trim();
            const product = document.getElementById('product').value.trim();
            const code = document.getElementById('code').value.trim();
            const qty = document.getElementById('qty').value.trim();
            const zone = document.getElementById('zone').value.trim();

            if (!/^\d{2}\/\d{4}$/.test(date)) {
                document.getElementById('date-error').style.display = 'block';
                setTimeout(() => document.getElementById('date-error').style.display = 'none', 3000);
                return;
            }

            addEntry(date, product, code, qty, zone);
        });
    }

    // Gestion de la pop-up de notification
    if (btnNotif) {
        btnNotif.addEventListener('click', () => {
            notifPopup.style.display = 'flex';
        });
    }
    if (closeNotif) {
        closeNotif.addEventListener('click', () => {
            notifPopup.style.display = 'none';
        });
    }
    window.showTab = showTab; // Expose la fonction pour qu'elle soit accessible via l'attribut onclick

    // Gestion de l'√©dition et de la suppression dans le tableau
    tableBody.addEventListener('input', (e) => {
        const cell = e.target;
        if (cell.tagName === 'TD' && cell.hasAttribute('contenteditable')) {
            const rowIndex = parseInt(cell.parentElement.dataset.rowIndex, 10);
            const colIndex = parseInt(cell.dataset.col, 10);
            const newValue = cell.textContent;
            updateEntry(rowIndex, colIndex, newValue);
        }
    });

    tableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-btn')) {
            const rowIndex = parseInt(e.target.dataset.rowIndex, 10);
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette ligne?')) {
                deleteEntry(rowIndex);
            }
        }
        // G√®re les cases √† cocher "vendues" et "promo"
        const cell = e.target;
        if (cell.tagName === 'TD' && cell.classList.contains('checkbox-cell')) {
            const rowIndex = parseInt(cell.parentElement.dataset.rowIndex, 10);
            const colIndex = parseInt(cell.dataset.col, 10);
            const isChecked = cell.textContent.trim() === '‚úÖ';
            const newValue = isChecked ? '' : '‚úÖ';
            cell.textContent = newValue;
            updateEntry(rowIndex, colIndex, isChecked ? '0' : '1');
        }
    });
    
    // Fonction d'impression de la table
    function printTable() {
    const tableToPrint = document.getElementById('data-table');
    const tableToPrintClone = tableToPrint.cloneNode(true);
    const originalTable = document.getElementById('data-table');
    
    // R√©cup√©rer les filtres actifs
    const filterZone = document.getElementById('filter-zone').value;
    const filterMonth = document.getElementById('filter-month').value;
    const filterNameCode = document.getElementById('filter-name-code').value;

    let filtersTitle = '';
    if (filterZone || filterMonth || filterNameCode) {
        let filters = [];
        if (filterZone) filters.push(`Zone: ${filterZone}`);
        if (filterMonth) filters.push(`Date: ${filterMonth}`);
        if (filterNameCode) filters.push(`Nom/Code: ${filterNameCode}`);
        filtersTitle = `Filtres actifs: ${filters.join(', ')}`;
    }

    const doc = new jspdf.jsPDF();

    // Ajouter le titre et les filtres
    doc.setFontSize(18);
    doc.text('Rapport des Produits P√©rim√©s', 14, 20);
    doc.setFontSize(12);
    if (filtersTitle) {
        doc.text(filtersTitle, 14, 28);
    }

    // Cr√©er une table HTML √† partir du clone
    const tableHTML = tableToPrintClone.outerHTML;

    doc.autoTable({
        html: tableHTML,
        startY: 35, // Position de d√©part de la table
        theme: 'grid',
        headStyles: { fillColor: [188, 215, 237] }, // Bleu clair
        styles: { fontSize: 8, cellPadding: 3 },
        columnStyles: {
            0: { cellWidth: 20 },
            1: { cellWidth: 50 },
            2: { cellWidth: 20 },
            3: { cellWidth: 15 },
            4: { cellWidth: 20 },
            5: { cellWidth: 15 },
            6: { cellWidth: 15 },
            7: { cellWidth: 15 }
        },
        didDrawPage: function (data) {
            // Footer
            let str = "Page " + doc.internal.getNumberOfPages();
            doc.setFontSize(10);
            let pageSize = doc.internal.pageSize;
            let pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
            doc.text(str, data.settings.margin.left, pageHeight - 10);
        }
    });

    doc.save('Rapport_Perimes.pdf');
}
    
    if (btnPrintTable) {
        btnPrintTable.addEventListener('click', printTable);
    }
    
    // Gestion de l'impression de la notification
    if (printNotif) {
      printNotif.addEventListener('click', () => {
        window.print();
      });
    }

  });
</script>
</body>
</html>

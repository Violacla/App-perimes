<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>App Google Sheets - Écriture avec GIS</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    button { margin: 5px; }
  </style>
</head>
<body>
  <h2>Connexion Google Sheets API - Écriture de données</h2>
  <div id="g_id_onload"
       data-client_id="TON_CLIENT_ID_ICI"
       data-context="use"
       data-ux_mode="popup"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>
  <div id="buttonDiv"></div>
  <button id="signout_button" style="display:none;">Déconnexion</button>
  <button id="append_button" style="display:none;">Ajouter une ligne</button>
  <pre id="content" style="margin-top:20px; white-space: pre-wrap;"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com'; // Remplace par ton Client ID
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1!A:C'; // Ton range, modifie si besoin

    let tokenClient;
    let accessToken = null;

    const signoutButton = document.getElementById('signout_button');
    const appendButton = document.getElementById('append_button');
    const content = document.getElementById('content');

    // Chargement API client
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: 'TA_CLE_API_QUI_NE_SERT_PAS_A_L_AUTH', // optionnel, mais recommandé
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      });
      content.textContent = 'API Google Sheets chargée.';
      maybeEnableButtons();
    }

    // Fonction appelée à la connexion Google Identity Services
    function handleCredentialResponse(response) {
      // On obtient un JWT ID token (ne sert pas ici pour API Sheets)
      // Il faut demander un token d'accès avec tokenClient.requestAccessToken()
    }

    // Initialisation du token client OAuth 2.0 GIS
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: '', // callback sera appelé plus tard
      });
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapi.client && tokenClient) {
        document.getElementById('buttonDiv').innerHTML = '';
        const btn = document.createElement('button');
        btn.textContent = accessToken ? 'Reconnecter' : 'Connexion';
        btn.onclick = handleAuthClick;
        document.getElementById('buttonDiv').appendChild(btn);

        signoutButton.style.display = accessToken ? 'inline-block' : 'none';
        appendButton.style.display = accessToken ? 'inline-block' : 'none';
      }
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error) {
          content.textContent = 'Erreur lors de la connexion : ' + resp.error;
          return;
        }
        accessToken = resp.access_token;
        gapi.client.setToken({access_token: accessToken});
        content.textContent = 'Connecté !';
        maybeEnableButtons();
      };

      if (!accessToken) {
        // Demande d'autorisation avec popup
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        // Demande de renouvellement silencieux du token
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    signoutButton.onclick = () => {
      accessToken = null;
      gapi.client.setToken(null);
      content.textContent = 'Déconnecté.';
      maybeEnableButtons();
    };

    appendButton.onclick = async () => {
      if (!accessToken) {
        content.textContent = 'Veuillez vous connecter d’abord.';
        return;
      }
      const values = [
        ["NomExemple", "PrenomExemple", new Date().toLocaleString()]
      ];
      const body = { values };
      try {
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
          valueInputOption: 'USER_ENTERED',
          resource: body,
        });
        content.textContent = 'Ligne ajoutée ! Détails :\n' + JSON.stringify(response.result.updates, null, 2);
      } catch (err) {
        content.textContent = 'Erreur API : ' + JSON.stringify(err.result?.error || err, null, 2);
      }
    };

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>

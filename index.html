<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Connexion Google Sheets</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
  <h2>Connexion et ajout dans Google Sheets</h2>
  <button id="authorize_button">Se connecter</button>
  <button id="append_button" style="display:none;">Ajouter une ligne</button>
  <pre id="content" style="margin-top:20px;"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBHLlV9AXg7Wpyl3flKZ2PaRBCt9fCv0eg';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1!A1:C1'; // Modifie si ta feuille a un autre nom

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    const authorizeButton = document.getElementById('authorize_button');
    const appendButton = document.getElementById('append_button');
    const content = document.getElementById('content');

    window.onload = () => {
      gapi.load('client', initializeGapiClient);
    };

    function initializeGapiClient() {
      gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
      }).then(() => {
        gapiInited = true;
        maybeEnableButtons();
      });
    }

    window.onGisLoaded = function () {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: (tokenResponse) => {
          gapi.client.setToken(tokenResponse);
          authorizeButton.style.display = 'none';
          appendButton.style.display = 'inline-block';
          content.textContent = '✅ Connecté. Prêt à écrire.';
        },
      });
      gisInited = true;
      maybeEnableButtons();
    };

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        authorizeButton.onclick = () => tokenClient.requestAccessToken();
        appendButton.onclick = appendRow;
        authorizeButton.style.display = 'inline-block';
      }
    }

    function appendRow() {
      const values = [["Jean", "Dupont", new Date().toLocaleString()]];
      const body = { values };

      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: "USER_ENTERED",
        resource: body
      }).then(response => {
        content.textContent = '✅ Ligne ajoutée :\n' + JSON.stringify(response.result.updates, null, 2);
      }).catch(error => {
        content.textContent = '❌ Erreur API : ' + (error.result?.error?.message || error.message);
      });
    }

    window.addEventListener('load', () => {
      const script = document.createElement('script');
      script.src = 'https://accounts.google.com/gsi/client';
      script.onload = () => window.onGisLoaded();
      document.head.appendChild(script);
    });
  </script>
</body>
</html>

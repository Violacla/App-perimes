<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>Promotion - Pharmacie du Libron</title>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fffefc;
            margin: 0;
            color: #0a2f51; /* Main text color */
        }
        header {
            background-color: #bcd7ed;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        #header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        h1 {
            margin: 0;
            color: #0a2f51;
            font-size: 1.3em;
        }
        button {
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1em;
            border: none;
            border-radius: 4px;
            background-color: #bcd7ed;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #a6c6e1;
        }
        table {
            width: 90%; /* Adjusted for better visibility */
            max-width: 1200px; /* Max width for large screens */
            border-collapse: collapse;
            background-color: white;
            margin: 20px auto; /* Centering and margins */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px; /* Rounded corners for the table */
            overflow: hidden; /* Ensures rounded corners are visible */
        }
        th, td {
            border: 1px solid #e0e0e0; /* Lighter borders */
            padding: 10px 12px; /* Inner spacing */
            text-align: center;
        }
        th {
            background-color: #e6f0f7; /* Table header background */
            font-weight: bold;
            color: #163f5b;
            position: sticky; /* Sticky headers on scroll */
            top: 0;
            z-index: 1; /* Ensures headers stay on top */
        }
        tbody tr:nth-child(odd) {
            background-color: #f9f9f9; /* Slightly gray odd rows */
        }
        tbody tr:hover {
            background-color: #e0f2f7; /* Hover effect on rows */
        }
        #status {
            text-align: center;
            color: #0a2f51;
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
        }
        #login-block {
            display:flex;
            align-items:center;
            gap:10px;
        }
        #operator {
            padding:8px;
            border-radius:6px;
            border:1px solid #ccc;
        }
        #btn-validate {
            background-color: #0a2f51;
            color: #bcd7ed;
            font-weight: bold;
            padding: 12px 24px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        #btn-validate:hover {
            background-color: #083049;
            transform: translateY(-2px);
        }
        #login-error {
            color:red;
            margin:0;
            font-size: 0.9em;
        }
        /* Hide "Date ajout feuille 1" and "Is_Additional_Promo" columns */
        th:nth-child(9), /* Date ajout feuille 1 (not used directly in rendering) */
        td:nth-child(9),
        th:nth-child(12), /* Is_Additional_Promo (column L - used internally) */
        td:nth-child(12) {
            display: none;
        }
        
        /* Styles for group titles in tables */
        .group-title-row td {
            background:#d3f0dd !important; /* Light green for group titles */
            font-weight:bold;
            text-align:left;
            padding-left: 30px !important;
        }

        /* Styles for the new additional promo section */
        #additional-promo-section {
            width: 90%;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f2f7f2; /* Very light green, almost white */
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: none; /* Hidden by default, shown if products exist */
        }
        #additional-promo-section h2 {
            text-align: center;
            color: #0a2f51;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        #additional-promo-table {
            border: 2px solid #86bf8e; /* Distinctive green border */
        }
        #additional-promo-table th {
            background-color: #bfdbc4; /* Pastel green background for header */
        }
        #additional-promo-table tbody tr:nth-child(odd) {
            background-color: #e8f5e9; /* Very light green background for odd rows */
        }
        #additional-promo-table tbody tr:hover {
            background-color: #d1eccf; /* Light green hover effect */
        }
    </style>
</head>
<body>
<header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #bcd7ed; box-shadow: 0 2px 5px rgba(0,0,0,0.15);">
    <div id="header-left" style="display: flex; align-items: center; gap: 15px;">
        <a href="/index.html" title="Accueil" style="display:inline-block; width:40px; height:40px; border-radius:50%; overflow:hidden; margin-right:10px;">
            <img alt="Logo" src="https://i.imgur.com/AExTPc7.png" style="width:100%; height:100%; object-fit:cover;"/>
        </a>
        <h1 style="margin: 0; color: #0a2f51;">Gestion Promotions - Pharmacie du Libron</h1>
    </div>
    <div id="login-block" style="display:flex; align-items:center; gap:10px;">
        <input type="number" id="operator" placeholder="Code op√©rateur" style="padding:8px; border-radius:6px; border:1px solid #ccc;">
        <button id="btn-validate">Valider</button>
        <p id="login-error" style="color:red; margin:0;"></p>
    </div>
    <div style="display: flex; gap: 10px;">
        <button onclick="window.location.href='index.html'">
            <img alt="Accueil" src="https://i.imgur.com/T8E0o39.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Accueil
        </button>
        <button onclick="location.href='historique.html'" title="Historique">
            <img alt="Historique" src="https://i.imgur.com/BasLkpT.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Historique
        </button>
        <button onclick="window.print()">
            <img src="https://i.imgur.com/qY1buNb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Imprimer
        </button>
        <button id="btn-sync" style="background-color: #0a2f51; color: white;">Synchroniser</button>
        <button id="btn-logout" style="display:none;">
            <img alt="D√©connexion" src="https://i.imgur.com/OPA1EuF.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            D√©connexion
        </button>
    </div>
</header>

<table id="data-table">
    <thead>
    <tr>
        <th>Date</th>
        <th>Nom produit</th>
        <th>Code</th>
        <th>Prix unitaire</th>
        <th>Zone</th>
        <th>Qt√©</th>
        <th>% Promo</th> <!-- Rendered editable -->
        <th>Prix finale</th>
        <th>Supprimer</th> <!-- Delete column for regular promos -->
    </tr>
    </thead>
    <tbody>
        <!-- Current month, next month promotions will be inserted here -->
    </tbody>
</table>

<div id="additional-promo-section">
    <h2>üöÄ Promotions Suppl√©mentaires (g√©r√©es manuellement)</h2>
    <table id="additional-promo-table">
        <thead>
        <tr>
            <th>Date</th>
            <th>Nom produit</th>
            <th>Code</th>
            <th>Prix unitaire</th>
            <th>Zone</th>
            <th>Qt√©</th>
            <th>% Promo</th>
            <th>Prix final</th>
            <th>Supprimer</th>
        </tr>
        </thead>
        <tbody>
            <!-- Additional promotions will be inserted here -->
        </tbody>
    </table>
</div>

<pre id="status">Chargement...</pre>

<script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    // Your Google Sheet ID - DOUBLE CHECK THIS ID
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE'; 
    const SOURCE_RANGE = 'Feuille1!A:K'; // Source range for synchronization (Sheet1)
    // Target range including column L (Is_Additional_Promo) for Sheet3
    const TARGET_RANGE = 'Feuille3!A:L'; 

    let tokenClient;
    let accessToken = null;
    let isGapiReady = false;
    let isGisReady = false;
    let operatorCode = null; // Stores the validated operator code

    // Initializes the Google Sheets API client
    function gapiLoaded() {
        gapi.load('client', async () => {
            await gapi.client.init({
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
            });
            isGapiReady = true;
            checkAndInitialize();
        });
    }

    // Initializes the Google Identity Services (GIS) client
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: "https://www.googleapis.com/auth/spreadsheets",
            callback: async (response) => {
                accessToken = response.access_token;
                gapi.client.setToken({ access_token: accessToken });
                document.getElementById('login-block').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'inline-block';
                document.getElementById('btn-sync').style.display = 'inline-block';
                await loadAllPromos(); // Loads all data after connection
                document.getElementById('status').textContent = `Connect√© avec code op√©rateur ${operatorCode}.`;
            }
        });
        isGisReady = true;
        checkAndInitialize();
    }

    // Checks if both APIs are loaded and initializes validation listeners
    function checkAndInitialize() {
        if (isGapiReady && isGisReady) {
            document.getElementById('btn-validate').onclick = validateOperator;
            document.getElementById('operator').addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    validateOperator();
                }
            });
            // Initial focus on operator input
            document.getElementById('operator').focus();
        }
    }

    // Validates the operator code and initiates Google login
    function validateOperator() {
        const op = parseInt(document.getElementById("operator").value);
        // Authorized operator codes: 1 (pharmacy) 6 (receiver) 7 (preparer)
        if ([1, 6, 7].includes(op)) {
            operatorCode = op; // Stores the validated operator code
            document.getElementById("login-error").textContent = "";
            tokenClient.requestAccessToken(); // Triggers the Google login popup
        } else {
            document.getElementById("login-error").textContent = "Acc√®s refus√©. Code op√©rateur non autoris√©.";
        }
    }

    // Logout function
    document.getElementById('btn-logout').onclick = () => {
        accessToken = null;
        operatorCode = null;
        document.getElementById('login-block').style.display = 'flex';
        document.getElementById('btn-logout').style.display = 'none';
        document.getElementById('btn-sync').style.display = 'none';
        document.getElementById('status').textContent = 'D√©connect√©.';
        document.querySelector('#data-table tbody').innerHTML = '';
        document.querySelector('#additional-promo-table tbody').innerHTML = ''; // Clear additional table as well
        document.getElementById('additional-promo-section').style.display = 'none'; // Hide additional section
        document.getElementById('operator').value = '';
        document.getElementById('operator').focus(); // Return focus to operator field
    };

    // Synchronization function (Feuille1 to Feuille3)
    async function synchronizeSheets() {
        try {
            const resSource = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: SOURCE_RANGE
            });
            const resTarget = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: TARGET_RANGE
            });
            const sourceRows = resSource.result.values || [];
            const targetRows = resTarget.result.values || [];

            if (sourceRows.length === 0) {
                document.getElementById('status').textContent = 'Feuille1 est vide. Aucune donn√©e √† synchroniser.';
                return;
            }

            const existingPromosMap = new Map();
            if (targetRows.length > 1) {
                targetRows.slice(1).forEach(row => {
                    const code = row[2]; // Code is in column C (index 2) in Feuille3
                    if (code) {
                        existingPromosMap.set(code, row);
                    }
                });
            }

            const newTargetRows = [];
            const targetHeader = targetRows[0] && targetRows[0].length >= 12 
                                ? targetRows[0] 
                                : ['Date', 'Nom produit', 'Code', 'Prix unitaire', 'Zone', 'Qt√©', '% Promo', 'Prix finale', 'Date ajout feuille 1', 'Supprimer', 'Prix_modifi√©', 'Is_Additional_Promo'];
            newTargetRows.push(targetHeader);
            
            const processedCodes = new Set(); // To keep track of codes processed from Feuille1

            sourceRows.slice(1).forEach(sourceRow => { // Iterate through all data rows from Feuille1
                const datePeremption = new Date(sourceRow[1]); // Column B (Feuille1)
                const code = sourceRow[3]; // Column D (Feuille1)
                const now = new Date();

                // Skip if expired or has no product code
                if (isNaN(datePeremption.getTime()) || datePeremption < now || !code) {
                    return; 
                }

                const existingRow = existingPromosMap.get(code);
                let rowToUpdate = existingRow ? [...existingRow] : new Array(12).fill(''); // Initialize with existing or empty
                
                // Set fixed Feuille3 column indices from Feuille1 data
                rowToUpdate[0] = sourceRow[1] || ''; // Date (Feuille3 A from Feuille1 B)
                rowToUpdate[1] = sourceRow[2] || ''; // Nom produit (Feuille3 B from Feuille1 C)
                rowToUpdate[2] = sourceRow[3] || ''; // Code (Feuille3 C from Feuille1 D)
                rowToUpdate[3] = sourceRow[9] || ''; // Prix unitaire (Feuille3 D from Feuille1 J)
                rowToUpdate[4] = sourceRow[5] || ''; // Zone (Feuille3 E from Feuille1 F)
                rowToUpdate[5] = sourceRow[4] || ''; // Qt√© (Feuille3 F from Feuille1 E)
                // rowToUpdate[6] (Prix Promo is H, index 7, will be handled below)
                // rowToUpdate[7] (Prix finale is I, index 8, will be recalculated)
                // rowToUpdate[8] (Date ajout feuille 1 is J, index 9, not directly mapped or needed for sync logic)
                // rowToUpdate[9] (Supprimer is K, index 10, not mapped, default for delete button)
                // rowToUpdate[10] (Prix_modifi√© is K, index 10, will be handled below)
                // rowToUpdate[11] (Is_Additional_Promo is L, index 11, will be handled below)

                const diff = (datePeremption.getFullYear() - now.getFullYear()) * 12 + (datePeremption.getMonth() - now.getMonth());

                // --- Handle Is_Additional_Promo (Feuille3 column L, index 11) ---
                let shouldBeAdditional = false;
                const isCurrentlyAdditionalInFeuille3 = existingRow && existingRow.length > 11 && existingRow[11] === 'TRUE';

                if (isCurrentlyAdditionalInFeuille3) {
                    shouldBeAdditional = true; // Preserve TRUE if already set in Feuille3
                    console.log(`[SYNC] Product ${code} was already additional. Preserving.`);
                } else if (diff > 1 && parseFloat(sourceRow[4]) > 0) { // Product is beyond M+1 AND has quantity in Feuille1
                    shouldBeAdditional = true; // Mark as new additional promo
                    console.log(`[SYNC] Product ${code} flagged as new additional promo (diff: ${diff}, qty: ${sourceRow[4]}).`);
                }
                rowToUpdate[11] = shouldBeAdditional ? 'TRUE' : 'FALSE';

                // --- Handle Percentage (Feuille3 column G, index 6 - NOTE: this was H, index 7 in previous comments. Re-verify columns) ---
                // Let's assume % Promo is actually column G, index 6 based on your earlier table headers
                // If it's column H, index 7. Let's stick with index 7 as used in renderAllPromos too.
                // Re-checking the table headers: Date, Nom produit, Code, Prix unitaire, Zone, Qt√©, % Promo, Prix finale, Supprimer
                // So % Promo is column G, which is index 6. Let's correct this everywhere.
                // Correction: The HTML table header has 9 columns: Date (0), Nom produit (1), Code (2), Prix unitaire (3), Zone (4), Qt√© (5), % Promo (6), Prix finale (7), Supprimer (8)
                // Feuille3 columns are A (0) to L (11).
                // Feuille3 mapping:
                // Date (A, 0), Nom (B, 1), Code (C, 2), Prix unitaire (D, 3), Zone (E, 4), Qt√© (F, 5), % Promo (G, 6), Prix finale (H, 7), Date ajout feuille 1 (I, 8), Supprimer (J, 9), Prix_modifi√© (K, 10), Is_Additional_Promo (L, 11)
                // Yes, so % Promo is index 6. Prix finale is index 7. Prix_modifi√© is index 10. Is_Additional_Promo is index 11.
                // My apologies for the previous index confusion. I will correct all occurrences of index 7 (% Promo) to index 6, and index 8 (Prix finale) to index 7 etc.

                // Corrected indices:
                // targetRow[6] is % Promo
                // targetRow[7] is Prix finale
                // targetRow[10] is Prix_modifi√©
                // targetRow[11] is Is_Additional_Promo

                if (shouldBeAdditional) {
                    // For additional promos, use existing percentage from Feuille3 or default to 0 if new/empty
                    rowToUpdate[6] = existingRow && existingRow[6] !== undefined ? existingRow[6] : '0'; // % Promo (index 6)
                    console.log(`[SYNC] Additional promo ${code} percentage: ${rowToUpdate[6]}`);
                } else {
                    // For regular promos (not additional)
                    if (diff === 0) { // Current month
                        rowToUpdate[6] = 50; // % Promo (index 6)
                        console.log(`[SYNC] Regular promo ${code} (Mois en cours) percentage: 50%`);
                    } else if (diff === 1) { // Next month
                        rowToUpdate[6] = 30; // % Promo (index 6)
                        console.log(`[SYNC] Regular promo ${code} (Mois suivant) percentage: 30%`);
                    } else {
                        // For regular promos whose date is beyond M+1, set percentage to 0
                        rowToUpdate[6] = 0; // % Promo (index 6)
                        console.log(`[SYNC] Regular promo ${code} (Mois > M+1) percentage: 0%`);
                    }
                }

                // --- Handle Prix_modifi√© (Feuille3 column K, index 10) ---
                // Preserve existing modified price if it exists, otherwise use unit price from Feuille1 J (sourceRow[9])
                rowToUpdate[10] = existingRow && existingRow[10] !== undefined && String(existingRow[10]).trim() !== '' 
                                 ? existingRow[10] : sourceRow[9] !== undefined ? sourceRow[9] : '';

                // Add to newTargetRows only if it's not already there (if existing) or is a new entry
                if (existingRow) {
                    const existingIdx = newTargetRows.findIndex(r => r[2] === code); // Find by code
                    if (existingIdx !== -1) {
                        newTargetRows[existingIdx] = rowToUpdate; // Update in place
                    } else {
                        newTargetRows.push(rowToUpdate); // Should not happen if map is correct
                    }
                } else {
                    newTargetRows.push(rowToUpdate); // Add new item
                }
                processedCodes.add(code);
            });

            // Add back any existing "additional" promos from Feuille3 that were NOT processed from Feuille1
            // (meaning they are manually added to Feuille3 and don't originate from Feuille1)
            targetRows.slice(1).forEach(targetRow => {
                const code = targetRow[2]; // Code is at index 2 in Feuille3
                const isAdditional = (targetRow.length > 11 && targetRow[11] === 'TRUE');
                
                if (isAdditional && !processedCodes.has(code)) {
                    newTargetRows.push(targetRow);
                    console.log(`[SYNC] Preserving manual additional promo ${code} not found in Feuille1.`);
                }
            });

            // Update the sheet
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Feuille3!A1', 
                valueInputOption: 'RAW',
                resource: { values: newTargetRows }
            });
            
            console.log("Sheet3 synchronized. Modified prices and additional promos have been preserved.");
        } catch (error) {
            console.error("Synchronization error:", error);
            document.getElementById('status').textContent = `Synchronization error: ${error.message}`;
        }
    }


    // Loads all data from the promotion sheet (Sheet3)
    document.getElementById('btn-sync').onclick = async () => { // Moved this listener here
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter d\'abord.';
            return;
        }
        document.getElementById('status').textContent = 'Synchronisation en cours...';
        await synchronizeSheets();
        await loadAllPromos();
        document.getElementById('status').textContent = 'Synchronisation termin√©e !';
    };


    async function loadAllPromos() {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter d\'abord.';
            return;
        }
        try {
            document.getElementById('status').textContent = 'Chargement des promotions...';

            const resFeuille3 = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: TARGET_RANGE 
            });
            const allPromoRows = resFeuille3.result.values || [];

            await cleanOldEntries(allPromoRows); 
            
            // Re-fetch after cleaning to get the latest state of the sheet
            const resFeuille3AfterClean = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: TARGET_RANGE 
            });
            const cleanedPromoRows = resFeuille3AfterClean.result.values || [];

            const now = new Date(); 
            renderAllPromos(cleanedPromoRows, now); 
            document.getElementById('status').textContent = 'Promotions charg√©es.';
        } catch (e) {
            document.getElementById('status').textContent = `Erreur de chargement: ${e.message}`;
            console.error("Erreur de chargement des feuilles:", e);
        }
    }

    // Function to render a single promo row
    function renderPromoRow(item, targetTbody, isAdditionalTable = false) {
        const tr = document.createElement("tr");
        const tdDate = document.createElement("td"); tdDate.textContent = item.dateStr;
        const tdProduit = document.createElement("td"); tdProduit.textContent = item.produit;
        const tdCode = document.createElement("td"); tdCode.textContent = item.code;
        const tdPrixUnit = document.createElement("td"); tdPrixUnit.textContent = item.prixUnitaire.toFixed(2); tdPrixUnit.contentEditable = true; // Editable unit price
        const tdZone = document.createElement("td"); tdZone.textContent = item.zone;
        const tdQty = document.createElement("td"); tdQty.textContent = item.qty; // Quantity
        
        const tdPercentage = document.createElement("td"); // Editable percentage cell
        tdPercentage.textContent = item.percentage.toFixed(0) + "%"; 
        tdPercentage.contentEditable = true; 
        
        const tdPrixFinal = document.createElement("td"); tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";
        
        // Delete button
        const tdDelete = document.createElement("td");
        tdDelete.innerHTML = '<img src="https://i.imgur.com/oStNoqu.png" style="width:20px; height:20px; cursor:pointer;" title="Delete this row">';
        tdDelete.onclick = async () => {
            const confirmDelete = confirm(`Voulez-vous vraiment supprimer "${item.produit}" ?`);
            if (confirmDelete) {
                await deleteRowFromSheet(TARGET_RANGE, item.originalRowIndex);
            }
        };

        // Event listener for unit price modification (Feuille3 Column K / index 10)
        tdPrixUnit.addEventListener("blur", async () => {
            const cleaned = tdPrixUnit.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
            const newPrix = parseFloat(cleaned) || 0;
            
            item.prixUnitaire = newPrix;
            item.prixFinal = newPrix * (1 - item.percentage / 100); 
            tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";

            await saveCellToSheet(TARGET_RANGE, item.originalRowIndex, 10, newPrix); // Index 10 for Prix_modifi√©
        });

        // Event listener for percentage modification (Feuille3 Column G / index 6)
        tdPercentage.addEventListener("blur", async () => {
            const cleaned = tdPercentage.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
            const newPct = parseFloat(cleaned) || 0;
            
            item.percentage = newPct;
            item.prixFinal = item.prixUnitaire * (1 - newPct / 100); 
            tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";
            tdPercentage.textContent = newPct.toFixed(0) + "%"; 

            await saveCellToSheet(TARGET_RANGE, item.originalRowIndex, 6, newPct); // Index 6 for % Promo
        });

        tr.appendChild(tdDate);
        tr.appendChild(tdProduit);
        tr.appendChild(tdCode);
        tr.appendChild(tdPrixUnit);
        tr.appendChild(tdZone);
        tr.appendChild(tdQty);
        tr.appendChild(tdPercentage); 
        tr.appendChild(tdPrixFinal);
        tr.appendChild(tdDelete);
        targetTbody.appendChild(tr);
    }

    // Function to add a group of rows to a table
    function appendGroup(targetTbody, title, group) { // Removed isThirdMonthFacing, isAdditionalTable for this helper, simplified
        if (group.length === 0 && title !== "") { // If group is empty and title is not empty string (for 3rd month msg)
            return;
        }

        const trTitle = document.createElement("tr");
        trTitle.classList.add('group-title-row'); 
        const td = document.createElement("td");
        td.colSpan = 9; 
        td.textContent = title;
        trTitle.appendChild(td);
        targetTbody.appendChild(trTitle);

        group.forEach(item => {
            renderPromoRow(item, targetTbody);
        });
    }


    // Renders all promotion categories
    function renderAllPromos(allPromoRows, now) { 
        const tbodyMain = document.querySelector("#data-table tbody");
        const tbodyAdditional = document.querySelector("#additional-promo-table tbody");
        const additionalPromoSection = document.getElementById('additional-promo-section');

        tbodyMain.innerHTML = ""; 
        tbodyAdditional.innerHTML = ""; 
        additionalPromoSection.style.display = 'none'; 
        
        let moisEnCours = [];
        let moisSuivant = [];
        let additionalPromos = []; 
        let facingCount = 0; 

        const dataRows = allPromoRows.slice(1);

        dataRows.forEach((row, index) => {
            if (row.length < 12) { 
                while(row.length < 12) row.push('');
            }

            const originalRowIndex = index + 2; 

            const produit = row[1] || ''; // Feuille3 Column B (Nom produit)
            const code = row[2] || ''; // Feuille3 Column C (Code)
            const zone = row[4] || ''; // Feuille3 Column E (Zone)
            const qty = row[5] || ''; // Feuille3 Column F (Qt√©)
            let percentageFromSheet = parseFloat((row[6] || "0").replace(/[^\d.,]/g, '').replace(',', '.')) || 0; // Feuille3 Column G (% Promo)
            const prixUnitaire = parseFloat((row[3] || "0").replace(/[^\d.,]/g, '').replace(',', '.')) || 0; // Feuille3 Column D (Prix unitaire)
            
            let percentageToDisplay = percentageFromSheet;
            let prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);
            
            const dateStr = row[0]; // Feuille3 Column A (Date)
            const date = new Date(dateStr);
            
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const diff = (date.getFullYear() - currentYear) * 12 + (date.getMonth() - currentMonth);

            const isAdditionalFlag = (row[11] === 'TRUE'); // Feuille3 Column L (Is_Additional_Promo)
            console.log(`[RENDER] Produit: ${produit}, isAdditionalFlag: ${isAdditionalFlag}, PourcentageFeuille: ${percentageFromSheet}`); 

            if (!isNaN(date.getTime()) && !isAdditionalFlag) { // Not an additional promo
                if (diff === 0) { // Current month
                    if (percentageFromSheet === 0 || isNaN(percentageFromSheet)) {
                        percentageToDisplay = 50; 
                    }
                    prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);
                    moisEnCours.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                    console.log(`[RENDER] --> Class√© comme promo automatique (Mois en cours). Pourcentage affich√©: ${percentageToDisplay}`);
                } else if (diff === 1) { // Next month
                    if (percentageFromSheet === 0 || isNaN(percentageFromSheet)) {
                        percentageToDisplay = 30; 
                    }
                    prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);
                    moisSuivant.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                    console.log(`[RENDER] --> Class√© comme promo automatique (Mois suivant). Pourcentage affich√©: ${percentageToDisplay}`);
                } else if (diff === 2) { // 3rd month (Facing)
                    facingCount++; 
                    console.log(`[RENDER] --> Class√© comme produit 3e mois √† mettre en avant.`);
                } else {
                    // This handles regular promos whose date is beyond month+2 but are not additional.
                    // Their percentage should be displayed as is from Sheet3.
                    if (percentageFromSheet > 0) { // Only add to display if it has a non-zero percentage
                        moisSuivant.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                        console.log(`[RENDER] --> Class√© comme autre promo automatique (date > M+1). Pourcentage affich√©: ${percentageToDisplay}`);
                    } else {
                        console.log(`[RENDER] --> Produit ${produit} (code: ${code}) ignor√© (date > M+1 et % promo 0 ou vide).`);
                    }
                }
            } else if (isAdditionalFlag && percentageFromSheet > 0) { // Explicitly additional promo with a percentage
                percentageToDisplay = percentageFromSheet; 
                prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);
                additionalPromos.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                console.log(`[RENDER] --> Class√© comme PROMO SUPPL√âMENTAIRE. Pourcentage: ${percentageToDisplay}`);
            } else {
                console.log(`[RENDER] --> Produit ${produit} (code: ${code}) ignor√© (isAdditionalFlag: ${isAdditionalFlag}, pourcentage: ${percentageFromSheet}).`);
            }
        });
        
        // Sort current and next month promos by date
        moisEnCours.sort((a, b) => new Date(a.dateStr) - new Date(b.dateStr));
        moisSuivant.sort((a, b) => new Date(a.dateStr) - new Date(b.dateStr));
        // Sort additional promos by product name
        additionalPromos.sort((a, b) => a.produit.localeCompare(b.produit));

        // Function to format month and year for titles
        function formatMonthYear(date) {
            return date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
        }

        // Render automatic promotions (Current month, Next month, and 3rd month message)
        appendGroup(tbodyMain, `üì¶ Mois en cours (50% par d√©faut) - ${formatMonthYear(now)}`, moisEnCours);
        const nextMonthDate = new Date();
        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
        appendGroup(tbodyMain, `üì¶ Mois suivant (30% par d√©faut) - ${formatMonthYear(nextMonthDate)}`, moisSuivant);
        
        if (facingCount > 0) {
            const finalRow = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 9; 
            td.style = "font-style: italic; text-align:left; padding-top:10px; background:#f0f8ff;";
            td.textContent = `Les ${facingCount} produits du 3·µâ mois doivent √™tre mis en avant dans les rayons. ‚ùó`;
            finalRow.appendChild(td);
            tbodyMain.appendChild(finalRow); 
        }

        // Render "Additional Promotions" if any
        if (additionalPromos.length > 0) {
            additionalPromoSection.style.display = 'block'; 
            console.log(`[RENDER] Affichage de la section promotions suppl√©mentaires. Total promos suppl√©mentaires: ${additionalPromos.length}`); 
            // There is no month grouping for this section, just the list
            additionalPromos.forEach(item => {
                renderPromoRow(item, tbodyAdditional, true); 
            });
        } else {
            console.log("[RENDER] Aucune promotion suppl√©mentaire √† afficher. La section restera masqu√©e.");
        }

        document.getElementById("status").textContent = 'Donn√©es de promotions charg√©es et tri√©es.';
    }

    // Generic function to save a cell to any sheet
    async function saveCellToSheet(rangePrefix, rowIndex, colIndex, newValue) {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter pour sauvegarder.';
            return;
        }
        const sheetName = rangePrefix.split('!')[0]; 
        
        try {
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${sheetName}!${columnToLetter(colIndex)}${rowIndex}`,
                valueInputOption: 'RAW',
                resource: { values: [[newValue]] }
            });
            console.log(`Cellule mise √† jour dans ${sheetName} (ligne ${rowIndex}, colonne ${colIndex})`);
            document.getElementById('status').textContent = `Cellule mise √† jour dans ${sheetName}.`;
        } catch (error) {
            console.error(`Erreur lors de la mise √† jour de la cellule dans ${sheetName}:`, error);
            document.getElementById('status').textContent = `Erreur lors de la sauvegarde dans ${sheetName}.`;
        }
    }

    // Function to delete a row from the sheet (Sheet3)
    async function deleteRowFromSheet(rangePrefix, rowIndex) {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter pour supprimer.';
            return;
        }
        const sheetName = rangePrefix.split('!')[0];
        try {
            const res = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: sheetName 
            });
            let rows = res.result.values || [];

            if (rowIndex > 0 && rowIndex <= rows.length) {
                rows.splice(rowIndex - 1, 1); 
            } else {
                console.error("Invalid row index for deletion:", rowIndex);
                document.getElementById('status').textContent = "Error: Invalid row index for deletion.";
                return;
            }

            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${sheetName}!A1`, 
                valueInputOption: 'RAW',
                resource: { values: rows }
            });
            document.getElementById('status').textContent = `Ligne supprim√©e de ${sheetName}.`;
            await loadAllPromos(); 
        } catch (error) {
            console.error(`Erreur lors de la suppression de la ligne dans ${sheetName}:`, error);
            document.getElementById('status').textContent = `Erreur lors de la suppression: ${error.message}`;
        }
    }


    // Converts numeric column index to letter (1->A, 2->B...)
    function columnToLetter(column) {
        let temp, letter = '';
        while(column > 0) {
            temp = (column - 1) % 26;
            letter = String.fromCharCode(temp + 65) + letter;
            column = (column - temp - 1) / 26;
        }
        return letter;
    }

    // Cleans old entries (only applies to regular promos in Sheet3)
    async function cleanOldEntries(allRows) {
        const now = new Date(); 
        const header = allRows[0];
        
        const filteredRows = allRows.filter((row, i) => {
            if (i === 0) return true; 
            if (row.length < 12) { 
                const datePeremption = new Date(row[0]); // Feuille3 Column A (Date)
                return !isNaN(datePeremption.getTime()) && datePeremption >= now;
            }
            const isAdditional = (row[11] === 'TRUE');
            if (isAdditional) {
                return true; 
            } else {
                const datePeremption = new Date(row[0]); // Feuille3 Column A (Date)
                return !isNaN(datePeremption.getTime()) && datePeremption >= now;
            }
        });

        if (filteredRows.length !== allRows.length) {
            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: TARGET_RANGE, 
                    valueInputOption: 'RAW',
                    resource: { values: filteredRows }
                });
                console.log("Automatic cleaning performed (Sheet3) for regular promos.");
            } catch (error) {
                console.error("Error cleaning Sheet3:", error);
                document.getElementById('status').textContent = `Error during automatic cleaning: ${error.message}`;
            }
        } else {
             console.log("No old regular promotion entries to clean in Sheet3.");
        }
    }

    // Initial loading of Google APIs
    window.onload = () => {
        gapiLoaded();
        gisLoaded();
    };
</script>
<footer style="
    position: fixed;
    bottom: 0;
    width: 100%;
    text-align: center;
    font-size: 0.6em;
    color: #666;
    background: #bfdbc4;
    padding: 8px 0;
    box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
    z-index: 10;
">
    D√©velopp√© par Violaine Claron - Mise √† jour
</footer>
</body>
</html>

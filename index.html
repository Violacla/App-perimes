<!DOCTYPE html>
<html>
<head>
  <title>Google Sheets API avec GIS</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    #authorize_button, #signout_button {
      display: inline-block;
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>Connexion Google Sheets API avec GIS</h2>

  <div id="g_id_signin"></div>

  <button id="authorize_button" style="display:none;">Autoriser l’accès Google Sheets</button>
  <button id="signout_button" style="display:none;">Déconnexion</button>

  <pre id="content" style="white-space: pre-wrap; margin-top: 20px;"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE/edit?gid=0#gid=0';
    const RANGE = 'A1:E20';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton = document.getElementById('signout_button');
    const content = document.getElementById('content');

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: DISCOVERY_DOCS,
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            content.textContent = 'Erreur token : ' + tokenResponse.error;
            return;
          }
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'inline-block';
          content.textContent = 'Token d\'accès obtenu.\nChargement des données...';
          listSheetsData();
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        authorizeButton.style.display = 'inline-block';
      }
    }

    function handleAuthClick() {
      tokenClient.requestAccessToken();
    }

    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken(null);
        content.textContent = 'Déconnecté.';
        authorizeButton.style.display = 'inline-block';
        signoutButton.style.display = 'none';
      }
    }

    async function listSheetsData() {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
        });
        const rows = response.result.values;
        if (!rows || rows.length === 0) {
          content.textContent = 'Aucune donnée trouvée.';
          return;
        }
        content.textContent = rows.map(row => row.join(' | ')).join('\n');
      } catch (err) {
        content.textContent = 'Erreur API : ' + err.message;
      }
    }

    authorizeButton.onclick = handleAuthClick;
    signoutButton.onclick = handleSignoutClick;

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>

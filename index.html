<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Gestion Perim√© - Pharmacie du Libron</title>
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
<script src="https://apis.google.com/js/api.js"></script>
<style>
  .autocomplete-list {
  position: absolute;
  background-color: white;
  border: 1px solid #ccc;
  border-radius: 4px;
  list-style: none;
  margin: 0;
  padding: 0;
  max-height: 150px;
  overflow-y: auto;
  width: 250px;
  z-index: 999;
}

.autocomplete-list li {
  padding: 8px 10px;
  cursor: pointer;
  color: black;
}

.autocomplete-list li:hover,
.autocomplete-list li.active {
  background-color: #bcd7ed;
  color: white;
}

  :root {
    --bleu-glacial: #bcd7ed;
  }

  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f9f9f9;
  }

  /* Bandeau bleu glacial */
  header {
    background-color: var(--bleu-glacial);
    color: #0a2f51;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  }

  #header-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  #header-left > h1 {
    margin: 0;
    font-size: 1.3em;
  }

  button {
    cursor: pointer;
    border: none;
    background: transparent;
    font-size: 1em;
    color: #0a2f51;
    padding: 6px 10px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: rgba(255 255 255 / 0.3);
  }

  /* Icons with emoji for simplicity */
  .icon {
    font-size: 1.2em;
    margin-right: 6px;
  }

  /* Header right buttons */
  #header-right {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  /* Operator form */
  #operator-form {
    margin-left: 10px;
  }

  /* Layout */
  main {
    display: flex;
    margin: 20px;
  }

  /* Form to add entries on right */
 #entry-form {
  width: 320px;
  background: white;
  padding: 15px 20px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  margin-left: 20px;
  margin-top: 48px; /* Aligne avec les filtres */
}

  #entry-form h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: normal;
  }
  #entry-form input {
    width: 100%;
    margin: 6px 0;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  #entry-form button {
    width: 100%;
    background-color: var(--bleu-glacial);
    color: #0a2f51;
    font-weight: bold;
    margin-top: 10px;
  }
  #entry-form button:hover {
    background-color: #a6c6e1;
  }

  /* Table styles */
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    border-radius: 6px;
    overflow: hidden;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px 10px;
    text-align: center;
  }

  /* Alternate row background with 15% opacity bleu glacial */
  tbody tr:nth-child(odd) {
    background-color: rgba(188, 215, 237, 0.15);
  }

  /* Selected row highlight 50% opacity */
  tbody tr.selected {
    background-color: rgba(188, 215, 237, 0.5) !important;
  }

  /* Editable cells */
  tbody td {
    cursor: text;
  }

  /* Filter section */
  #filters {
    margin: 20px;
    display: flex;
    gap: 15px;
    align-items: flex-end;
  }
  #filters label {
    font-weight: bold;
  }
  #filters input, #filters button {
    padding: 5px 8px;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #filters button {
    background-color: var(--bleu-glacial);
    color: #0a2f51;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  #filters button:hover {
    background-color: #a6c6e1;
  }

  /* Status text */
  #status {
    margin: 10px 20px;
    font-weight: bold;
    color: #0a2f51;
  }

  /* Notification popup modal */
  #notification-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    z-index: 9999;
    display: none;
    flex-direction: column;
  }

  #notification-popup header {
    background-color: var(--bleu-glacial);
    color: #0a2f51;
    font-weight: bold;
    padding: 12px 20px;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #notification-popup header button {
    background: transparent;
    border: none;
    font-size: 1.4em;
    cursor: pointer;
    color: #0a2f51;
  }

  #notification-popup .content {
    padding: 15px 20px;
    overflow-y: auto;
  }

  #notification-popup table {
    width: 100%;
    border-collapse: collapse;
  }
  #notification-popup th, #notification-popup td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    text-align: center;
  }
  #notification-popup tbody tr:nth-child(odd) {
    background-color: rgba(188, 215, 237, 0.15);
  }

 @media print {
  body * {
    visibility: hidden !important;
  }

  /* Cas : impression du tableau filtr√© */
  body.print-table #data-table,
  body.print-table #data-table * {
    visibility: visible !important;
  }

  body.print-table #data-table {
    position: static !important;
    width: 100% !important;
  }

  body.print-table header,
  body.print-table footer,
  body.print-table #entry-form,
  body.print-table #filters,
  body.print-table #status,
  body.print-table #notification-popup {
    display: none !important;
  }

  /* Cas : impression des notifications */
  body.print-notif #notification-popup,
  body.print-notif #notification-popup * {
    visibility: visible !important;
  }

  body.print-notif #notification-popup {
    position: static !important;
    width: 100% !important;
    max-height: none !important;
    overflow: visible !important;
    border-radius: 0 !important;
    box-shadow: none !important;
  }

  body.print-notif header button,
  body.print-notif #print-notif,
  body.print-notif #btn-notif,
  body.print-notif footer,
  body.print-notif #entry-form,
  body.print-notif #filters,
  body.print-notif #status,
  body.print-notif #data-table {
    display: none !important;
  }
}
.table-wrapper {
  max-height: 400px;
  overflow-y: auto;
  border-radius: 6px;
  margin-top: 10px;
}

@media print {
  .table-wrapper {
    max-height: none !important;
    overflow: visible !important;
  }
}

</style>
</head>
<header>
<div id="header-left">
<a href="/index.html" style="
      display:inline-block;
      width:40px;
      height:40px;
      border-radius:50%;
      overflow:hidden;
      border:0px solid #0a2f51;
    " title="Accueil">
<img alt="Logo" src="https://i.imgur.com/1mhZplp.png" style="width:100%; height:100%; object-fit:cover;"/>
</a>
<h1>Gestion P√©rim√© - Pharmacie du Libron</h1>
<!-- Groupe op√©rateur -->
<div id="operator-form" style="display:none; margin-left:10px;">
<input id="operator" placeholder="Nom de l'op√©rateur" type="text"/>
<button id="btn-confirm-operator">Valider</button>
</div>
<!-- Bouton connexion -->
<button id="btn-login" style="display:inline-block; margin-left:10px;">Se connecter</button>
</div>
<div id="header-right">
<button id="btn-notif" style="position: relative; display: inline-flex; align-items: center; gap: 5px;" title="Notifications">
<img alt="Logo" src="https://i.imgur.com/DqTzhLF.png" style="width:18px; height:18px; object-fit:cover; vertical-align:middle;"/>
   Notifications
  <span id="notif-badge" style="display: none; position: absolute; top: 0px; right: 0px; width: 16px; height: 16px; z-index: 2;">
<img src="https://i.imgur.com/eNB2WOM.png" style="width:100%; height:100%; object-fit:cover;"/>
</span>
</button>
<button onclick="location.href='historique.html'" title="Historique">
<img alt="Historique" src="https://i.imgur.com/2PRqXMD.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
Historique
</button>
<button id="btn-logout" style="display:none;" title="D√©connexion">
<img alt="D√©connexion" src="https://i.imgur.com/Ku9oMjb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
D√©connexion
</button>
</div>
</header>
<main>
<div style="flex-grow:1;">
<div id="filters">
<label for="filter-zone">Filtrer Zone :</label>
<input id="filter-zone" placeholder="Ex: Zone A" type="text"/>
<label for="filter-month">Mois  :</label>
<input type="text" id="filter-month" placeholder="MM/YYYY" style="width: 120px;" />
<button onclick="filterTable()">Filtrer</button>
<button onclick="clearFilter()">R√©initialiser</button>
<button id="btn-print-table">Imprimer les r√©sultats</button>
</div>
<div class="table-wrapper">
<table aria-label="Donn√©es des produits p√©rim√©s" id="data-table" tabindex="0">
<thead>
<tr>
<!-- Ne PAS afficher colonne op√©rateur -->
<th>Produit</th>
<th>Date</th>
<th>Qt√©</th>
<th>Zone</th>
<th>Vendues</th>
<th>Promo</th>
<th>Suppr</th>
</tr>
</thead>
<tbody></tbody>
</table></div>
<pre id="status"></pre>
</div>
<div id="entry-form" style="display:none;">
<h3>Ajouter un produit</h3>
<input id="date" placeholder="MM/YYYY" type="text"/>
<input id="product" placeholder="Nom Bo√Æte" type="text"/>
<input id="qty" min="0" placeholder="Nb Bo√Ætes" type="number"/>
<input type="text" id="zone" placeholder="Zone" autocomplete="off" />
<ul id="zone-suggestions" class="autocomplete-list" style="display: none;"></ul>
<button id="btn-add">Ajouter la ligne</button>
</div>
</main>
<body>
<div aria-labelledby="notif-title" aria-modal="true" id="notification-popup" role="dialog">
<header>
<span id="notif-title">Notifications - Produits p√©rim√©s</span>
<div>
<button id="print-notif" title="Imprimer">üñ®Ô∏è</button>
<button id="close-notif" title="Fermer">‚úñÔ∏è</button>
</div>
</header>
<div class="content">
<!-- Table notifications ins√©r√©es ici -->
</div>
</div>
<div id="popup-6mois" style="
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: #f8d7da;
  color: #721c24;
  padding: 20px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  font-weight: bold;
  text-align: center;
  z-index: 10000;
">
  üî¥ Ce produit est √† date tr√®s courte ! (&lt; 6 mois)
</div>
<div id="popup-1an" style="
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: #fff3cd;
  color: #856404;
  padding: 20px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  font-weight: bold;
  text-align: center;
  z-index: 10000;
">
  üü† Ce produit est √† date courte ! (&lt; 1 an)
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const badge = document.getElementById('notif-badge');
  const btnNotif = document.getElementById('btn-notif');
  const now = new Date();
  const monthKey = `${now.getFullYear()}-${now.getMonth()+1}`;
  if (now.getDate() >= 15 && localStorage.getItem('notifSeen') !== monthKey) {
    badge.style.display = 'inline-block';
  }
  btnNotif.addEventListener('click', () => {
    badge.style.display = 'none';
    localStorage.setItem('notifSeen', monthKey);
  });

  const operatorInput = document.getElementById('operator');
  const btnOperator = document.getElementById('btn-confirm-operator');
  if (operatorInput && btnOperator) {
    operatorInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btnOperator.click();
      }
    });
  }
});
</script></body>
<!-- Notification Popup -->
<script>
  const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
  const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
  const RANGE = 'Feuille1';
  const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

  let tokenClient, gapiInited = false, gisInited = false, accessToken = null, operatorName = null;

  function gapiLoaded() { gapi.load('client', initializeGapiClient); }
  async function initializeGapiClient() {
    await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
    gapiInited = true;
    maybeEnableButtons();
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById('operator-form').style.display = 'inline-flex';
        document.getElementById('btn-login').style.display = 'none';
        setStatus('Connect√©. Choisissez un op√©rateur.');
      },
    });
    gisInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('btn-login').style.display = 'inline-block';
    }
  }

  function setStatus(msg) {
    document.getElementById('status').textContent = msg;
  }

  document.getElementById('btn-login').onclick = () => {
    tokenClient.requestAccessToken();
  };

  document.getElementById('btn-logout').onclick = () => {
    accessToken = null; operatorName = null;
    document.getElementById('btn-login').style.display = 'inline-block';
    document.getElementById('btn-logout').style.display = 'none';
    document.getElementById('operator-form').style.display = 'none';
    document.getElementById('entry-form').style.display = 'none';
    clearTable();
    setStatus('D√©connect√©.');
  };

  document.getElementById('btn-confirm-operator').onclick = () => {
    const op = document.getElementById('operator').value;
    if (!op) return alert("Choisir un op√©rateur");
    operatorName = op;
    document.getElementById('operator-form').style.display = 'none';
    document.getElementById('btn-logout').style.display = 'inline-block';
    document.getElementById('entry-form').style.display = 'block';
    loadSheet();
  };

  document.getElementById('btn-add').onclick = async () => {
    if(!operatorName) {
      alert("Veuillez vous connecter et choisir un op√©rateur");
      return;
    }
    
    let rawDate = document.getElementById('date').value;
    let dateVal = "";
    if (rawDate) {
      const [month, year] = rawDate.split('/');
      if (month && year) {
        const paddedMonth = month.padStart(2, '0');
        const lastDay = new Date(year, parseInt(paddedMonth), 0).getDate();
        dateVal = `${year}-${paddedMonth}-${lastDay}`;
      }
    }
    if (!dateVal) {
      const today = new Date();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const y = today.getFullYear();
      const d = new Date(y, today.getMonth() + 1, 0).getDate();
      dateVal = `${y}-${m}-${d}`;
    }

    const productVal = document.getElementById('product').value.trim();
    const qtyVal = parseInt(document.getElementById('qty').value);
    const zoneVal = document.getElementById('zone').value.trim();
    const soldVal = 0;
    const promoVal = 0;


    if (!productVal || isNaN(qtyVal) || !zoneVal || isNaN(soldVal) || isNaN(promoVal)) {
      alert("Veuillez remplir tous les champs correctement.");
      return;
    }

    const values = [[
      operatorName,
      productVal,
      dateVal,
      qtyVal,
      zoneVal,
      soldVal,
      promoVal,
    ]];

    try {
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: 'USER_ENTERED',
        resource: { values }
      });
      loadSheet();
      setStatus('Ligne ajout√©e avec succ√®s !');
      // Clear form inputs
      document.getElementById('product').value = '';
      document.getElementById('qty').value = '';
      document.getElementById('zone').value = '';
      document.getElementById('sold').value = '';
      document.getElementById('promo').value = '';
      document.getElementById('date').value = '';
    } catch (e) {
      setStatus('Erreur : ' + e.message);
    }
  };

  // Load sheet data, exclude operator from table display
  async function loadSheet() {
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: RANGE });
      const rows = res.result.values || [];
      renderTable(rows);
    } catch (e) {
      setStatus("Erreur de chargement : " + e.message);
    }
  }

  function clearTable() {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
  }

  // Render table without op√©rateur column (index 0)
  function renderTable(rows) {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
    rows.slice(1).forEach((row, i) => {
      const tr = document.createElement('tr');
      // Columns: op√©rateur (0), produit (1), date(2), qty(3), zone(4), vendues(5), promo(6)
      // We skip op√©rateur (col 0)
      const cols = [1, 2, 3, 4, 5, 6];
      cols.forEach(colIndex => {
        const td = document.createElement('td');
        td.textContent = row[colIndex] || '';
        td.contentEditable = true;
        td.dataset.row = i + 2; // Google Sheets rows start at 1 + header row
        td.dataset.col = colIndex + 1; // Google Sheets columns start at 1
        td.addEventListener('blur', onCellEdit);
        tr.appendChild(td);
      });
      tr.addEventListener('click', () => {
        // Unselect all
        document.querySelectorAll('#data-table tbody tr').forEach(r => r.classList.remove('selected'));
        tr.classList.add('selected');
      });
      tbody.appendChild(tr);
    });
  }

  // Update cell in Google Sheets on edit
  async function onCellEdit(e) {
    if(!operatorName) return;
    const td = e.target;
    const newValue = td.textContent.trim();
    const row = td.dataset.row;
    const col = td.dataset.col;

    try {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `Feuille1!${columnToLetter(col)}${row}`,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [[newValue]] }
      });
      setStatus(`Cellule mise √† jour (ligne ${row}, colonne ${col})`);
    } catch (err) {
      setStatus('Erreur mise √† jour : ' + err.message);
    }
  }
// Supprimer une ligne dans Google Sheets
async function deleteRow(rowNumber) {
  if (!operatorName) {
    alert("Veuillez vous connecter.");
    return;
  }

  try {
    // Vide les cellules de A √† G sur la ligne sp√©cifi√©e
    const emptyRow = [["", "", "", "", "", "", ""]];
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: `Feuille1!A${rowNumber}:G${rowNumber}`,
      valueInputOption: 'USER_ENTERED',
      resource: { values: emptyRow }
    });

    setStatus(`Ligne ${rowNumber} supprim√©e.`);
    loadSheet(); // Recharge le tableau apr√®s suppression
  } catch (err) {
    setStatus("Erreur lors de la suppression : " + err.message);
  }
}

  // Convert number to letter for column (1->A, 2->B ...)
  function columnToLetter(column) {
    let temp, letter = '';
    while(column > 0) {
      temp = (column - 1) % 26;
      letter = String.fromCharCode(temp + 65) + letter;
      column = (column - temp - 1) / 26;
    }
    return letter;
  }

function filterTable() {
  const zoneFilter = document.getElementById("filter-zone").value.trim().toLowerCase();
  const monthFilter = document.getElementById("filter-month").value.trim(); // format MM/YYYY
  const rows = document.querySelectorAll("#data-table tbody tr");

  rows.forEach((row) => {
    const zoneCell = row.cells[3].textContent.trim().toLowerCase(); // Zone = colonne 4
    const dateCell = row.cells[1].textContent.trim(); // Date = colonne 2
    let show = true;

    // Filtre zone
    if (zoneFilter && !zoneCell.includes(zoneFilter)) {
      show = false;
    }

    // Filtre mois MM/YYYY
    if (monthFilter) {
      const [yyyy, mm, dd] = dateCell.split('-');
      const rowMonth = `${mm}/${yyyy}`;
      const [mFilter, yFilter] = monthFilter.split('/');
      if (rowMonth !== `${mFilter}/${yFilter}`) {
        show = false;
      }
    }

    row.style.display = show ? "" : "none";
  });
}

  function clearFilter() {
    document.getElementById('filter-zone').value = '';
    document.getElementById('filter-month').value = '';
    filterTable();
  }

  // Notification popup logic
  const notifPopup = document.getElementById('notification-popup');
  const notifContent = notifPopup.querySelector('.content');
  document.getElementById('btn-notif').onclick = () => {
    if(!operatorName) {
      alert("Connectez-vous et choisissez un op√©rateur pour voir les notifications.");
      return;
    }
    loadNotifications();
    notifPopup.style.display = 'flex';
  };
  document.getElementById('close-notif').onclick = () => {
    notifPopup.style.display = 'none';
  };
  document.getElementById('print-notif').onclick = () => {
    window.print();
  };
// trier 3mois
async function loadNotifications() {
  try {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: RANGE
    });
    const rows = res.result.values || [];
    const data = rows.slice(1);

    const now = new Date();

    const monthsSet = new Set();
    for (let i = 1; i <= 3; i++) {
      const future = new Date(now.getFullYear(), now.getMonth() + i, 1);
      const ym = `${future.getFullYear()}-${String(future.getMonth() + 1).padStart(2, '0')}`;
      monthsSet.add(ym);
    }

    const grouped = {};

    data.forEach(row => {
      const dateStr = row[2];
      if (!dateStr) return;
      const d = new Date(dateStr);
      if (isNaN(d)) return;

      const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      if (monthsSet.has(ym)) {
        if (!grouped[ym]) grouped[ym] = [];
        grouped[ym].push(row);
      }
    });

    let html = '';
    const sortedYM = Array.from(monthsSet).sort();

    for (const ym of sortedYM) {
      html += `<h3>${formatMonthYear(ym)}</h3>`;

      const rowsForMonth = grouped[ym] || [];

      if (rowsForMonth.length === 0) {
        html += '<p>Aucun produit p√©rim√© pour ce mois.</p>';
        continue;
      }

      rowsForMonth.sort((a, b) => {
        const zoneA = (a[4] || '').toLowerCase();
        const zoneB = (b[4] || '').toLowerCase();
        return zoneA.localeCompare(zoneB);
      });

      html += `<table>
        <thead>
          <tr>
            <th>Produit</th><th>Date</th><th>Qt√©</th><th>Zone</th><th>Vendues</th><th>Promo</th>
          </tr>
        </thead>
        <tbody>`;

      rowsForMonth.forEach(row => {
        html += '<tr>';
        [1, 2, 3, 4, 5, 6].forEach(ci => {
          html += `<td>${row[ci] || ''}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
    }

    notifContent.innerHTML = html;

  } catch (e) {
    notifContent.innerHTML = `<p>Erreur chargement notifications : ${e.message}</p>`;
  }
}


// Format "YYYY-MM" en "Mois Ann√©e" (ex : "2025-05" -> "Mai 2025")
function formatMonthYear(ym) {
  const [y, m] = ym.split('-');
  const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                  'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
  return months[parseInt(m, 10) - 1] + ' ' + y;
}

  // Load GAPI & GIS on window load
  window.onload = () => {
    gapiLoaded();
    gisLoaded();
  };
</script>
<script>
  document.getElementById('btn-history').addEventListener('click', async () => {
    if (!operatorName) {
      alert("Connectez-vous et choisissez un op√©rateur pour acc√©der √† l'historique.");
      return;
    }
    try {
      await transferToHistorique();
      window.location.href = '/historique.html';
    } catch (e) {
      alert("Erreur lors du transfert vers historique : " + e.message);
    }
  });

  async function transferToHistorique() {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'Feuille1'
    });
    const allRows = res.result.values || [];
    if (allRows.length <= 1) return;

    const now = new Date();
    const currentYM = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    const toMove = [];
    const remaining = [allRows[0]];

    allRows.slice(1).forEach(row => {
      const dateStr = row[2];
      if (!dateStr) return;
      const d = new Date(dateStr);
      if (isNaN(d)) return;
      const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      if (ym < currentYM) toMove.push(row);
      else remaining.push(row);
    });

    if (toMove.length > 0) {
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'historique',
        valueInputOption: 'USER_ENTERED',
        resource: { values: toMove }
      });
    }

    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: 'Feuille1',
      valueInputOption: 'USER_ENTERED',
      resource: { values: remaining }
    });
    setStatus(`Transf√©r√© ${toMove.length} lignes vers "historique".`);
  }
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fields = [
    'date',
    'product',
    'qty',
    'zone',
    'sold',
    'promo'
  ];

  fields.forEach((id, index) => {
    const input = document.getElementById(id);
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const nextField = document.getElementById(fields[index + 1]);
        if (nextField) {
          nextField.focus();
        } else {
          // Si c'est le dernier champ ‚Üí clique sur le bouton
          document.getElementById('btn-add').click();
        }
      }
    });
  });
});
</script>
  <script>
  const dateInput = document.getElementById('date');
  if (dateInput) {
    dateInput.addEventListener('input', function(e) {
      let val = e.target.value.replace(/[^\d]/g, '');
      if (val.length > 2) {
        val = val.slice(0,2) + '/' + val.slice(2,6);
      }
      e.target.value = val;
    });
  }
</script>

<script>
const zones = [
  "aboca", "aderma", "arko", "aromat", "avene", "bain", "bande", "b√©b√©",
  "bien etre", "bioderma", "bi-oil", "bonbon", "brumes et senteurs", "cerave",
  "circulation", "clearskin", "collagene", "coloration", "confort", "conseil",
  "cooper geo", "cosmeto", "dentaire", "deo", "dermato", "dexeryl", "dietetique",
  "douleurs", "durex", "enfants", "forme", "frigo", "homeo", "hydratis", "intime",
  "la roche posay", "la rosee", "lait b√©b√©", "levres et mains", "moustik",
  "noreva", "nutergia", "nuxe", "ongles", "oreille", "pieds et mains", "pileje",
  "poux", "ronflement", "cheveux", "corps", "STUP", "svr", "tisanes", "uriage",
  "nature", "vichy", "yeux", "1ersoins", "4patte"
];

const input = document.getElementById('zone');
const list = document.getElementById('zone-suggestions');

input.addEventListener('input', function () {
  const val = this.value.toLowerCase();
  list.innerHTML = '';
  if (val.length < 1) {
    list.style.display = 'none';
    return;
  }

  const matches = zones.filter(z => z.toLowerCase().includes(val));
  if (matches.length === 0) {
    list.style.display = 'none';
    return;
  }

  matches.forEach((zone, index) => {
    const li = document.createElement('li');
    li.textContent = zone;
    li.addEventListener('click', () => {
      input.value = zone;
      list.innerHTML = '';
      list.style.display = 'none';
    });
    list.appendChild(li);
  });

  const rect = input.getBoundingClientRect();
  list.style.top = rect.bottom + window.scrollY + 'px';
  list.style.left = rect.left + window.scrollX + 'px';
  list.style.width = input.offsetWidth + 'px';
  list.style.display = 'block';
});

document.addEventListener('click', function (e) {
  if (!input.contains(e.target) && !list.contains(e.target)) {
    list.style.display = 'none';
  }
});
  function renderTable(rows) {
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';

  rows.slice(1).forEach((row, i) => {
    const tr = document.createElement('tr');
    const cols = [1, 2, 3, 4, 5, 6];

    cols.forEach(colIndex => {
      const td = document.createElement('td');
      td.textContent = row[colIndex] || '';
      td.contentEditable = true;
      td.dataset.row = i + 2;
      td.dataset.col = colIndex + 1;
      td.addEventListener('blur', onCellEdit);
      tr.appendChild(td);
    });

    // ‚úÖ Ajout de la colonne "‚úñÔ∏è"
    const tdDelete = document.createElement('td');
    tdDelete.innerHTML = '‚úñÔ∏è';
    tdDelete.style.cursor = 'pointer';
    tdDelete.style.color = '#bbb';
    tdDelete.style.fontSize = '1.1em';
    tdDelete.title = 'Supprimer cette ligne';
    tdDelete.addEventListener('mouseenter', () => tdDelete.style.color = '#888');
    tdDelete.addEventListener('mouseleave', () => tdDelete.style.color = '#bbb');
    tdDelete.addEventListener('click', async () => {
      const confirmed = confirm("Supprimer cette ligne ?");
      if (confirmed) {
        await deleteRow(i + 2);
      }
    });
    tr.appendChild(tdDelete);

    tr.addEventListener('click', () => {
      document.querySelectorAll('#data-table tbody tr').forEach(r => r.classList.remove('selected'));
      tr.classList.add('selected');
    });

    tbody.appendChild(tr);
  });
}
</script>
<script>
  // Filtrer en appuyant sur Entr√©e dans les champs
  document.addEventListener('DOMContentLoaded', function () {
    const filterZone = document.getElementById('filter-zone');
    const filterMonth = document.getElementById('filter-month');

    [filterZone, filterMonth].forEach(input => {
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          filterTable(); // fonction que tu as d√©j√†
        }
      });
    });
  });

</script>
<script>
// Impression du tableau avec filtres
document.getElementById('btn-print-table').addEventListener('click', () => {
  document.body.classList.add('print-table');
  window.print();
  setTimeout(() => document.body.classList.remove('print-table'), 1000);
});

// Impression des notifications (popup)
document.getElementById('print-notif').addEventListener('click', () => {
  document.body.classList.add('print-notif');
  window.print();
  setTimeout(() => document.body.classList.remove('print-notif'), 1000);
});
  
</script>

<footer style="
  position: fixed;
  bottom: 0;
  width: 100%;
  text-align: center;
  font-size: 0.3em;
  color: #666;
  background: #f0f0f0;
  padding: 8px 0;
  box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
  z-index: 10;
">
  D√©velopp√© par Violaine Claron
</footer>

</body>
</html>

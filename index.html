<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suivi des périmés - Table visible</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 6px;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h2>Connexion Google Sheets API + Table visible & modifiable</h2>

  <button id="btn-login" style="display:none;">Se connecter</button>
  <button id="btn-logout" style="display:none;">Déconnexion</button>

  <div id="filters" style="display:none;">
    <label>Filtrer par zone : <input type="text" id="filter-zone"></label>
    <label>Filtrer par date (jj/mm/aaaa) : <input type="text" id="filter-date"></label>
    <button onclick="applyFilters()">Appliquer</button>
  </div>

  <div id="table-wrapper" style="margin-top: 20px; display:none;">
    <h3>Données du tableau</h3>
    <table id="data-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <pre id="status"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1';
    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let accessToken = null;
    let dataCache = [];

    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const status = document.getElementById('status');

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            status.textContent = 'Erreur auth : ' + tokenResponse.error;
            return;
          }
          accessToken = tokenResponse.access_token;
          status.textContent = 'Connecté.';
          btnLogin.style.display = 'none';
          btnLogout.style.display = 'inline-block';
          loadSheetData();
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        btnLogin.style.display = 'inline-block';
      }
    }

    btnLogin.onclick = () => tokenClient.requestAccessToken();

    btnLogout.onclick = () => {
      accessToken = null;
      document.getElementById('data-table').innerHTML = '';
      document.getElementById('table-wrapper').style.display = 'none';
      btnLogout.style.display = 'none';
      btnLogin.style.display = 'inline-block';
      document.getElementById('filters').style.display = 'none';
      status.textContent = 'Déconnecté.';
    };

    async function loadSheetData() {
      try {
        const res = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE
        });
        dataCache = res.result.values;
        displayTable(dataCache);
      } catch (err) {
        status.textContent = 'Erreur chargement : ' + err.message;
      }
    }

    function displayTable(data) {
      if (!data || data.length === 0) return;
      document.getElementById('filters').style.display = 'block';
      document.getElementById('table-wrapper').style.display = 'block';

      const table = document.getElementById('data-table');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      const headerRow = document.createElement('tr');
      data[0].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      for (let i = 1; i < data.length; i++) {
        const row = document.createElement('tr');
        data[i].forEach((cell, j) => {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.textContent = cell;
          td.dataset.row = i + 1;
          td.dataset.col = j;
          td.addEventListener('blur', handleCellEdit);
          row.appendChild(td);
        });
        tbody.appendChild(row);
      }
    }

    async function handleCellEdit(event) {
      const cell = event.target;
      const rowIndex = parseInt(cell.dataset.row);
      const colIndex = parseInt(cell.dataset.col);
      const newValue = cell.textContent;
      const colLetter = String.fromCharCode(65 + colIndex);
      const cellRef = `${colLetter}${rowIndex}`;

      try {
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `Feuille1!${cellRef}`,
          valueInputOption: 'USER_ENTERED',
          resource: { values: [[newValue]] }
        });
        status.textContent = `Cellule ${cellRef} mise à jour.`;
      } catch (err) {
        status.textContent = `Erreur modification cellule : ${err.message}`;
      }
    }

    function applyFilters() {
      const zone = document.getElementById('filter-zone').value.toLowerCase();
      const date = document.getElementById('filter-date').value;

      const filtered = dataCache.filter((row, i) => {
        if (i === 0) return true;
        const zoneMatch = !zone || (row[5] && row[5].toLowerCase().includes(zone));
        const dateMatch = !date || (row[2] && row[2].includes(date));
        return zoneMatch && dateMatch;
      });

      displayTable(filtered);
    }

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>

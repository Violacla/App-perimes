<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>Promotion - Pharmacie du Libron</title>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fffefc;
            margin: 0;
            color: #0a2f51; /* Main text color */
        }
        header {
            background-color: #bcd7ed;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        #header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        h1 {
            margin: 0;
            color: #0a2f51;
            font-size: 1.3em;
        }
        button {
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1em;
            border: none;
            border-radius: 4px;
            background-color: #bcd7ed;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #a6c6e1;
        }
        table {
            width: 90%; /* Adjusted for better visibility */
            max-width: 1200px; /* Max width for large screens */
            border-collapse: collapse;
            background-color: white;
            margin: 20px auto; /* Centering and margins */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px; /* Rounded corners for the table */
            overflow: hidden; /* Ensures rounded corners are visible */
        }
        th, td {
            border: 1px solid #e0e0e0; /* Lighter borders */
            padding: 10px 12px; /* Inner spacing */
            text-align: center;
        }
        th {
            background-color: #e6f0f7; /* Table header background */
            font-weight: bold;
            color: #163f5b;
            position: sticky; /* Sticky headers on scroll */
            top: 0;
            z-index: 1; /* Ensures headers stay on top */
        }
        tbody tr:nth-child(odd) {
            background-color: #f9f9f9; /* Slightly gray odd rows */
        }
        tbody tr:hover {
            background-color: #e0f2f7; /* Hover effect on rows */
        }
        #status {
            text-align: center;
            color: #0a2f51;
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
        }
        #login-block {
            display:flex;
            align-items:center;
            gap:10px;
        }
        #operator {
            padding:8px;
            border-radius:6px;
            border:1px solid #ccc;
        }
        #btn-validate {
            background-color: #0a2f51;
            color: #bcd7ed;
            font-weight: bold;
            padding: 12px 24px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        #btn-validate:hover {
            background-color: #083049;
            transform: translateY(-2px);
        }
        #login-error {
            color:red;
            margin:0;
            font-size: 0.9em;
        }
        /* Hide "Date ajout feuille 1" and "Is_Additional_Promo" columns */
        th:nth-child(9), /* Date ajout feuille 1 (not used directly in rendering) */
        td:nth-child(9),
        th:nth-child(12), /* Is_Additional_Promo (column L - used internally) */
        td:nth-child(12) {
            display: none;
        }
        
        /* Styles for group titles in tables */
        .group-title-row td {
            background:#d3f0dd !important; /* Light green for group titles */
            font-weight:bold;
            text-align:left;
            padding-left: 30px !important;
        }

        /* Styles for the new additional promo section */
        #additional-promo-section {
            width: 90%;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f2f7f2; /* Very light green, almost white */
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            display: none; /* Hidden by default, shown if products exist */
        }
        #additional-promo-section h2 {
            text-align: center;
            color: #0a2f51;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        #additional-promo-table {
            border: 2px solid #86bf8e; /* Distinctive green border */
        }
        #additional-promo-table th {
            background-color: #bfdbc4; /* Pastel green background for header */
        }
        #additional-promo-table tbody tr:nth-child(odd) {
            background-color: #e8f5e9; /* Very light green background for odd rows */
        }
        #additional-promo-table tbody tr:hover {
            background-color: #d1eccf; /* Light green hover effect */
        }
    </style>
</head>
<body>
<header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #bcd7ed; box-shadow: 0 2px 5px rgba(0,0,0,0.15);">
    <div id="header-left" style="display: flex; align-items: center; gap: 15px;">
        <a href="/index.html" title="Accueil" style="display:inline-block; width:40px; height:40px; border-radius:50%; overflow:hidden; margin-right:10px;">
            <img alt="Logo" src="https://i.imgur.com/AExTPc7.png" style="width:100%; height:100%; object-fit:cover;"/>
        </a>
        <h1 style="margin: 0; color: #0a2f51;">Gestion Promotions - Pharmacie du Libron</h1>
    </div>
    <div id="login-block" style="display:flex; align-items:center; gap:10px;">
        <input type="number" id="operator" placeholder="Code op√©rateur" style="padding:8px; border-radius:6px; border:1px solid #ccc;">
        <button id="btn-validate">Valider</button>
        <p id="login-error" style="color:red; margin:0;"></p>
    </div>
    <div style="display: flex; gap: 10px;">
        <button onclick="window.location.href='index.html'">
            <img alt="Accueil" src="https://i.imgur.com/T8E0o39.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Accueil
        </button>
        <button onclick="location.href='historique.html'" title="Historique">
            <img alt="Historique" src="https://i.imgur.com/BasLkpT.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Historique
        </button>
        <button onclick="window.print()">
            <img src="https://i.imgur.com/qY1buNb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Imprimer
        </button>
        <button id="btn-sync" style="background-color: #0a2f51; color: white;">Synchroniser</button>
        <button id="btn-logout" style="display:none;">
            <img alt="D√©connexion" src="https://i.imgur.com/OPA1EuF.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            D√©connexion
        </button>
    </div>
</header>

<table id="data-table">
    <thead>
    <tr>
        <th>Date</th>
        <th>Nom produit</th>
        <th>Code</th>
        <th>Prix unitaire</th>
        <th>Zone</th>
        <th>Qt√©</th>
        <th>% Promo</th> <!-- Rendered editable -->
        <th>Prix finale</th>
        <th>Supprimer</th> <!-- Delete column for regular promos -->
    </tr>
    </thead>
    <tbody>
        <!-- Current month, next month promotions will be inserted here -->
    </tbody>
</table>

<div id="additional-promo-section">
    <h2>üöÄ Promotions Suppl√©mentaires (g√©r√©es manuellement)</h2>
    <table id="additional-promo-table">
        <thead>
        <tr>
            <th>Date</th>
            <th>Nom produit</th>
            <th>Code</th>
            <th>Prix unitaire</th>
            <th>Zone</th>
            <th>Qt√©</th>
            <th>% Promo</th>
            <th>Prix final</th>
            <th>Supprimer</th>
        </tr>
        </thead>
        <tbody>
            <!-- Additional promotions will be inserted here -->
        </tbody>
    </table>
</div>

<pre id="status">Chargement...</pre>

<script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    // Your Google Sheet ID - DOUBLE CHECK THIS ID
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE'; 
    const SOURCE_RANGE = 'Feuille1!A:K'; // Source range for synchronization (Sheet1)
    // Target range including column L (Is_Additional_Promo) for Sheet3
    const TARGET_RANGE = 'Feuille3!A:L'; 

    let tokenClient;
    let accessToken = null;
    let isGapiReady = false;
    let isGisReady = false;
    let operatorCode = null; // Stores the validated operator code

    // Initializes the Google Sheets API client
    function gapiLoaded() {
        gapi.load('client', async () => {
            await gapi.client.init({
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
            });
            isGapiReady = true;
            checkAndInitialize();
        });
    }

    // Initializes the Google Identity Services (GIS) client
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: "https://www.googleapis.com/auth/spreadsheets",
            callback: async (response) => {
                accessToken = response.access_token;
                gapi.client.setToken({ access_token: accessToken });
                document.getElementById('login-block').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'inline-block';
                document.getElementById('btn-sync').style.display = 'inline-block';
                await loadAllPromos(); // Loads all data after connection
                document.getElementById('status').textContent = `Connect√© avec code op√©rateur ${operatorCode}.`;
            }
        });
        isGisReady = true;
        checkAndInitialize();
    }

    // Checks if both APIs are loaded and initializes validation listeners
    function checkAndInitialize() {
        if (isGapiReady && isGisReady) {
            document.getElementById('btn-validate').onclick = validateOperator;
            document.getElementById('operator').addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    validateOperator();
                }
            });
            // Initial focus on operator input
            document.getElementById('operator').focus();
        }
    }

    // Validates the operator code and initiates Google login
    function validateOperator() {
        const op = parseInt(document.getElementById("operator").value);
        // Authorized operator codes: 1 (pharmacy) 6 (receiver) 7 (preparer)
        if ([1, 6, 7].includes(op)) {
            operatorCode = op; // Stores the validated operator code
            document.getElementById("login-error").textContent = "";
            tokenClient.requestAccessToken(); // Triggers the Google login popup
        } else {
            document.getElementById("login-error").textContent = "Acc√®s refus√©. Code op√©rateur non autoris√©.";
        }
    }

    // Logout function
    document.getElementById('btn-logout').onclick = () => {
        accessToken = null;
        operatorCode = null;
        document.getElementById('login-block').style.display = 'flex';
        document.getElementById('btn-logout').style.display = 'none';
        document.getElementById('btn-sync').style.display = 'none';
        document.getElementById('status').textContent = 'D√©connect√©.';
        document.querySelector('#data-table tbody').innerHTML = '';
        document.querySelector('#additional-promo-table tbody').innerHTML = ''; // Clear additional table as well
        document.getElementById('additional-promo-section').style.display = 'none'; // Hide additional section
        document.getElementById('operator').value = '';
        document.getElementById('operator').focus(); // Return focus to operator field
    };

    // Synchronization function (Sheet1 to Sheet3 for auto promos)
    document.getElementById('btn-sync').onclick = async () => {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter d\'abord.';
            return;
        }
        document.getElementById('status').textContent = 'Synchronisation en cours...';
        await synchronizeSheets();
        await loadAllPromos();
        document.getElementById('status').textContent = 'Synchronisation termin√©e !';
    };
    
    // Synchronizes Sheet1 (source) to Sheet3 (promo target), preserving modified prices and additional promos
    async function synchronizeSheets() {
        try {
            const resSource = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: SOURCE_RANGE
            });
            const resTarget = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: TARGET_RANGE
            });
            const sourceRows = resSource.result.values || [];
            const targetRows = resTarget.result.values || [];

            if (sourceRows.length === 0) {
                document.getElementById('status').textContent = 'Feuille1 est vide. Aucune donn√©e √† synchroniser.';
                return;
            }

            // Filters products from Sheet1 that have a promo percentage (>0)
            const promoRowsFromSource = sourceRows.slice(1).filter(row => parseFloat(row[7]) > 0); // row[7] is the '%'
            
            // Creates a map of existing promos in Sheet3 by product code to facilitate updates
            const existingPromosMap = new Map();
            if (targetRows.length > 1) {
                targetRows.slice(1).forEach(row => {
                    const code = row[3]; // Code is in column D (index 3)
                    if (code) {
                        existingPromosMap.set(code, row);
                    }
                });
            }

            const newTargetRows = [];
            const sourceHeader = sourceRows[0] || [];
            // Ensures that Sheet3's header is correct, including column K "Prix_modifi√©" and L "Is_Additional_Promo"
            const targetHeader = targetRows[0] && targetRows[0].length >= 12 ? targetRows[0] : [...sourceHeader.slice(0, 10), 'Prix_modifi√©', 'Is_Additional_Promo'];
            newTargetRows.push(targetHeader);

            // Processes all rows from Sheet1 for synchronization into Sheet3
            promoRowsFromSource.forEach(sourceRow => {
                const code = sourceRow[3];
                const existingRow = existingPromosMap.get(code);

                const datePeremption = new Date(sourceRow[1]); // Column B: Expiry Date
                const now = new Date(); // Define now here for local scope
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const diff = (datePeremption.getFullYear() - currentYear) * 12 + (datePeremption.getMonth() - currentMonth);

                let rowToUpdate = existingRow ? [...existingRow] : [...sourceRow];
                // Ensure the row has enough columns if it's new
                while(rowToUpdate.length < 12) rowToUpdate.push('');

                const isCurrentlyAdditional = existingRow && existingRow.length > 11 && existingRow[11] === 'TRUE';

                // --- Handle Percentage (column H, index 7) ---
                if (!isCurrentlyAdditional && (diff === 0 || diff === 1)) {
                    // For automatic promos (current/next month) that are NOT explicitly additional
                    // Always set the default percentage regardless of its current value in Sheet3.
                    rowToUpdate[7] = (diff === 0) ? 50 : 30;
                    console.log(`[SYNC] Setting default percentage for automatic promo ${sourceRow[2]} (code: ${code}): ${rowToUpdate[7]}%`);
                } else if (!isCurrentlyAdditional && diff > 1) {
                    // For regular promos beyond next month that are NOT explicitly additional:
                    // If it had a percentage in existing Sheet3 (manually set), preserve it.
                    // Otherwise (if it came from Sheet1 with a % or was 0/empty), set to 0.
                    if (existingRow && existingRow[7] !== undefined && parseFloat(existingRow[7]) > 0) {
                        rowToUpdate[7] = existingRow[7]; // Preserve manual override
                    } else {
                        rowToUpdate[7] = 0; // Set to 0 if not manually set in Sheet3
                    }
                    console.log(`[SYNC] Setting percentage for regular other month promo ${sourceRow[2]} (code: ${code}): ${rowToUpdate[7]}%`);
                } else {
                    // For additional promos (isCurrentlyAdditional === true), or new items that don't fit auto rules:
                    // Preserve existing Sheet3 value or use Sheet1's value if new.
                    rowToUpdate[7] = existingRow && existingRow[7] !== undefined ? existingRow[7] : sourceRow[7] !== undefined ? sourceRow[7] : '';
                    console.log(`[SYNC] Setting percentage for additional/other promo ${sourceRow[2]} (code: ${code}): ${rowToUpdate[7]}%`);
                }

                // --- Handle Prix_modifi√© (column K, index 10) ---
                if (!rowToUpdate[10] || String(rowToUpdate[10]).trim() === '') {
                    rowToUpdate[10] = sourceRow[9] !== undefined ? sourceRow[9] : '';
                }
                
                // --- Handle Is_Additional_Promo (column L, index 11) ---
                // If it's a new entry, it's FALSE. If existing, preserve its TRUE/FALSE status.
                // The filtering for 'promoRowsFromSource' only includes items from Feuille1 that *have* a promo
                // This implies they are "regular" promos initially. Additional promos are usually *manually added* to Feuille3.
                // So, if we are processing `sourceRow`, it's generally a regular promo.
                // We only set it to 'TRUE' if it was already 'TRUE' in the `existingRow`.
                if (existingRow && existingRow[11] === 'TRUE') {
                    rowToUpdate[11] = 'TRUE';
                } else {
                    rowToUpdate[11] = 'FALSE';
                }
                
                newTargetRows.push(rowToUpdate);
            });

            // Re-add existing additional promos that were NOT sourced from Feuille1
            targetRows.slice(1).forEach(targetRow => {
                const code = targetRow[3];
                const isAdditional = (targetRow.length > 11 && targetRow[11] === 'TRUE');
                // Only add if it's an additional promo AND its code was NOT found in the promoRowsFromSource
                // This prevents duplicates and ensures manually added additional promos persist.
                if (isAdditional && !promoRowsFromSource.some(sr => sr[3] === code)) {
                    newTargetRows.push(targetRow);
                }
            });

            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Feuille3!A1', // Starts updating from A1
                valueInputOption: 'RAW',
                resource: { values: newTargetRows }
            });
            
            console.log("Sheet3 synchronized. Modified prices and additional promos have been preserved.");
        } catch (error) {
            console.error("Synchronization error:", error);
            document.getElementById('status').textContent = `Synchronization error: ${error.message}`;
        }
    }


    // Loads all data from the promotion sheet (Sheet3)
    async function loadAllPromos() {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter d\'abord.';
            return;
        }
        try {
            document.getElementById('status').textContent = 'Chargement des promotions...';

            const resFeuille3 = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: TARGET_RANGE // Sheet3
            });
            const allPromoRows = resFeuille3.result.values || [];

            // IMPORTANT: cleanOldEntries must be called before renderAllPromos for data to be up-to-date
            await cleanOldEntries(allPromoRows); 
            // Re-fetch after cleaning to get the latest state of the sheet
            const resFeuille3AfterClean = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: TARGET_RANGE 
            });
            const cleanedPromoRows = resFeuille3AfterClean.result.values || [];

            const now = new Date(); // Definition of 'now' here
            renderAllPromos(cleanedPromoRows, now); // Pass 'now' to renderAllPromos
            document.getElementById('status').textContent = 'Promotions loaded.';
        } catch (e) {
            document.getElementById('status').textContent = `Loading error: ${e.message}`;
            console.error("Sheet loading error:", e);
        }
    }

    // Function to render a single promo row
    function renderPromoRow(item, targetTbody, isAdditionalTable = false) {
        const tr = document.createElement("tr");
        const tdDate = document.createElement("td"); tdDate.textContent = item.dateStr;
        const tdProduit = document.createElement("td"); tdProduit.textContent = item.produit;
        const tdCode = document.createElement("td"); tdCode.textContent = item.code;
        const tdPrixUnit = document.createElement("td"); tdPrixUnit.textContent = item.prixUnitaire.toFixed(2); tdPrixUnit.contentEditable = true; // Editable unit price
        const tdZone = document.createElement("td"); tdZone.textContent = item.zone;
        const tdQty = document.createElement("td"); tdQty.textContent = item.qty; // Quantity
        
        const tdPercentage = document.createElement("td"); // New editable percentage cell
        tdPercentage.textContent = item.percentage.toFixed(0) + "%"; 
        tdPercentage.contentEditable = true; 
        
        const tdPrixFinal = document.createElement("td"); tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";
        
        // Delete button
        const tdDelete = document.createElement("td");
        tdDelete.innerHTML = '<img src="https://i.imgur.com/oStNoqu.png" style="width:20px; height:20px; cursor:pointer;" title="Delete this row">';
        tdDelete.onclick = async () => {
            const confirmDelete = confirm(`Voulez-vous vraiment supprimer "${item.produit}" ?`);
            if (confirmDelete) {
                await deleteRowFromSheet(TARGET_RANGE, item.originalRowIndex);
            }
        };

        // Event listener for unit price modification (Column K / index 10 in Sheet3)
        tdPrixUnit.addEventListener("blur", async () => {
            const cleaned = tdPrixUnit.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
            const newPrix = parseFloat(cleaned) || 0;
            
            // Updates local object and displayed final price
            item.prixUnitaire = newPrix;
            item.prixFinal = newPrix * (1 - item.percentage / 100); // Uses current percentage
            tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";

            // Saves new value to Column K of Sheet3 (index 11 when using columnToLetter)
            await saveCellToSheet(TARGET_RANGE, item.originalRowIndex, 11, newPrix);
        });

        // Event listener for percentage modification (Column H / index 7 in Sheet3)
        tdPercentage.addEventListener("blur", async () => {
            const cleaned = tdPercentage.textContent.replace(/[^\d.,]/g, '').replace(',', '.');
            const newPct = parseFloat(cleaned) || 0;
            
            // Updates local object and displayed final price
            item.percentage = newPct;
            item.prixFinal = item.prixUnitaire * (1 - newPct / 100); // Uses current unit price
            tdPrixFinal.textContent = item.prixFinal.toFixed(2) + " ‚Ç¨";
            tdPercentage.textContent = newPct.toFixed(0) + "%"; // Updates displayed text

            // Saves new value to Column H of Sheet3 (index 8 when using columnToLetter)
            await saveCellToSheet(TARGET_RANGE, item.originalRowIndex, 8, newPct);
        });

        tr.appendChild(tdDate);
        tr.appendChild(tdProduit);
        tr.appendChild(tdCode);
        tr.appendChild(tdPrixUnit);
        tr.appendChild(tdZone);
        tr.appendChild(tdQty);
        tr.appendChild(tdPercentage); // Now editable
        tr.appendChild(tdPrixFinal);
        tr.appendChild(tdDelete);
        targetTbody.appendChild(tr);
    }

    // Function to add a group of rows to a table
    // isAdditionalTable: true if it's for the additional-promo-table
    function appendGroup(targetTbody, title, group, isThirdMonthFacing = false, isAdditionalTable = false) {
        if (group.length === 0 && !isThirdMonthFacing && !isAdditionalTable) { // Added !isAdditionalTable condition
             // If no items in group and not the special 3rd month message, do not append title
            return;
        }

        const trTitle = document.createElement("tr");
        trTitle.classList.add('group-title-row'); // Adds a class for group titles
        const td = document.createElement("td");
        td.colSpan = 9; // Adjusted for 9 columns
        td.textContent = title;
        trTitle.appendChild(td);
        targetTbody.appendChild(trTitle);

        group.forEach(item => {
            renderPromoRow(item, targetTbody, isAdditionalTable);
        });

        if (isThirdMonthFacing && facingCount > 0) {
            const finalRow = document.createElement("tr");
            const tdFacing = document.createElement("td");
            tdFacing.colSpan = 9; // Adjusted for 9 columns
            tdFacing.style = "font-style: italic; text-align:left; padding-top:10px; background:#f0f8ff;";
            tdFacing.textContent = `Les ${facingCount} produits du 3·µâ mois doivent √™tre mis en avant dans les rayons. ‚ùó`;
            finalRow.appendChild(tdFacing);
            targetTbody.appendChild(finalRow);
        }
    }


    // Renders all promotion categories
    function renderAllPromos(allPromoRows, now) { // 'now' is now a parameter
        const tbodyMain = document.querySelector("#data-table tbody");
        const tbodyAdditional = document.querySelector("#additional-promo-table tbody");
        const additionalPromoSection = document.getElementById('additional-promo-section');

        tbodyMain.innerHTML = ""; // Clear existing content of main table
        tbodyAdditional.innerHTML = ""; // Clear existing content of additional table
        additionalPromoSection.style.display = 'none'; // Hide additional section by default
        
        let moisEnCours = [];
        let moisSuivant = [];
        let additionalPromos = []; // List for additional promotions
        let facingCount = 0; // Counter for 3rd month products to highlight

        // Skip header row
        const dataRows = allPromoRows.slice(1);

        dataRows.forEach((row, index) => {
            // Ensures the row has enough columns (at least 12 for Is_Additional_Promo)
            if (row.length < 12) { 
                // Pads the row with empty strings if it's too short
                while(row.length < 12) row.push('');
            }

            const originalRowIndex = index + 2; // 1-based row index in the spreadsheet

            const produit = row[2] || ''; // Column C
            const code = row[3] || ''; // Column D
            const zone = row[5] || ''; // Column F
            const qty = row[4] || ''; // Column E (Quantity)
            let percentageFromSheet = parseFloat((row[7] || "0").replace(/[^\d.,]/g, '').replace(',', '.')) || 0; // Column H (% Promo)
            const prixUnitaire = parseFloat((row[10] || "").replace(/[^\d.,]/g, '').replace(',', '.')) || parseFloat((row[9] || "0").replace(/[^\d.,]/g, '').replace(',', '.')) || 0; // Column K (Modified Price) or J (Unit Price Sheet1)

            let percentageToDisplay = percentageFromSheet;
            let prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);

            const dateStr = row[1];
            const date = new Date(dateStr);
            // 'now' is already available via the function parameter
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const diff = (date.getFullYear() - currentYear) * 12 + (date.getMonth() - currentMonth);

            const isAdditionalFlag = (row[11] === 'TRUE'); // Checks the flag for additional promo
            console.log(`[RENDER] Produit: ${produit}, isAdditionalFlag: ${isAdditionalFlag}, PourcentageFeuille: ${percentageFromSheet}`); // Debug log

            // Categorizes by month (Month 1, Month 2, or Month 3) if it's NOT an explicit additional promo
            if (!isNaN(date.getTime()) && !isAdditionalFlag) {
                if (diff === 0) { // Current month
                    if (percentageFromSheet === 0 || isNaN(percentageFromSheet)) {
                        percentageToDisplay = 50; 
                    }
                    prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);
                    moisEnCours.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                    console.log(`[RENDER] --> Class√© comme promo automatique (Mois en cours). Pourcentage affich√©: ${percentageToDisplay}`);
                } else if (diff === 1) { // Next month
                    if (percentageFromSheet === 0 || isNaN(percentageFromSheet)) {
                        percentageToDisplay = 30; 
                    }
                    prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);
                    moisSuivant.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                    console.log(`[RENDER] --> Class√© comme promo automatique (Mois suivant). Pourcentage affich√©: ${percentageToDisplay}`);
                } else if (diff === 2) { // 3rd month (Facing)
                    facingCount++; 
                    console.log(`[RENDER] --> Class√© comme produit 3e mois √† mettre en avant.`);
                } else {
                    // This case handles regular promos whose date is beyond month+2 but are not additional.
                    // Their percentage should be displayed as is from Sheet3 or 0 if it was from Feuille1 with a non-default.
                    // The percentage for these items is already handled by synchronizeSheets.
                    moisSuivant.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                    console.log(`[RENDER] --> Class√© comme autre promo automatique (date > M+1). Pourcentage affich√©: ${percentageToDisplay}`);
                }
            } else if (isAdditionalFlag && percentageFromSheet > 0) {
                // If it's an explicit additional promo and the percentage is > 0
                // The percentage to display is taken from the sheet, no automatic default here
                percentageToDisplay = percentageFromSheet; 
                prixFinalCalculated = prixUnitaire * (1 - percentageToDisplay / 100);
                additionalPromos.push({ dateStr, produit, code, prixUnitaire, zone, qty, percentage: percentageToDisplay, prixFinal: prixFinalCalculated, originalRowIndex });
                console.log(`[RENDER] --> Class√© comme PROMO SUPPL√âMENTAIRE. Pourcentage: ${percentageToDisplay}`);
            } else {
                console.log(`[RENDER] --> Non class√© (isAdditionalFlag: ${isAdditionalFlag}, pourcentage: ${percentageFromSheet}). Ignor√© de l'affichage principal.`);
            }
        });
        
        // Sort current and next month promos by date
        moisEnCours.sort((a, b) => new Date(a.dateStr) - new Date(b.dateStr));
        moisSuivant.sort((a, b) => new Date(a.dateStr) - new Date(b.dateStr));
        // Sort additional promos by product name
        additionalPromos.sort((a, b) => a.produit.localeCompare(b.produit));

        // Function to format month and year for titles
        function formatMonthYear(date) {
            return date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
        }

        // Render automatic promotions (Current month, Next month, and 3rd month message)
        appendGroup(tbodyMain, `üì¶ Mois en cours (50% par d√©faut) - ${formatMonthYear(now)}`, moisEnCours);
        const nextMonthDate = new Date();
        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
        appendGroup(tbodyMain, `üì¶ Mois suivant (30% par d√©faut) - ${formatMonthYear(nextMonthDate)}`, moisSuivant);
        // Special row for 3rd month "facing" products
        if (facingCount > 0) {
            const finalRow = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 9; 
            td.style = "font-style: italic; text-align:left; padding-top:10px; background:#f0f8ff;";
            td.textContent = `Les ${facingCount} produits du 3·µâ mois doivent √™tre mis en avant dans les rayons. ‚ùó`;
            finalRow.appendChild(td);
            tbodyMain.appendChild(finalRow); // Append to main tbody
        }

        // Render "Additional Promotions" if any
        if (additionalPromos.length > 0) {
            additionalPromoSection.style.display = 'block'; // Show the section if products exist
            console.log(`[RENDER] Affichage de la section promotions suppl√©mentaires. Total promos suppl√©mentaires: ${additionalPromos.length}`); // Debug log
            // There is no month grouping for this section, just the list
            additionalPromos.forEach(item => {
                renderPromoRow(item, tbodyAdditional, true); // Use tbodyAdditional for this section
            });
        } else {
            console.log("[RENDER] Aucune promotion suppl√©mentaire √† afficher. La section restera masqu√©e.");
        }

        document.getElementById("status").textContent = 'Donn√©es de promotions charg√©es et tri√©es.';
    }

    // Generic function to save a cell to any sheet
    async function saveCellToSheet(rangePrefix, rowIndex, colIndex, newValue) {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter pour sauvegarder.';
            return;
        }
        const sheetName = rangePrefix.split('!')[0]; // Extracts sheet name (e.g., "Feuille3")
        
        try {
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${sheetName}!${columnToLetter(colIndex)}${rowIndex}`,
                valueInputOption: 'RAW',
                resource: { values: [[newValue]] }
            });
            console.log(`Cellule mise √† jour dans ${sheetName} (ligne ${rowIndex}, colonne ${colIndex})`);
            document.getElementById('status').textContent = `Cellule mise √† jour dans ${sheetName}.`;
        } catch (error) {
            console.error(`Erreur lors de la mise √† jour de la cellule dans ${sheetName}:`, error);
            document.getElementById('status').textContent = `Erreur lors de la sauvegarde dans ${sheetName}.`;
        }
    }

    // Function to delete a row from the sheet (Sheet3)
    async function deleteRowFromSheet(rangePrefix, rowIndex) {
        if (!accessToken) {
            document.getElementById('status').textContent = 'Veuillez vous connecter pour supprimer.';
            return;
        }
        const sheetName = rangePrefix.split('!')[0];
        try {
            // Read all data first
            const res = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: sheetName // Get all data from the sheet
            });
            let rows = res.result.values || [];

            // Remove the row at the specified index (adjusting for header and 0-based array)
            // rowIndex from render function is 1-based (starts at 2 for data rows)
            // So, for 0-based array, it's rowIndex - 1
            if (rowIndex > 0 && rowIndex <= rows.length) {
                rows.splice(rowIndex - 1, 1); // Remove 1 row at (rowIndex - 1)
            } else {
                console.error("Invalid row index for deletion:", rowIndex);
                document.getElementById('status').textContent = "Error: Invalid row index for deletion.";
                return;
            }

            // Write the modified data back to the sheet
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${sheetName}!A1`, // Start writing from A1
                valueInputOption: 'RAW',
                resource: { values: rows }
            });
            document.getElementById('status').textContent = `Ligne supprim√©e de ${sheetName}.`;
            await loadAllPromos(); // Reload to reflect changes
        } catch (error) {
            console.error(`Erreur lors de la suppression de la ligne dans ${sheetName}:`, error);
            document.getElementById('status').textContent = `Erreur lors de la suppression: ${e.message}`;
        }
    }


    // Converts numeric column index to letter (1->A, 2->B...)
    function columnToLetter(column) {
        let temp, letter = '';
        while(column > 0) {
            temp = (column - 1) % 26;
            letter = String.fromCharCode(temp + 65) + letter;
            column = (column - temp - 1) / 26;
        }
        return letter;
    }

    // Cleans old entries (only applies to regular promos in Sheet3)
    async function cleanOldEntries(allRows) {
        const now = new Date(); // Definition of 'now' here for this function
        const header = allRows[0];
        
        // Filters rows to keep:
        // 1. The header row
        // 2. Rows that are NOT additional promos (row[11] is not 'TRUE') AND have a future or current date
        // 3. Rows that ARE additional promos (row[11] is 'TRUE') regardless of date (as they are manually managed)
        const filteredRows = allRows.filter((row, i) => {
            if (i === 0) return true; // Always keep the header row
            if (row.length < 12) { // If row is too short, treat as regular promo for cleaning purposes
                const datePeremption = new Date(row[1]); // Date is in column B (index 1)
                return !isNaN(datePeremption.getTime()) && datePeremption >= now;
            }
            const isAdditional = (row[11] === 'TRUE');
            if (isAdditional) {
                return true; // Keep additional promos regardless of date
            } else {
                const datePeremption = new Date(row[1]); // Date is in column B (index 1)
                return !isNaN(datePeremption.getTime()) && datePeremption >= now;
            }
        });

        // If rows were removed, update the sheet.
        if (filteredRows.length !== allRows.length) {
            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: TARGET_RANGE, // Update all of Sheet3
                    valueInputOption: 'RAW',
                    resource: { values: filteredRows }
                });
                console.log("Automatic cleaning performed (Sheet3) for regular promos.");
            } catch (error) {
                console.error("Error cleaning Sheet3:", error);
                document.getElementById('status').textContent = `Error during automatic cleaning: ${error.message}`;
            }
        } else {
             console.log("No old regular promotion entries to clean in Sheet3.");
        }
    }

    // Initial loading of Google APIs
    window.onload = () => {
        gapiLoaded();
        gisLoaded();
    };
</script>
<footer style="
    position: fixed;
    bottom: 0;
    width: 100%;
    text-align: center;
    font-size: 0.6em;
    color: #666;
    background: #bfdbc4;
    padding: 8px 0;
    box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
    z-index: 10;
">
    D√©velopp√© par Violaine Claron - Mise √† jour
</footer>
</body>
</html>

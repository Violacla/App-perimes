<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>Gestion P√©rim√© - Pharmacie du Libron</title>
    <script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        .autocomplete-list {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 150px;
            overflow-y: auto;
            width: 250px;
            z-index: 999;
        }

        .autocomplete-list li {
            padding: 8px 10px;
            cursor: pointer;
            color: black;
        }

        .autocomplete-list li:hover,
        .autocomplete-list li.active {
            background-color: #bcd7ed;
            color: white;
        }

        :root {
            --bleu-glacial: #bcd7ed;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #fffefc;
        }

        header {
            background-color: var(--bleu-glacial);
            color: #163f5b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        #header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        #header-left > h1 {
            margin: 0;
            font-size: 1.3em;
        }

        button {
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            color: black;
            padding: 6px 10px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .icon {
            font-size: 1.2em;
            margin-right: 6px;
        }

        #header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #operator-form {
            margin-left: 10px;
        }

        main {
            display: flex;
            margin: 20px;
        }

        #entry-form {
            width: 320px;
            background: #f294a6;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-left: 20px;
            margin-top: 48px;
        }

        #entry-form h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: normal;
        }

        #entry-form input {
            background-color: #e1f4e4;
            width: 100%;
            margin: 6px 0;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #entry-form button {
            width: 100%;
            background-color: #bfdbc4;
            color: black;
            font-weight: bold;
            margin-top: 10px;
        }

        #entry-form button:hover {
            background-color: #86bf8e;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px 10px;
            text-align: center;
        }

        tbody tr:nth-child(odd) {
            background-color: #ede2e6;
        }

        tbody tr.selected {
            background-color: #f2b4bb !important;
        }

        tbody td {
            cursor: text;
        }

        #filters {
            margin: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        #filters label {
            font-weight: bold;
            color: #86bf8e;
        }
        
        #filters input,
        #filters button {
            padding: 5px 8px;
            font-size: 1em;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        #filters button {
            background-color: #bfdbc4;
            color: black;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        #filters button:hover {
            background-color: #86bf8e;
            color: white;
        }

        #status {
            margin: 10px 20px;
            font-weight: bold;
            color: #0a2f51;
        }
        
        #notification-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            width: 1300px;
            max-height: 92vh;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            flex-direction: column;
        }
        
        #notification-popup header {
            display: flex;
            justify-content: space-between;
            align-items: right;
            padding: 10px 20px;
            background-color: var(--bleu-glacial);
            color: #163f5b;
            border-radius: 10px 10px 0 0;
        }
        
        #notif-tabs {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .tab-button {
            background-color: transparent;
            color: #163f5b;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
            text-align: right;
            border-radius: 5px 5px 0 0;
        }
        
        .tab-button:hover,
        .tab-button.active {
            background-color: #85b9dd;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 15px;
            overflow-y: auto;
            max-height: calc(92vh - 80px);
            color: black;
        }
        
        .tab-content h3 {
            text-align: left;
            color: black;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .ligne-vendue td {
            text-decoration: line-through;
            background-color: #d8c0ca !important;
            color: #efe8eb;
        }

        @media print {
            body > :not(#notification-popup) {
                display: none;
            }
            
            #notification-popup {
                position: static !important;
                transform: none !important;
                top: auto !important;
                left: auto !important;
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                border-radius: 0 !important;
                display: block !important;
            }
            
            #notification-popup .tab-content:not(.active) {
                display: none !important;
            }
            
            #notification-popup #notif-tabs,
            #notification-popup .header-buttons {
                display: none !important;
            }
            
            html,
            body {
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            #notification-popup .tab-content,
            #notification-popup .content {
                max-height: none !important;
                overflow: visible !important;
            }
        }
        
        #date-error {
            display: none;
            background-color: white;
            color: #87c08f;
            padding: 10px;
            margin: 10px 0;
            border: 3px solid #87c08f;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            font-size: 2.5em;
            max-width: 90%;
            margin: 0 auto 10px auto;
        }
        
        #update-overlay {
            position: fixed;
            top: 60px;
            left: 0;
            width: 100%;
            height: calc(100% - 60px);
            background-color: rgba(188, 215, 237, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        #update-popup {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.25);
            max-width: 600px;
            text-align: center;
            font-size: 1.1em;
        }

        #update-popup h2 {
            margin-top: 0;
            color: #87c08f;
        }

        #update-popup ul {
            list-style: none;
            padding-left: 0;
            text-align: left;
            margin-bottom: 20px;
        }

        #update-popup ul li::before {
            content: "üîπ ";
        }

        #update-logo {
            display: block;
            margin: 20px auto 0 auto;
            width: 70px;
            height: auto;
        }

        #btn-login {
            background-color: #0a2f51;
            color: #bcd7ed;
            font-weight: bold;
            padding: 12px 24px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        #btn-login:hover {
            background-color: #083049;
            transform: translateY(-2px);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<header>
    <div id="header-left">
        <a href="/index.html" style="display:inline-block; width:40px; height:40px; border-radius:50%; overflow:hidden; border:0px solid #0a2f51;" title="Accueil">
            <img alt="Logo" src="https://i.imgur.com/AExTPc7.png" style="width:100%; height:100%; object-fit:cover;"/>
        </a>
        <h1>Gestion P√©rim√© - Pharmacie du Libron</h1>
        <div id="operator-form" style="display:none; margin-left:10px;">
            <input id="operator" placeholder="Nom de l'op√©rateur" type="text"/>
            <button id="btn-confirm-operator">Valider</button>
        </div>
        <button id="btn-login" style="display:inline-block; margin-left:10px;">Se connecter</button>
    </div>
    <div id="header-right">
        <button id="btn-notif" style="position: relative; display: inline-flex; align-items: center; gap: 5px;" title="Notifications">
            <span style="position: relative; display: inline-block; width: 18px; height: 18px;">
                <img alt="Logo" src="https://i.imgur.com/em9h9Wk.png" style="width: 100%; height: 100%; object-fit: cover; vertical-align: middle;"/>
                <span id="notif-badge" style="display: none; position: absolute; top: 0px; right: 0px; width: 20px; height: 20px; z-index: 2;">
                    <img src="https://i.imgur.com/EIvT5ot.png" style="width: 100%; height: 100%; object-fit: cover;"/>
                </span>
            </span>
            Suivi P√©rim√©s
        </button>
        <button onclick="location.href='historique.html'" title="Historique">
            <img alt="Historique" src="https://i.imgur.com/BasLkpT.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            Historique
        </button>
        <button onclick="location.href='promotion.html'" title="Promo %">
            % Promo
        </button>
        <button id="btn-open-my-pdf" title="Ouvrir mon PDF personnalis√©">
            <img src="https://i.imgur.com/kGXfRUa.png" style="width:18px; height:18px; vertical-align:middle;"/>
        </button>
        <button id="btn-logout" style="display:none;" title="D√©connexion">
            <img alt="D√©connexion" src="https://i.imgur.com/OPA1EuF.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
            D√©connexion
        </button>
    </div>
</header>
<main>
    <div style="flex-grow:1;">
        <div id="filters">
            <div>
                <label for="filter-product">Nom produit</label>
                <input type="text" id="filter-product" placeholder="Nom..." oninput="filterTable()"/>
            </div>
            <div>
                <label for="filter-code">Code</label>
                <input type="text" id="filter-code" placeholder="Code..." oninput="filterTable()"/>
            </div>
            <div>
                <label for="filter-zone">Zone</label>
                <input id="filter-zone" placeholder="Ex: Zone A" type="text" oninput="filterTable()"/>
            </div>
            <div>
                <label for="filter-month">Date</label>
                <input id="filter-month" placeholder="MM/YYYY ou YYYY" style="width: 140px;" type="text" oninput="filterTable()"/>
            </div>
            <button onclick="clearFilter()">R√©initialiser</button>
            <button id="btn-print-table" title="EXPORTER EN PDF">
                <img src="https://i.imgur.com/WbH9qyS.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
                PDF
            </button>
            <ul class="autocomplete-list" id="filter-zone-suggestions" style="display: none;"></ul>
        </div>
        <div style="max-height: 400px; overflow-y: auto; border-radius: 6px; margin-top: 10px;">
            <table aria-label="Donn√©es des produits p√©rim√©s" id="data-table" tabindex="0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Produit</th>
                        <th>Code</th>
                        <th>Qt√©</th>
                        <th>Zone</th>
                        <th>Vendues</th>
                        <th>Promo</th>
                        <th>Suppr</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <pre id="status"></pre>
    </div>
    <form id="entry-form" onsubmit="return false;" style="display: none;">
        <h3>Ajouter un produit</h3>
        <input id="date" placeholder="MM/YYYY" type="text"/>
        <div id="date-error">DATE<br>INVALIDE</div>
        <input id="product" placeholder="Nom Bo√Æte" type="text"/>
        <input id="code" maxlength="6" minlength="6" pattern="\d{6}" placeholder="Code (6 chiffres)" required="" type="text"/>
        <input id="qty" min="0" placeholder="Nb Bo√Ætes" type="number"/>
        <input autocomplete="off" id="zone" placeholder="Zone" type="text"/>
        <ul class="autocomplete-list" id="zone-suggestions" style="display: none;"></ul>
        <button id="btn-add" type="button">Ajouter la ligne</button>
    </form>
</main>
<body>
    <div id="update-overlay">
        <div id="update-popup">
            <h2>Mise √† jour - 07/08/2025</h2>
            <ul>
                <li>Nouvelles fonctionnalit√©s : </li>
                <li>1. Le bouton " Notification " s'appelle d√©sormais " Suivi P√©rim√©s " : <br>
                Il s'ouvre toujours de la m√™me mani√®re, mais contient maintenant 3 onglets : <br>
                - " Trimestre " => Affiche les produits qui p√©rimeront dans les 3 prochains mois.<br>
                - " 2√®me Mois " => Affiche le mois "central" du trimestre (ex : Octobre si nous sommes en Ao√ªt) <br>
                - " √Ä retirer " => Affiche les produits p√©rim√©s le mois pr√©c√©dent, √† retirer des rayons.<br>
                Vous pouvez imprimer les tableaux avec le bouton imprimante. </li>
                <li>2.La v√©rification des dates a √©t√© am√©lior√©e : un message s‚Äôaffiche si la date saisie est ant√©rieure √† aujourd‚Äôhui.</li>
                <li>3. Cette fen√™tre de mise √† jour s‚Äôaffiche uniquement au d√©marrage, et dispara√Æt automatiquement apr√®s avoir cliqu√© sur ‚ÄúSe connecter‚Äù. </li>
                <li>4. Un icone " ? " est apparu √† c√¥t√© de " % promo ", il ouvre une page google drive qui permet d'√©changer en direct. Il y aussi un descriptif des diff√©rentes fonctionnalit√©s de l'application </li>
                <li>N‚Äôh√©sitez pas √† me faire part de vos suggestions ou remarques pour continuer √† am√©liorer l‚Äôapplication.<br>
                <em>Violaine</em> </li>
            </ul>
            <img src="https://i.imgur.com/yqzUg16.png" alt="Logo Mises √† jour" id="update-logo">
        </div>
    </div>
    <div aria-labelledby="notif-title" aria-modal="true" id="notification-popup" role="dialog" style="display: none;">
        <header style="display: flex; align-items: center; gap: 20px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <span id="notif-title"> Produits p√©rim√©s</span>
                <div id="notif-tabs" style="margin: 0;">
                    <button class="tab-button active" onclick="showTab('trimestre')">Trimestre</button>
                    <button class="tab-button" onclick="showTab('2nd-month')">2√®me mois</button>
                    <button class="tab-button" onclick="showTab('current-month')">√Ä retirer</button>
                </div>
            </div>
            <div class="header-buttons" style="margin-left: auto;">
                <button id="print-notif" title="Imprimer">
                    <img src="https://i.imgur.com/qY1buNb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
                </button>
                <button id="close-notif" title="Fermer">
                    <img src="https://i.imgur.com/7NKMuZy.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
                </button>
            </div>
        </header>
        <div class="content">
            <div id="trimestre" class="tab-content active"></div>
            <div id="2nd-month" class="tab-content"></div>
            <div id="current-month" class="tab-content"></div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const badge = document.getElementById('notif-badge');
            const btnNotif = document.getElementById('btn-notif');
            const now = new Date();
            const monthKey = `${now.getFullYear()}-${now.getMonth()+1}`;
            if (now.getDate() >= 15 && localStorage.getItem('notifSeen') !== monthKey) {
                badge.style.display = 'inline-block';
            }
            btnNotif.addEventListener('click', () => {
                badge.style.display = 'none';
                localStorage.setItem('notifSeen', monthKey);
            });

            const operatorInput = document.getElementById('operator');
            const btnOperator = document.getElementById('btn-confirm-operator');
            if (operatorInput && btnOperator) {
                operatorInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        btnOperator.click();
                    }
                });
            }
        });
    </script>
    <script>
        let allData = [];
        const zones = ['1', '2', '3'];
    </script>
    <script>
        document.getElementById("btn-print-table").addEventListener("click", async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 10;
            const productFilter = document.getElementById("filter-product").value;
            const codeFilter = document.getElementById("filter-code").value;
            const zoneFilter = document.getElementById("filter-zone").value;
            const monthFilter = document.getElementById("filter-month").value;

            doc.setFontSize(14);
            doc.text("R√©sultats filtr√©s - Produits p√©rim√©s", 10, y);
            y += 10;
            doc.setFontSize(10);
            doc.text(`Produit : ${productFilter || "Tous"}`, 10, y);
            y += 6;
            doc.text(`Code : ${codeFilter || "Tous"}`, 10, y);
            y += 6;
            doc.text(`Zone : ${zoneFilter || "Toutes"}`, 10, y);
            y += 6;
            doc.text(`Mois : ${monthFilter || "Tous"}`, 10, y);
            y += 10;

            const rows = document.querySelectorAll("#data-table tbody tr");
            rows.forEach((row) => {
                if (row.style.display === "none") return;

                const cells = Array.from(row.children).slice(0, 6).map(td => td.textContent.trim());
                doc.text(cells.join(" | "), 10, y);
                y += 6;
                if (y > 280) {
                    doc.addPage();
                    y = 10;
                }
            });

            doc.save("resultats_perimes.pdf");
        });
    </script>
    <script>
        const filterInput = document.getElementById('filter-zone');
        const suggestionList = document.getElementById('filter-zone-suggestions');

        filterInput.addEventListener('input', function () {
            const val = this.value.toLowerCase();
            suggestionList.innerHTML = '';
            if (val.length < 1) {
                suggestionList.style.display = 'none';
                return;
            }

            const matches = zones.filter(z => z.toLowerCase().includes(val));
            if (matches.length === 0) {
                suggestionList.style.display = 'none';
                return;
            }

            matches.forEach((zone) => {
                const li = document.createElement('li');
                li.textContent = zone;
                li.addEventListener('click', () => {
                    filterInput.value = zone;
                    suggestionList.innerHTML = '';
                    suggestionList.style.display = 'none';
                    filterTable();
                });
                suggestionList.appendChild(li);
            });

            const rect = filterInput.getBoundingClientRect();
            suggestionList.style.top = rect.bottom + window.scrollY + 'px';
            suggestionList.style.left = rect.left + window.scrollX + 'px';
            suggestionList.style.width = filterInput.offsetWidth + 'px';
            suggestionList.style.display = 'block';
        });

        document.addEventListener('click', function (e) {
            if (!filterInput.contains(e.target) && !suggestionList.contains(e.target)) {
                suggestionList.style.display = 'none';
            }
        });
    </script>
    <script>
        async function deleteRow(rowIndex) {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            deleteDimension: {
                                range: {
                                    sheetId: 0,
                                    dimension: "ROWS",
                                    startIndex: rowIndex - 1,
                                    endIndex: rowIndex
                                }
                            }
                        }]
                    }
                });
                setStatus("Ligne supprim√©e avec succ√®s.");
                loadSheet();
            } catch (e) {
                setStatus("Erreur suppression : " + e.message);
            }
        }
    </script>
    <script>
        const filterMonthInput = document.getElementById('filter-month');
        filterMonthInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^\d\/]/g, '');
        });
    </script>
    <script>
        function filterTable() {
            const tbody = document.querySelector("#data-table tbody");
            const productFilter = document.getElementById("filter-product").value.trim().toLowerCase();
            const codeFilter = document.getElementById("filter-code").value.trim().toLowerCase();
            const zoneFilter = document.getElementById("filter-zone").value.trim().toLowerCase();
            const monthFilter = document.getElementById("filter-month").value.trim();

            const rows = document.querySelectorAll("#data-table tbody tr");
            let visibleRowsCount = 0;

            rows.forEach((row) => {
                const productCell = row.cells[1].textContent.trim().toLowerCase();
                const codeCell = row.cells[2].textContent.trim().toLowerCase();
                const zoneCell = row.cells[4].textContent.trim().toLowerCase();
                const dateCell = row.cells[0].textContent.trim();

                let show = true;

                if (productFilter && !productCell.includes(productFilter)) {
                    show = false;
                }

                if (codeFilter && !codeCell.includes(codeFilter)) {
                    show = false;
                }

                if (zoneFilter && !zoneCell.includes(zoneFilter)) {
                    show = false;
                }

                if (monthFilter) {
                    let rowYear = '';
                    let rowMonth = '';
                    if (dateCell.includes('-')) {
                        const parts = dateCell.split('-');
                        if (parts.length >= 2) {
                            rowYear = parts[0];
                            rowMonth = parts[1];
                        }
                    }
                    let mFilter = null;
                    let yFilter = null;
                    if (/^\d{2}\/\d{4}$/.test(monthFilter)) {
                        [mFilter, yFilter] = monthFilter.split('/');
                    } else if (/^\d{6}$/.test(monthFilter)) {
                        mFilter = monthFilter.slice(0, 2);
                        yFilter = monthFilter.slice(2);
                    } else if (/^\d{4}$/.test(monthFilter)) {
                        yFilter = monthFilter;
                    }

                    if (yFilter && rowYear !== yFilter) show = false;
                    if (mFilter && rowMonth !== mFilter) show = false;
                }
                
                if (show) {
                    row.style.display = "";
                    visibleRowsCount++;
                } else {
                    row.style.display = "none";
                }
            });

            setStatus(`Affichage de ${visibleRowsCount} lignes sur ${allData.length}.`);
        }

        function clearFilter() {
            document.getElementById('filter-product').value = '';
            document.getElementById('filter-code').value = '';
            document.getElementById('filter-zone').value = '';
            document.getElementById('filter-month').value = '';
            filterTable();
        }
    </script>
    <script>
        const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
        const RANGE = 'Feuille1!A:I';
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
        let tokenClient, gapiInited = false, gisInited = false, accessToken = null, operatorName = null;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    document.getElementById('operator-form').style.display = 'inline-flex';
                    document.getElementById('btn-login').style.display = 'none';
                    setStatus('Connect√©. Choisissez un op√©rateur.');
                    document.getElementById('operator').focus();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('btn-login').style.display = 'inline-block';
            }
        }

        function setStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        document.getElementById('btn-login').onclick = () => {
            tokenClient.requestAccessToken();
        };

        document.getElementById('btn-logout').onclick = () => {
            accessToken = null;
            operatorName = null;
            document.getElementById('btn-login').style.display = 'inline-block';
            document.getElementById('btn-logout').style.display = 'none';
            document.getElementById('operator-form').style.display = 'none';
            document.getElementById('entry-form').style.display = 'none';
            clearTable();
            setStatus('D√©connect√©.');
        };

        document.getElementById('btn-confirm-operator').onclick = () => {
            const op = document.getElementById('operator').value;
            if (!op) return alert("Choisir un op√©rateur");
            operatorName = op;
            document.getElementById('operator-form').style.display = 'none';
            document.getElementById('btn-logout').style.display = 'inline-block';
            document.getElementById('entry-form').style.display = 'block';
            loadSheet();
        };

        document.getElementById('btn-add').onclick = async () => {
            if (!operatorName) {
                alert("Veuillez vous connecter et choisir un op√©rateur");
                return;
            }

            let rawDate = document.getElementById('date').value;
            let dateVal = "";
            if (rawDate) {
                const [month, year] = rawDate.split('/');
                if (month && year) {
                    const paddedMonth = month.padStart(2, '0');
                    const lastDay = new Date(year, parseInt(paddedMonth), 0).getDate();
                    dateVal = `${year}-${paddedMonth}-${lastDay}`;
                }
            }
            if (!dateVal) {
                const today = new Date();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const y = today.getFullYear();
                const d = new Date(y, today.getMonth() + 1, 0).getDate();
                dateVal = `${y}-${m}-${d}`;
            }

            const productVal = document.getElementById('product').value.trim();
            const qtyVal = parseInt(document.getElementById('qty').value);
            const zoneVal = document.getElementById('zone').value.trim();
            if (!zones.includes(zoneVal)) {
                alert("Veuillez choisir une zone existante dans la liste.");
                return;
            }

            const codeVal = document.getElementById('code').value.trim();
            if (!/^\d{6}$/.test(codeVal)) {
                alert("Le code doit contenir exactement 6 chiffres.");
                return;
            }

            const soldVal = 0;
            const promoVal = 0;
            
            if (!productVal || isNaN(qtyVal) || !zoneVal || isNaN(soldVal) || isNaN(promoVal)) {
                alert("Veuillez remplir tous les champs correctement.");
                return;
            }

            const now = new Date();
            const ajoutVal = now.toLocaleString('fr-FR');

            const values = [
                [
                    operatorName,
                    dateVal,
                    productVal,
                    codeVal,
                    qtyVal,
                    zoneVal,
                    soldVal,
                    promoVal,
                    ajoutVal
                ]
            ];
            
            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE,
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values
                    }
                });
                setStatus('Ligne ajout√©e avec succ√®s !');
                document.getElementById('date').value = '';
                document.getElementById('product').value = '';
                document.getElementById('code').value = '';
                document.getElementById('qty').value = '';
                document.getElementById('zone').value = '';
                loadSheet();
            } catch (e) {
                setStatus('Erreur : ' + e.message);
            }
        };

        window.onload = () => {
            gapiLoaded();
            gisLoaded();
        };

        function clearTable() {
            const tbody = document.querySelector("#data-table tbody");
            tbody.innerHTML = '';
        }

        async function loadSheet() {
            if (!gapi.client.getToken()) {
                setStatus('Veuillez vous connecter.');
                return;
            }
            
            try {
                setStatus('Chargement des donn√©es...');
                const res = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE
                });
                allData = res.result.values || [];
                if (allData.length > 0) {
                    allData = allData.slice(1);
                }
                renderTable(allData);
            } catch (e) {
                setStatus('Erreur de chargement des donn√©es: ' + e.message);
            }
        }
        
        function renderTable(data) {
            const tbody = document.querySelector("#data-table tbody");
            tbody.innerHTML = "";
            
            if (data.length === 0) {
                setStatus('Aucune donn√©e √† afficher.');
                return;
            }
            
            data.forEach((row, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>${row[3] || ''}</td>
                    <td>${row[4] || ''}</td>
                    <td>${row[5] || ''}</td>
                    <td>${row[6] || ''}</td>
                    <td>${row[7] || ''}</td>
                    <td><button onclick="deleteRow(${index + 2})">Suppr</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            setStatus(`Affichage de ${data.length} lignes.`);
            filterTable();
        }
    </script>
</body>
</html>

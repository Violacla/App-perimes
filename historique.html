<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Historique des produits p√©rim√©s</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    :root { --bleu-glacial: #bcd7ed; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f9f9f9;
    }
    header {
  background-color: var(--bleu-glacial);
  color: #0a2f51;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px; /* plus compact */
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

    #header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    #header-left a {
      display:inline-block;
      width:40px; height:40px;
      border-radius:50%;
      overflow:hidden;
      border:2px solid #0a2f51;
    }
    #header-left img {
      width:100%; height:100%; object-fit:cover;
    }
    #header-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    #header-right button {
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 1em;
      color: #0a2f51;
      padding: 6px 10px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    #header-right button:hover {
      background-color: rgba(255 255 255 / 0.3);
    }
    #filters {
      display: flex;
      gap: 15px;
      margin: 20px;
      align-items: flex-end;
    }
    #filters input, #filters button {
      padding: 5px 8px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #filters button {
      background-color: var(--bleu-glacial);
      color: #0a2f51;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    table {
      width: calc(100% - 40px);
      margin: 20px;
      border-collapse: collapse;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: center;
    }
    tbody tr:nth-child(odd) {
      background-color: rgba(188, 215, 237, 0.15);
    }

    /* Popup notifications */
    #notification-popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
      width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 9999;
      display: none;
      flex-direction: column;
    }
    #notification-popup header {
      background-color: var(--bleu-glacial);
      color: #0a2f51;
      font-weight: bold;
      padding: 12px 20px;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #notification-popup header button {
      background: transparent;
      border: none;
      font-size: 1.4em;
      cursor: pointer;
      color: #0a2f51;
    }
    #notification-popup .content {
      padding: 15px 20px;
    }
  </style>
</head>
<body>

<header>
  <div id="header-left">
    <a href="index.html" title="Accueil">
      <img src="https://raw.githubusercontent.com/ton-utilisateur/ta-bibliotheque/main/logo.png" alt="Logo">
    </a>
    <h1>Historique des produits p√©rim√©s</h1>
  </div>
  <div id="header-right">
    <button id="btn-notif" title="Notifications">üîî Notifications</button>
    <button onclick="location.href='index.html'" title="Retour √† l'accueil">‚Ü©Ô∏è Retour</button>
  </div>
</header>

<section id="filters">
  <label>Zone:</label>
  <input type="text" id="filter-zone" placeholder="Zone A" />
  <label>Mois:</label>
  <input type="month" id="filter-month" />
  <button onclick="applyFilters()">Filtrer</button>
  <button onclick="resetFilters()">R√©initialiser</button>
</section>

<table id="history-table">
  <thead>
    <tr>
      <th>Produit</th><th>Date</th><th>Qt√©</th><th>Zone</th><th>Vendues</th><th>Promo</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="6">Chargement...</td></tr>
  </tbody>
</table>

<!-- Notification Popup -->
<div id="notification-popup">
  <header>
    <span>Produits √† surveiller</span>
    <button id="close-notif">‚úñÔ∏è</button>
  </header>
  <div class="content" id="notif-content"></div>
</div>

<script>
  const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
  const RANGE = 'historique';
  let allData = [];

  window.onload = () => {
    gapi.load('client', async () => {
      await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
      loadData();
    });
    document.getElementById('btn-notif').onclick = () => {
      loadNotifications();
      document.getElementById('notification-popup').style.display = 'flex';
    };
    document.getElementById('close-notif').onclick = () => {
      document.getElementById('notification-popup').style.display = 'none';
    };
  };

  async function loadData() {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: RANGE
    });
    allData = res.result.values || [];
    renderTable(allData);
  }

  function renderTable(data) {
    const tbody = document.querySelector('#history-table tbody');
    tbody.innerHTML = '';
    data.slice(1).forEach(row => {
      const tr = document.createElement('tr');
      [1,2,3,4,5,6].forEach(i => {
        const td = document.createElement('td');
        td.textContent = row[i] || '';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function applyFilters() {
    const zone = document.getElementById('filter-zone').value.toLowerCase();
    const month = document.getElementById('filter-month').value;
    const filtered = allData.filter((row, idx) => {
      if (idx === 0) return false;
      const rowZone = (row[4] || '').toLowerCase();
      const date = row[2] || '';
      return (!zone || rowZone.includes(zone)) && (!month || date.startsWith(month));
    });
    renderTable([allData[0], ...filtered]);
  }

  function resetFilters() {
    document.getElementById('filter-zone').value = '';
    document.getElementById('filter-month').value = '';
    renderTable(allData);
  }

  function loadNotifications() {
    const today = new Date();
    const soon = new Date(today);
    soon.setMonth(today.getMonth() + 3);
    const upcoming = allData.filter((row, idx) => {
      if (idx === 0) return false;
      const date = new Date(row[2]);
      return !isNaN(date) && date >= today && date <= soon;
    });

    const content = document.getElementById('notif-content');
    if (!upcoming.length) {
      content.innerHTML = '<p>Aucune notification √† afficher.</p>';
      return;
    }
    content.innerHTML = '<table><thead><tr><th>Produit</th><th>Date</th><th>Zone</th></tr></thead><tbody>' +
      upcoming.map(r => `<tr><td>${r[1]}</td><td>${r[2]}</td><td>${r[4]}</td></tr>`).join('') +
      '</tbody></table>';
  }
</script>
</body>
</html>


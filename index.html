<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suivi App PÃ©rimÃ©s - Google Sheets</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #00796B;
      color: white;
      padding: 10px 20px;
    }

    .header-left h2 {
      margin: 0;
      font-size: 20px;
    }

    .header-left select {
      margin-left: 10px;
      padding: 5px;
    }

    .header-right button {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      margin-left: 15px;
    }

    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    input, select { margin: 5px; }

    #entry-form, #operator-form {
      padding: 10px 20px;
    }

    #status {
      margin: 20px;
    }
  </style>
</head>
<body>
  <!-- Bandeau -->
  <div class="header">
    <div class="header-left">
      <h2>Gestion PÃ©rimÃ© - Pharmacie du Libron</h2>
      <select id="operator">
        <option value="">-- Choisir OpÃ©rateur --</option>
        <option>Op1</option>
        <option>Op2</option>
        <option>Op3</option>
        <option>Op4</option>
      </select>
      <button id="btn-confirm-operator" style="margin-left: 5px;">Valider</button>
    </div>
    <div class="header-right">
      <button title="Notifications">ðŸ””</button>
      <button title="Historique">ðŸ“œ</button>
      <button id="btn-logout" style="display:none;" title="DÃ©connexion">ðŸ”“</button>
    </div>
  </div>

  <!-- Connexion -->
  <button id="btn-login" style="margin: 10px; display:none;">Se connecter</button>

  <!-- Formulaire d'ajout -->
  <div id="entry-form" style="display:block;">
    <h3>Ajouter un produit</h3>
    <input type="date" id="date" />
    <input type="text" id="product" placeholder="Nom BoÃ®te" />
    <input type="number" id="qty" placeholder="Nb BoÃ®tes" />
    <input type="text" id="zone" placeholder="Zone" />
    <input type="number" id="sold" placeholder="Nb vendus" />
    <input type="number" id="promo" placeholder="Nb promo" />
    <button id="btn-add">Ajouter la ligne</button>
  </div>

  <!-- Filtres -->
  <div style="padding: 0 20px;">
    <label>Filtrer Zone :</label>
    <input type="text" id="filter-zone" />
    <label>Mois (MM/YYYY) :</label>
    <input type="text" id="filter-month" placeholder="ex: 06/2025" />
    <button onclick="filterTable()">Filtrer</button>
  </div>

  <!-- Tableau -->
  <table id="data-table">
    <thead>
      <tr>
        <th>Produit</th>
        <th>Date</th>
        <th>QtÃ©</th>
        <th>Zone</th>
        <th>Vendues</th>
        <th>Promo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <pre id="status"></pre>

  <!-- JS Google Sheets -->
  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1';
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    let tokenClient, gapiInited = false, gisInited = false, accessToken = null, operatorName = null;

    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() {
      await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          document.getElementById('btn-login').style.display = 'none';
          document.getElementById('btn-logout').style.display = 'inline-block';
          loadSheet();
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) document.getElementById('btn-login').style.display = 'inline-block';
    }

    document.getElementById('btn-login').onclick = () => tokenClient.requestAccessToken();

    document.getElementById('btn-logout').onclick = () => {
      accessToken = null; operatorName = null;
      document.getElementById('btn-login').style.display = 'inline-block';
      document.getElementById('btn-logout').style.display = 'none';
      document.getElementById('status').textContent = 'DÃ©connectÃ©.';
      document.querySelector('#data-table tbody').innerHTML = '';
    };

    document.getElementById('btn-confirm-operator').onclick = () => {
      const op = document.getElementById('operator').value;
      if (!op) return alert("Choisir un opÃ©rateur");
      operatorName = op;
      alert("OpÃ©rateur sÃ©lectionnÃ© : " + operatorName);
    };

    document.getElementById('btn-add').onclick = async () => {
      if (!accessToken) return alert("Veuillez vous connecter Ã  Google.");
      if (!operatorName) return alert("Veuillez sÃ©lectionner un opÃ©rateur.");

      const product = document.getElementById('product').value.trim();
      if (!product) return alert("Le nom du produit est obligatoire.");

      const values = [[
        operatorName,
        product,
        document.getElementById('date').value || new Date().toISOString().split('T')[0],
        parseInt(document.getElementById('qty').value) || 0,
        document.getElementById('zone').value.trim(),
        parseInt(document.getElementById('sold').value) || 0,
        parseInt(document.getElementById('promo').value) || 0,
      ]];
      try {
        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
          valueInputOption: 'USER_ENTERED',
          resource: { values }
        });
        loadSheet();
        document.getElementById('status').textContent = 'AjoutÃ© !';
      } catch (e) {
        document.getElementById('status').textContent = 'Erreur : ' + e.message;
      }
    };

    async function loadSheet() {
      if (!accessToken) return;
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: RANGE });
      const rows = res.result.values || [];
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      rows.slice(1).forEach(row => {
        const tr = document.createElement('tr');
        for (let i = 1; i <= 6; i++) {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.textContent = row[i] || '';
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
    }

    window.filterTable = function () {
      const zone = document.getElementById('filter-zone').value.toLowerCase();
      const filterMonth = document.getElementById('filter-month').value.trim(); // Format MM/YYYY

      const rows = document.querySelectorAll('#data-table tbody tr');
      rows.forEach(row => {
        const zoneText = row.cells[3].textContent.toLowerCase(); // zone
        const dateText = row.cells[1].textContent; // date

        const rowDate = new Date(dateText);
        const rowMonth = (rowDate.getMonth() + 1).toString().padStart(2, '0');
        const rowYear = rowDate.getFullYear();
        const rowMonthYear = `${rowMonth}/${rowYear}`;

        const matchZone = !zone || zoneText.includes(zone);
        const matchMonth = !filterMonth || rowMonthYear === filterMonth;

        row.style.display = (matchZone && matchMonth) ? '' : 'none';
      });
    };

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>

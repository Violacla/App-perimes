<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>App Google Sheets - Écriture avec GIS</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h2>Connexion Google Sheets API - Écriture de données (nouvelle méthode)</h2>
  <div id="button-container">
    <button id="authorize_button" style="display:none;">Connexion</button>
    <button id="signout_button" style="display:none;">Déconnexion</button>
    <button id="append_button" style="display:none;">Ajouter une ligne</button>
  </div>

  <pre id="content" style="margin-top: 20px;"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1!A:C';

    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton = document.getElementById('signout_button');
    const appendButton = document.getElementById('append_button');
    const content = document.getElementById('content');

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let accessToken = null;

    // 1. Charger la bibliothèque Google API client
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: '', // optionnel si OAuth
        discoveryDocs: DISCOVERY_DOCS,
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // 2. Initialiser Google Identity Services token client
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp.error) {
            content.textContent = 'Erreur d\'authentification : ' + resp.error;
            return;
          }
          accessToken = resp.access_token;
          appendButton.style.display = 'inline-block';
          signoutButton.style.display = 'inline-block';
          authorizeButton.style.display = 'none';
          content.textContent = 'Connecté. Prêt à ajouter une ligne.';
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    // 3. Autoriser seulement quand tout est prêt
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        authorizeButton.style.display = 'inline-block';
      }
    }

    // 4. Gérer clic sur connexion
    authorizeButton.onclick = () => {
      tokenClient.requestAccessToken();
    };

    // 5. Gérer clic sur déconnexion
    signoutButton.onclick = () => {
      accessToken = null;
      content.textContent = 'Déconnecté.';
      authorizeButton.style.display = 'inline-block';
      signoutButton.style.display = 'none';
      appendButton.style.display = 'none';
      // Pas de méthode officielle pour "déconnecter" via GIS, il faut gérer localement
    };

    // 6. Ajouter une ligne dans la feuille
    appendButton.onclick = async () => {
      if (!accessToken) {
        content.textContent = 'Merci de vous connecter d\'abo

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Google Sheets avec GIS uniquement</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h2>Connexion Google Sheets API - GIS Only</h2>

  <button id="btn-login" style="display:none;">Se connecter</button>
  <button id="btn-logout" style="display:none;">Déconnexion</button>
  <button id="btn-append" style="display:none;">Ajouter une ligne</button>

  <pre id="status"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1!A:C';

    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const btnAppend = document.getElementById('btn-append');
    const status = document.getElementById('status');

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let accessToken = null;

    // 1. Charger Google API client
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: DISCOVERY_DOCS,
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // 2. Charger Google Identity Services
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            status.textContent = 'Erreur auth : ' + tokenResponse.error;
            return;
          }
          accessToken = tokenResponse.access_token;
          btnAppend.style.display = 'inline-block';
          btnLogout.style.display = 'inline-block';
          btnLogin.style.display = 'none';
          status.textContent = 'Connecté, prêt à écrire.';
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    // 3. Afficher bouton login si tout est prêt
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        btnLogin.style.display = 'inline-block';
      }
    }

    // 4. Actions boutons
    btnLogin.onclick = () => {
      tokenClient.requestAccessToken();
    };

    btnLogout.onclick = () => {
      accessToken = null;
      btnLogin.style.display = 'inline-block';
      btnLogout.style.display = 'none';
      btnAppend.style.display = 'none';
      status.textContent = 'Déconnecté.';
    };

    btnAppend.onclick = async () => {
      if (!accessToken) {
        status.textContent = 'Merci de vous connecter.';
        return;
      }
      try {
        const values = [["TestNom", "TestPrenom", new Date().toLocaleString()]];
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
          valueInputOption: 'USER_ENTERED',
          insertDataOption: 'INSERT_ROWS',
          resource: { values }
        });
        status.textContent = 'Ligne ajoutée avec succès !\n' + JSON.stringify(response.result.updates, null, 2);
      } catch (err) {
        status.textContent = 'Erreur ajout : ' + (err.result?.error?.message || err.message);
      }
    };

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion PÃ©rimÃ© - Pharmacie du Libron</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif;
    }
    /* Bandeau */
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #004080;
      color: white;
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    #top-bar h1 {
      font-size: 18px;
      margin: 0;
    }
    #top-bar .left, #top-bar .right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #top-bar button {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
      padding: 5px 10px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    #top-bar button:hover {
      background: rgba(255,255,255,0.2);
    }
    #operator {
      font-size: 16px;
      padding: 3px 6px;
      border-radius: 4px;
      border: none;
    }

    /* Table */
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    input, select { margin: 5px; }
    tbody tr td:nth-child(1) {
      display: none; /* Cache la colonne OpÃ©rateur */
    }
    tbody tr td {
      white-space: nowrap;
    }

    /* Formulaires */
    #entry-form { margin-top: 20px; }

    /* Modal notifications */
    #notification-modal {
      display:none;
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      z-index: 9999;
      overflow-y: auto;
    }
    #notification-modal > div {
      background:#fff;
      width:80%;
      max-width:600px;
      margin: 80px auto 40px;
      padding: 20px 30px 40px;
      border-radius: 8px;
      position: relative;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    #notification-modal h3 {
      margin-top: 0;
      font-size: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }
    #notification-list {
      list-style:none;
      padding-left: 0;
      max-height: 400px;
      overflow-y: auto;
      font-size: 16px;
    }
    #notification-list li {
      margin: 6px 0;
    }
    #notification-list li.title {
      font-weight: bold;
      margin-top: 15px;
      font-size: 17px;
      color: #004080;
    }
    #notification-modal button.close-btn {
      position: absolute;
      top: 10px; right: 10px;
      background: transparent;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #666;
      font-weight: bold;
      line-height: 1;
    }
    #notification-modal button.close-btn:hover {
      color: #000;
    }
  </style>
</head>
<body>

  <div id="top-bar">
    <div class="left">
      <h1>Gestion PÃ©rimÃ© - Pharmacie du Libron</h1>
      <select id="operator">
        <option value="">-- Choisir OpÃ©rateur --</option>
        <option>Op1</option>
        <option>Op2</option>
        <option>Op3</option>
        <option>Op4</option>
      </select>
      <button id="btn-confirm-operator">Valider</button>
    </div>
    <div class="right">
      <button id="btn-notifications" title="Notifications">ðŸ””</button>
      <button id="btn-history" title="Historique">ðŸ“œ</button>
      <button id="btn-logout" style="display:none;" title="DÃ©connexion">ðŸšª</button>
    </div>
  </div>

  <div id="entry-form" style="display:none;">
    <h3>Ajouter un produit</h3>
    <input type="date" id="date" />
    <input type="text" id="product" placeholder="Nom BoÃ®te" />
    <input type="number" id="qty" placeholder="Nb BoÃ®tes" />
    <input type="text" id="zone" placeholder="Zone" />
    <input type="number" id="sold" placeholder="Nb vendus" />
    <input type="number" id="promo" placeholder="Nb promo" />
    <button id="btn-add">Ajouter la ligne</button>
  </div>

  <div style="margin-top: 20px;">
    <label>Filtrer Zone :</label>
    <input type="text" id="filter-zone" />
    <label>Mois (MM/YYYY) :</label>
    <input type="month" id="filter-month" />
    <button onclick="filterTable()">Filtrer</button>
  </div>

  <table id="data-table">
    <thead>
      <tr>
        <th>OpÃ©rateur</th>
        <th>Produit</th>
        <th>Date</th>
        <th>QtÃ©</th>
        <th>Zone</th>
        <th>Vendues</th>
        <th>Promo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <pre id="status"></pre>

  <!-- Modal notifications -->
  <div id="notification-modal">
    <div>
      <h3>Produits pÃ©rimÃ©s Ã  venir (3 mois)</h3>
      <ul id="notification-list"></ul>
      <button class="close-btn" onclick="document.getElementById('notification-modal').style.display='none'">âœ–</button>
    </div>
  </div>

<script>
  const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
  const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
  const RANGE = 'Feuille1';
  const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

  let tokenClient, gapiInited = false, gisInited = false, accessToken = null, operatorName = null;

  function gapiLoaded() { gapi.load('client', initializeGapiClient); }
  async function initializeGapiClient() {
    await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
    gapiInited = true;
    maybeEnableButtons();
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById('operator').disabled = false;
        document.getElementById('btn-confirm-operator').disabled = false;
        document.getElementById('status').textContent = 'ConnectÃ©. Choisissez un opÃ©rateur.';
      },
    });
    gisInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('btn-login').style.display = 'inline-block';
    }
  }

  document.getElementById('btn-confirm-operator').onclick = () => {
    const op = document.getElementById('operator').value;
    if (!op) return alert("Choisir un opÃ©rateur");
    operatorName = op;
    document.getElementById('entry-form').style.display = 'block';
    document.getElementById('btn-logout').style.display = 'inline-block';
    document.getElementById('status').textContent = `OpÃ©rateur : ${operatorName}`;
    loadSheet();
  };

  document.getElementById('btn-logout').onclick = () => {
    accessToken = null; operatorName = null;
    document.getElementById('operator').value = '';
    document.getElementById('entry-form').style.display = 'none';
    document.getElementById('btn-logout').style.display = 'none';
    document.getElementById('status').textContent = 'DÃ©connectÃ©.';
  };

  document.getElementById('btn-add').onclick = async () => {
    if (!operatorName) {
      alert("Veuillez d'abord choisir un opÃ©rateur.");
      return;
    }
    const dateVal = document.getElementById('date').value || new Date().toISOString().split('T')[0];
    const values = [[
      operatorName,
      document.getElementById('product').value,
      dateVal,
      parseInt(document.getElementById('qty').value) || 0,
      document.getElementById('zone').value,
      parseInt(document.getElementById('sold').value) || 0,
      parseInt(document.getElementById('promo').value) || 0,
    ]];
    try {
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: 'USER_ENTERED',
        resource: { values }
      });
      loadSheet();
      document.getElementById('status').textContent = 'AjoutÃ© !';
      // Reset form fields
      ['date','product','qty','zone','sold','promo'].forEach(id => {
        document.getElementById(id).value = '';
      });
    } catch (e) {
      document.getElementById('status').textContent = 'Erreur : ' + e.message;
    }
  };

  async function loadSheet() {
    if (!accessToken) return;
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE
      });
      const rows = res.result.values || [];
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      rows.slice(1).forEach(row => {
        const tr = document.createElement('tr');
        for (let i = 0; i < 7; i++) {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.textContent = row[i] || '';
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
    } catch (e) {
      document.getElementById('status').textContent = 'Erreur chargement : ' + e.message;
    }
  }

  window.filterTable = function() {
    const zone = document.getElementById('filter-zone').value.toLowerCase();
    const monthFilter = document.getElementById('filter-month').value; // format "YYYY-MM"
    const rows = document.querySelectorAll('#data-table tbody tr');
    rows.forEach(row => {
      const zoneText = row.cells[4].textContent.toLowerCase();
      const dateText = row.cells[2].textContent; // format yyyy-mm-dd
      let matchZone = !zone || zoneText.includes(zone);
      let matchMonth = true;
      if (monthFilter) {
        // on compare YYYY-MM
        matchMonth = dateText.startsWith(monthFilter);
      }
      row.style.display = (matchZone && matchMonth) ? '' : 'none';
    });
  }

  // Affiche notifications popup avec pÃ©rimÃ©s des 3 prochains mois (tous les 15 du mois)
  document.getElementById("btn-notifications").onclick = async function () {
    const now = new Date();
    if (now.getDate() < 15) {
      alert("Les notifications sont disponibles seulement Ã  partir du 15 du mois.");
      return;
    }
    if (!accessToken) {
      alert("Veuillez vous connecter d'abord.");
      return;
    }

    // RÃ©cupÃ©rer donnÃ©es de la feuille
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE
      });
      const rows = res.result.values || [];
      if (rows.length < 2) {
        alert("Pas de donnÃ©es.");
        return;
      }

      const nowYear = now.getFullYear();
      const nowMonth = now.getMonth(); // 0-indexÃ©

      // Calcul des 3 mois complets suivants : M+1, M+2, M+3
      let monthsToShow = [];
      for(let i=1; i<=3; i++) {
        let date = new Date(nowYear, nowMonth + i, 1);
        monthsToShow.push({year: date.getFullYear(), month: date.getMonth()});
      }

      // Grouper pÃ©rimÃ©s par mois (format "MM/YYYY")
      let perimesByMonth = {};

      // Parcours donnÃ©es et filtre pÃ©rimÃ©s dans les mois sÃ©lectionnÃ©s
      rows.slice(1).forEach(row => {
        // row : [Op, produit, date, qty, zone, sold, promo]
        let dateStr = row[2];
        if (!dateStr) return;
        let d = new Date(dateStr);
        if (isNaN(d)) return;

        const y = d.getFullYear();
        const m = d.getMonth();

        // VÃ©rifie si dans un des mois sÃ©lectionnÃ©s
        if (monthsToShow.some(mm => mm.year === y && mm.month === m)) {
          const key = ("0"+(m+1)).slice(-2) + "/" + y;
          if (!perimesByMonth[key]) perimesByMonth[key] = [];
          perimesByMonth[key].push(row);
        }
      });

      // Construire HTML liste triÃ©e par mois
      const notifList = document.getElementById('notification-list');
      notifList.innerHTML = '';

      // Trier les mois par date croissante
      monthsToShow.sort((a,b) => a.year - b.year || a.month - b.month);

      monthsToShow.forEach(({year, month}) => {
        const key = ("0"+(month+1)).slice(-2) + "/" + year;
        const perimes = perimesByMonth[key] || [];

        const liTitle = document.createElement('li');
        liTitle.textContent = key;
        liTitle.classList.add('title');
        notifList.appendChild(liTitle);

        if(perimes.length === 0) {
          const liNone = document.createElement('li');
          liNone.textContent = 'Aucun produit pÃ©rimÃ© ce mois.';
          notifList.appendChild(liNone);
        } else {
          perimes.forEach(row => {
            const li = document.createElement('li');
            li.textContent = `Produit: ${row[1]}, Date: ${row[2]}, QtÃ©: ${row[3]}, Zone: ${row[4]}`;
            notifList.appendChild(li);
          });
        }
      });

      // Afficher modal
      document.getElementById('notification-modal').style.display = 'block';

    } catch(e) {
      alert("Erreur lors de la rÃ©cupÃ©ration des donnÃ©es : " + e.message);
    }
  };

  // Lancement automatique notifications si jour >= 15 au chargement
  window.onload = function() {
    gapiLoaded();
    gisLoaded();

    // Par dÃ©faut, dÃ©sactivation opÃ©rateur tant que pas connectÃ©
    document.getElementById('operator').disabled = true;
    document.getElementById('btn-confirm-operator').disabled = true;

    const now = new Date();
    if (now.getDate() >= 15) {
      // Attendre la connexion Google avant d'appeler les notif
      // Ici on attend 2s, tu peux ajuster ou amÃ©liorer en ajoutant un event callback
      setTimeout(() => {
        if(accessToken) {
          document.getElementById('btn-notifications').click();
        }
      }, 2000);
    }
  }
</script>

</body>
</html>

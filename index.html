<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suivi App Périmés - Google Sheets</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    input, select { margin: 5px; }
  </style>
</head>
<body>
  <h2>Connexion Google Sheets API + Opérateur</h2>

  <button id="btn-login" style="display:none;">Se connecter</button>
  <button id="btn-logout" style="display:none;">Déconnexion</button>

  <div id="operator-form" style="display:block;">
    <label>Nom Opérateur :</label>
    <select id="operator">
      <option value="">-- Choisir --</option>
      <option>Op1</option>
      <option>Op2</option>
      <option>Op3</option>
      <option>Op4</option>
    </select>
    <button id="btn-confirm-operator">Valider</button>
  </div>

  <div id="entry-form" style="display:block; margin-top: 20px;">
    <h3>Ajouter un produit</h3>
    <input type="date" id="date" />
    <input type="text" id="product" placeholder="Nom Boîte" />
    <input type="number" id="qty" placeholder="Nb Boîtes" />
    <input type="text" id="zone" placeholder="Zone" />
    <input type="number" id="sold" placeholder="Nb vendus" />
    <input type="number" id="promo" placeholder="Nb promo" />
    <button id="btn-add">Ajouter la ligne</button>
  </div>

  <div>
    <label>Filtrer Zone :</label>
    <input type="text" id="filter-zone" />
    <label>Date après :</label>
    <input type="date" id="filter-date" />
    <button onclick="filterTable()">Filtrer</button>
  </div>

  <table id="data-table">
    <thead>
      <tr><th>Opérateur</th><th>Produit</th><th>Date</th><th>Qté</th><th>Zone</th><th>Vendues</th><th>Promo</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <pre id="status"></pre>

  <script>
    const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
    const RANGE = 'Feuille1';
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    let tokenClient, gapiInited = false, gisInited = false, accessToken = null, operatorName = null;

    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() {
      await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          document.getElementById('operator-form').style.display = 'block';
          document.getElementById('btn-login').style.display = 'none';
          document.getElementById('btn-logout').style.display = 'inline-block';
          loadSheet();
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) document.getElementById('btn-login').style.display = 'inline-block';
    }

    document.getElementById('btn-login').onclick = () => tokenClient.requestAccessToken();
    document.getElementById('btn-logout').onclick = () => {
      accessToken = null; operatorName = null;
      document.getElementById('btn-login').style.display = 'inline-block';
      document.getElementById('btn-logout').style.display = 'none';
      document.getElementById('entry-form').style.display = 'block';
      document.getElementById('status').textContent = 'Déconnecté.';
      document.querySelector('#data-table tbody').innerHTML = '';
    };

    document.getElementById('btn-confirm-operator').onclick = () => {
      const op = document.getElementById('operator').value;
      if (!op) return alert("Choisir un opérateur");
      operatorName = op;
      alert("Opérateur sélectionné : " + operatorName);
      // On ne cache plus entry-form, on laisse visible
    };

    document.getElementById('btn-add').onclick = async () => {
      if (!accessToken) return alert("Veuillez vous connecter à Google.");
      if (!operatorName) return alert("Veuillez sélectionner un opérateur.");

      const product = document.getElementById('product').value.trim();
      if (!product) return alert("Le nom du produit est obligatoire.");

      const values = [[
        operatorName,
        product,
        document.getElementById('date').value || new Date().toISOString().split('T')[0],
        parseInt(document.getElementById('qty').value) || 0,
        document.getElementById('zone').value.trim(),
        parseInt(document.getElementById('sold').value) || 0,
        parseInt(document.getElementById('promo').value) || 0,
      ]];
      try {
        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SPREADSHEET_ID,
          range: RANGE,
          valueInputOption: 'USER_ENTERED',
          resource: { values }
        });
        loadSheet();
        document.getElementById('status').textContent = 'Ajouté !';
      } catch (e) {
        document.getElementById('status').textContent = 'Erreur : ' + e.message;
      }
    };

    async function loadSheet() {
      if (!accessToken) return;
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: RANGE });
      const rows = res.result.values || [];
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      rows.slice(1).forEach(row => {
        const tr = document.createElement('tr');
        for (let i = 0; i < 7; i++) {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.textContent = row[i] || '';
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
    }

    window.filterTable = function() {
      const zone = document.getElementById('filter-zone').value.toLowerCase();
      const date = document.getElementById('filter-date').value;
      const rows = document.querySelectorAll('#data-table tbody tr');
      rows.forEach(row => {
        const zoneText = row.cells[4].textContent.toLowerCase();
        const dateText = row.cells[2].textContent;
        const matchZone = !zone || zoneText.includes(zone);
        const matchDate = !date || new Date(dateText) >= new Date(date);
        row.style.display = (matchZone && matchDate) ? '' : 'none';
      });
    }

    window.onload = () => { 
      gapiLoaded(); 
      gisLoaded();
      // Le formulaire d'ajout est visible par défaut, pas besoin de changer le display ici
    };
  </script>
</body>
</html>

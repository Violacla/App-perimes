<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Gestion Perim√© - Pharmacie du Libron</title>
<script async="" defer="" src="https://accounts.google.com/gsi/client"></script>
<script src="https://apis.google.com/js/api.js"></script>
<style>
  .autocomplete-list {
  position: absolute;
  background-color: white;
 /* background-color: #fffefc;*/
  border: 1px solid #ccc;
  border-radius: 4px;
  list-style: none;
  margin: 0;
  padding: 0;
  max-height: 150px;
  overflow-y: auto;
  width: 250px;
  z-index: 999;
}

.autocomplete-list li {
  padding: 8px 10px;
  cursor: pointer;
  color: black;
}

.autocomplete-list li:hover,
.autocomplete-list li.active {
 background-color: #bcd7ed;
/*background-color: #f294a6;*/
  color: white;
}

  :root {
    --bleu-glacial: #bcd7ed;
   /*--bleu-glacial: #f294a6;*/
  }

  body {
    margin: 0;
    font-family: Arial, sans-serif;
    /*background: #f9f9f9;*/
    background: #fffefc;
  }

  /* Bandeau bleu glacial */
  header {
    background-color: var(--bleu-glacial);
    color: #163f5b;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  }

  #header-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  #header-left > h1 {
    margin: 0;
    font-size: 1.3em;
  }

  button {
    cursor: pointer;
    border: none;
    background: transparent;
    font-size: 1em;
    color: black;
    padding: 6px 10px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: rgba(255 255 255 / 0.3);
  }

  /* Icons with emoji for simplicity */
  .icon {
    font-size: 1.2em;
    margin-right: 6px;
  }

  /* Header right buttons */
  #header-right {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  /* Operator form */
  #operator-form {
    margin-left: 10px;
  }

  /* Layout */
  main {
    display: flex;
    margin: 20px;
  }

  /* Form to add entries on right */
 #entry-form {
  width: 320px;
  background: f294a6;
  padding: 15px 20px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  margin-left: 20px;
  margin-top: 48px; /* Aligne avec les filtres */
}

  #entry-form h3 {
    margin-top: 0;
    margin-bottom: 10px;
    font-weight: normal;
  }
  #entry-form input {
    background-color: #e1f4e4;
    width: 100%;
    margin: 6px 0;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  #entry-form button {
    width: 100%;
    /*background-color: var(--bleu-glacial);*/
    background-color: #bfdbc4;
    color: black;
    font-weight: bold;
    margin-top: 10px;
  }
  #entry-form button:hover {
    background-color: #86bf8e;
  }

  /* Table styles */
  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    border-radius: 6px;
    overflow: hidden;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px 10px;
    text-align: center;
  }

  /* Alternate row background with 15% opacity bleu glacial */
  tbody tr:nth-child(odd) {
   /* background-color: rgba(188, 215, 237, 0.15);*/
    background-color: #ede2e6
  }

  /* Selected row highlight 50% opacity */
  tbody tr.selected {
    /*background-color: rgba(188, 215, 237, 0.5) !important;*/
    background-color: #f2b4bb!important;
  }

  /* Editable cells */
  tbody td {
    cursor: text;
  }

  /* Filter section */
  #filters {
    margin: 20px;
    display: flex;
    gap: 15px;
    align-items: flex-end;
  }
  #filters label {
    font-weight: bold;
     color: #86bf8e;
  }
  #filters input, #filters button {
    padding: 5px 8px;
    font-size: 1em;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #filters button {
    /*background-color: var(--bleu-glacial);*/
    background-color: #bfdbc4;
    color: black;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  #filters button:hover {
    background-color: #86bf8e;
    color: white;
  }

  /* Status text */
  #status {
    margin: 10px 20px;
    font-weight: bold;
    color: #0a2f51;
  }

 /* Styles pour la popup de notification */
  #notification-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    width: 1300px;
    max-height: 92vh;
    overflow-y: auto;
    z-index: 9999;
    display: none;
    flex-direction: column;
  }
  #notification-popup header {
    display: flex;
    justify-content: space-between;
    align-items: left;
    padding: 10px 20px;
    background-color: var(--bleu-glacial);
    color: white;
    border-radius: 10px 10px 0 0;
  }
  #notif-tabs {
    display: flex;
    gap: 10px;
    margin-left: auto;
  }
  .header-buttons {
    display: flex;
    gap: 10px;
  }
  .tab-button {
    background-color: transparent;
    color: black; /* Texte en noir par d√©faut */
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s, color 0.3s;
    text-align: left;
    border-radius: 5px 5px 0 0;
  }
  .tab-button:hover,
  .tab-button.active {
    background-color: #004d99; /* Fond bleu fonc√© au survol et pour l'onglet actif */
    color: white; /* Texte blanc au survol et pour l'onglet actif */
  }
  .tab-content {
    display: none;
    padding: 15px;
    overflow-y: auto;
    max-height: calc(92vh - 80px);
    color: black;
  }
  .tab-content h3 {
    text-align: left;
    color: black;
  }
  .tab-content.active {
    display: block;
  }
  /* Styles pour l'impression */
  @media print {
    body > :not(#notification-popup) {
      display: none;
    }
    #notification-popup {
      position: static !important;
      transform: none !important;
      top: auto !important;
      left: auto !important;
      width: 100% !important;
      height: auto !important;
      max-height: none !important;
      overflow: visible !important;
      margin: 0 !important;
      padding: 0 !important;
      border-radius: 0 !important;
      display: block !important;
    }
    #notification-popup .tab-content:not(.active) {
      display: none !important;
    }
    #notification-popup #notif-tabs,
    #notification-popup .header-buttons {
      display: none !important;
    }
    html, body {
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    #notification-popup .tab-content,
    #notification-popup .content {
      max-height: none !important;
      overflow: visible !important;
    }
  }
  #date-error {
  display: none;
  background-color: #d6edd8;
  color: #87c08f;
  padding: 10px;
  margin: 10px 0;
  border: 2px solid #87c08f;
  border-radius: 6px;
  font-weight: bold;
  text-align: center;
  font-size: 1em;
  max-width: 90%;
  margin: 0 auto 10px auto;
}
#update-overlay {
  position: fixed;
  top: 60px; /* Pour laisser le bandeau visible */
  left: 0;
  width: 100%;
  height: calc(100% - 60px);
  background-color: rgba(188, 215, 237, 0.9); /* bleu glacial transparent */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9998;
}

#update-popup {
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.25);
  max-width: 600px;
  text-align: center;
  font-size: 1.1em;
}

#update-popup h2 {
  margin-top: 0;
  color: #87c08f;
}

#update-popup ul {
  list-style: none;
  padding-left: 0;
  text-align: left;
  margin-bottom: 20px;
}

#update-popup ul li::before {
  content: "üîπ ";
}

#update-logo {
  display: block;
  margin: 20px auto 0 auto;
  width: 70px;
  height: auto;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script></head>
<header>
<div id="header-left">
<a href="/index.html" style="
      display:inline-block;
      width:40px;
      height:40px;
      border-radius:50%;
      overflow:hidden;
      border:0px solid #0a2f51;
    " title="Accueil">
<!--<img alt="Logo" src="https://i.imgur.com/FmevFyY.png" style="width:100%; height:100%; object-fit:cover;"/> -->
<img alt="Logo" src="https://i.imgur.com/AExTPc7.png" style="width:100%; height:100%; object-fit:cover;"/>
</a>
<h1>Gestion P√©rim√© - Pharmacie du Libron</h1>
<!-- Groupe op√©rateur -->
<div id="operator-form" style="display:none; margin-left:10px;">
<input id="operator" placeholder="Nom de l'op√©rateur" type="text"/>
<button id="btn-confirm-operator">Valider</button>
</div>
<!-- Bouton connexion -->
<button id="btn-login" style="display:inline-block; margin-left:10px;">Se connecter</button>
</div>
<div id="header-right">
<button id="btn-notif" style="position: relative; display: inline-flex; align-items: center; gap: 5px;" title="Notifications">
<img alt="Logo" src="https://i.imgur.com/em9h9Wk.png" style="width:18px; height:18px; object-fit:cover; vertical-align:middle;"/>
   Suivi Perim√©s
  <span id="notif-badge" style="display: none; position: absolute; top: 0px; right: 0px; width: 16px; height: 16px; z-index: 2;">
<img src="https://i.imgur.com/dhRXYUQ.png" style="width:100%; height:100%; object-fit:cover;"/>
</span>
</button>
<button onclick="location.href='historique.html'" title="Historique">
<img alt="Historique" src="https://i.imgur.com/BasLkpT.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
Historique
</button>
  <button onclick="location.href='promotion.html'" title="Promo %">
% Promo
</button>
  </button>
  <button id="btn-open-my-pdf" title="Ouvrir mon PDF personnalis√©">
  <img src=https://i.imgur.com/kGXfRUa.png" style="width:18px; height:18px; vertical-align:middle;"/>
</button>
<button id="btn-logout" style="display:none;" title="D√©connexion">
<!-- <img alt="D√©connexion" src="https://i.imgur.com/Ku9oMjb.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/> -->
<img alt="D√©connexion" src="https://i.imgur.com/OPA1EuF.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
D√©connexion
</button>
</div>

</header>
<main>
<div style="flex-grow:1;">
<div id="filters">
<!--<label for="quickSearchProduct">Recherche:</label>-->
<!-- <input type="text" id="quick-product" placeholder="Nom...." style="margin-left: 10px;" /> -->
<label for="filter-zone">Filtrer Zone:</label>
<input id="filter-zone" placeholder="Ex: Zone A" type="text"/>
<label for="filter-month">Date:</label>
<input id="filter-month" placeholder="MMYYYY or YYYY" style="width: 140px;" type="text"/>
<button onclick="filterTable()">Filtrer</button>
<button onclick="clearFilter()">R√©initialiser</button>
<button id="btn-print-table" title="EXPORTER EN PDF">
<img src="https://i.imgur.com/GX530wW.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;"/>
 PDF
</button>
<ul class="autocomplete-list" id="filter-zone-suggestions" style="display: none;"></ul>
</div>
<div style="max-height: 400px; overflow-y: auto; border-radius: 6px; margin-top: 10px;"><table aria-label="Donn√©es des produits p√©rim√©s" id="data-table" tabindex="0">
<thead>
<tr>
<!-- Ne PAS afficher colonne op√©rateur -->
<th>Date</th>
<th>Produit</th>
<th>Code</th>
<th>Qt√©</th>
<th>Zone</th>
<th>Vendues</th>
<th>Promo</th>
<th>Suppr</th>
</tr>
</thead>
<tbody></tbody>
</table></div>
<pre id="status"></pre>
</div>
<form id="entry-form" onsubmit="return false;" style="display: none;">
<h3>Ajouter un produit</h3>
<input id="date" placeholder="MM/YYYY" type="text"/>
  <div id="date-error">DATE<br>INVALIDE</div>
<input id="product" placeholder="Nom Bo√Æte" type="text"/>
<input id="code" maxlength="6" minlength="6" pattern="\d{6}" placeholder="Code (6 chiffres)" required="" type="text"/>
<input id="qty" min="0" placeholder="Nb Bo√Ætes" type="number"/>
<input autocomplete="off" id="zone" placeholder="Zone" type="text"/>
<ul class="autocomplete-list" id="zone-suggestions" style="display: none;"></ul>
<button id="btn-add" type="button">Ajouter la ligne</button>
</form>
</main>
<body>
  <div id="update-overlay">
  <div id="update-popup">
    <h2>Mises √† jour - 06/08/2025</h2>
    <ul>
      <li>Nouvelles fonctionnalit√©es : </li>
      <li>1. Notification est devenu "suivi Perim√©s" : <br>
      Des nouveaux onglets sont apparu dans la fenetre Suivi Perim√©s:<br>
      - Onglet " Trimestre " => 3 prochains mois<br>
      - Onglet " 2√®me Mois " => le mois du milieu du trimestre ( ex : Octobre 2025 quand on est en aout 2025 ) <br>
      - Onglet " A retirer " => Liste des p√©rim√©s du mois d'avant</li>
      <li>2. La fonction date invalide a √©t√© repar√©</li>
      <li>3. La fonction Mise √† jour => Elle disparait d√®s que l'on clique sur se connecter. </li>
      <li>Je reste √† votre disposition si vous avez des remarques ou fonctionnalit√© √† changer / Ajouter<br>
      Violaine. </li>
    </ul>
    <img src="https://i.imgur.com/yqzUg16.png" alt="Logo Mises √† jour" id="update-logo">
  </div>
</div>

<div aria-labelledby="notif-title" aria-modal="true" id="notification-popup" role="dialog" style="display: none;">
    <header>
        <span id="notif-title">Notifications - Produits p√©rim√©s</span>
        <div id="notif-tabs">
            <button class="tab-button active" onclick="showTab('trimestre')">Trimestre</button>
            <button class="tab-button" onclick="showTab('2nd-month')">2√®me mois</button>
            <button class="tab-button" onclick="showTab('current-month')">√Ä enlever</button>
        </div>
        <div class="header-buttons">
            <button id="print-notif" title="Imprimer">
                <img src="https://i.imgur.com/p0XRHwZ.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
            </button>
            <button id="close-notif" title="Fermer">
                <img src="https://i.imgur.com/pCnsbKA.png" style="width:18px; height:18px; vertical-align:middle; margin-right:6px;">
            </button>
        </div>
    </header>
    <div class="content">
        <div id="trimestre" class="tab-content active"></div>
        <div id="2nd-month" class="tab-content"></div>
        <div id="current-month" class="tab-content"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const badge = document.getElementById('notif-badge');
  const btnNotif = document.getElementById('btn-notif');
  const now = new Date();
  const monthKey = `${now.getFullYear()}-${now.getMonth()+1}`;
  if (now.getDate() >= 15 && localStorage.getItem('notifSeen') !== monthKey) {
    badge.style.display = 'inline-block';
  }
  btnNotif.addEventListener('click', () => {
    badge.style.display = 'none';
    localStorage.setItem('notifSeen', monthKey);
  });

  const operatorInput = document.getElementById('operator');
  const btnOperator = document.getElementById('btn-confirm-operator');
  if (operatorInput && btnOperator) {
    operatorInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btnOperator.click();
      }
    });
  }
});
</script>
<script>
  document.getElementById("btn-print-table").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;

    const zoneFilter = document.getElementById("filter-zone").value;
    const monthFilter = document.getElementById("filter-month").value;

    doc.setFontSize(14);
    doc.text("R√©sultats filtr√©s - Produits p√©rim√©s", 10, y);
    y += 10;
    doc.setFontSize(10);
    doc.text(`Zone : ${zoneFilter || "Toutes"}`, 10, y);
    y += 6;
    doc.text(`Mois : ${monthFilter || "Tous"}`, 10, y);
    y += 10;

    const rows = document.querySelectorAll("#data-table tbody tr");
    rows.forEach((row) => {
      if (row.style.display === "none") return;

      const cells = Array.from(row.children).slice(0, 6).map(td => td.textContent.trim());
      doc.text(cells.join(" | "), 10, y);
      y += 6;
      if (y > 280) {
        doc.addPage();
        y = 10;
      }
    });

    doc.save("resultats_perimes.pdf");
  });
</script>
<script>
  const filterInput = document.getElementById('filter-zone');
  const suggestionList = document.getElementById('filter-zone-suggestions');

  filterInput.addEventListener('input', function () {
    const val = this.value.toLowerCase();
    suggestionList.innerHTML = '';
    if (val.length < 1) {
      suggestionList.style.display = 'none';
      return;
    }

    const matches = zones.filter(z => z.toLowerCase().includes(val));
    if (matches.length === 0) {
      suggestionList.style.display = 'none';
      return;
    }

    matches.forEach((zone) => {
      const li = document.createElement('li');
      li.textContent = zone;
      li.addEventListener('click', () => {
        filterInput.value = zone;
        suggestionList.innerHTML = '';
        suggestionList.style.display = 'none';
      });
      suggestionList.appendChild(li);
    });

    const rect = filterInput.getBoundingClientRect();
    suggestionList.style.top = rect.bottom + window.scrollY + 'px';
    suggestionList.style.left = rect.left + window.scrollX + 'px';
    suggestionList.style.width = filterInput.offsetWidth + 'px';
    suggestionList.style.display = 'block';
  });

  document.addEventListener('click', function (e) {
    if (!filterInput.contains(e.target) && !suggestionList.contains(e.target)) {
      suggestionList.style.display = 'none';
    }
  });
</script>
<script>
  async function deleteRow(rowIndex) {
    try {
      await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          requests: [{
            deleteDimension: {
              range: {
                sheetId: 0,
                dimension: "ROWS",
                startIndex: rowIndex - 1,
                endIndex: rowIndex
              }
            }
          }]
        }
      });
      setStatus("Ligne supprim√©e avec succ√®s.");
      loadSheet();
    } catch (e) {
      setStatus("Erreur suppression : " + e.message);
    }
  }
</script>
<script>
  const filterMonthInput = document.getElementById('filter-month');
  filterMonthInput.addEventListener('input', function(e) {
  // On laisse l'utilisateur taper librement MMYYYY ou YYYY sans forcer le /
  e.target.value = e.target.value.replace(/[^\d\/]/g, ''); // emp√™che lettres
});

</script>
<script>
function filterTable() {
  const zoneFilter = document.getElementById("filter-zone").value.trim().toLowerCase();
  const monthFilter = document.getElementById("filter-month").value.trim(); // format MM/YYYY
  const productFilter = document.getElementById("quick-product").value.trim().toLowerCase();
  const rows = document.querySelectorAll("#data-table tbody tr");

  rows.forEach((row) => {
    const dateCell = row.cells[0].textContent.trim(); // Date = colonne 0
    const zoneCell = row.cells[4].textContent.trim().toLowerCase(); // Zone = colonne 4
    //const productCell = row.cells[1].textContent.trim().toLowerCase();
    let show = true;

    // Filtre zone
    if (zoneFilter && !zoneCell.includes(zoneFilter)) {
      show = false;
    }
    //if (productFilter && !productCell.includes(productFilter)) {
  //show = false;
//}
    // Filtre mois MM/YYYY
    /*if (monthFilter) {
      const [yyyy, mm, dd] = dateCell.split('-');
      const rowMonth = `${mm}/${yyyy}`;
      const [mFilter, yFilter] = monthFilter.split('/');
      if (rowMonth !== `${mFilter}/${yFilter}`) {
        show = false;
      }
    }*/
if (monthFilter) {
  let rowYear = '';
  let rowMonth = '';

  if (dateCell.includes('-')) {
    const parts = dateCell.split('-'); // format YYYY-MM-DD
    if (parts.length >= 2) {
      rowYear = parts[0];
      rowMonth = parts[1];
    }
  }

  let mFilter = null;
  let yFilter = null;

  if (/^\d{2}\/\d{4}$/.test(monthFilter)) {
    [mFilter, yFilter] = monthFilter.split('/');
  } else if (/^\d{6}$/.test(monthFilter)) {
    mFilter = monthFilter.slice(0, 2);
    yFilter = monthFilter.slice(2);
  } else if (/^\d{4}$/.test(monthFilter)) {
    yFilter = monthFilter;
  }

  if (yFilter && rowYear !== yFilter) show = false;
  if (mFilter && rowMonth !== mFilter) show = false;
}

    row.style.display = show ? "" : "none";
  });
}
function clearFilter() {
  document.getElementById('filter-zone').value = '';
  document.getElementById('filter-month').value = '';
  filterTable();
}
</script></body>
<!-- Notification Popup -->
<script>
  const CLIENT_ID = '777828681958-d450tqhqunv3thi6k4k0i8t33ts26bcv.apps.googleusercontent.com';
  const SPREADSHEET_ID = '1KzO5snEYkAtKjIUm1VHvnAPR8lYjOtwhUQg2dgvjPzE';
  const RANGE = 'Feuille1';
  const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

  let tokenClient, gapiInited = false, gisInited = false, accessToken = null, operatorName = null;

  function gapiLoaded() { gapi.load('client', initializeGapiClient); }
  async function initializeGapiClient() {
    await gapi.client.init({ discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
    gapiInited = true;
    maybeEnableButtons();
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
  accessToken = tokenResponse.access_token;
  document.getElementById('operator-form').style.display = 'inline-flex';
  document.getElementById('btn-login').style.display = 'none';
  setStatus('Connect√©. Choisissez un op√©rateur.');
  document.getElementById('operator').focus(); // üëà focus clavier automatique
},

    });
    gisInited = true;
    maybeEnableButtons();
  }

  function maybeEnableButtons() {
    if (gapiInited && gisInited) {
      document.getElementById('btn-login').style.display = 'inline-block';
    }
  }

  function setStatus(msg) {
    document.getElementById('status').textContent = msg;
  }

  document.getElementById('btn-login').onclick = () => {
    tokenClient.requestAccessToken();
  };

  document.getElementById('btn-logout').onclick = () => {
    accessToken = null; operatorName = null;
    document.getElementById('btn-login').style.display = 'inline-block';
    document.getElementById('btn-logout').style.display = 'none';
    document.getElementById('operator-form').style.display = 'none';
    document.getElementById('entry-form').style.display = 'none';
    clearTable();
    setStatus('D√©connect√©.');
  };

  document.getElementById('btn-confirm-operator').onclick = () => {
    const op = document.getElementById('operator').value;
    if (!op) return alert("Choisir un op√©rateur");
    operatorName = op;
    document.getElementById('operator-form').style.display = 'none';
    document.getElementById('btn-logout').style.display = 'inline-block';
    document.getElementById('entry-form').style.display = 'block';
    loadSheet();
  };

  document.getElementById('btn-add').onclick = async () => {
    if(!operatorName) {
      alert("Veuillez vous connecter et choisir un op√©rateur");
      return;
    }

    let rawDate = document.getElementById('date').value;
    let dateVal = "";
    if (rawDate) {
      const [month, year] = rawDate.split('/');
      if (month && year) {
        const paddedMonth = month.padStart(2, '0');
        const lastDay = new Date(year, parseInt(paddedMonth), 0).getDate();
        dateVal = `${year}-${paddedMonth}-${lastDay}`;
      }
    }
    if (!dateVal) {
      const today = new Date();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const y = today.getFullYear();
      const d = new Date(y, today.getMonth() + 1, 0).getDate();
      dateVal = `${y}-${m}-${d}`;
    }

    const productVal = document.getElementById('product').value.trim();
    const qtyVal = parseInt(document.getElementById('qty').value);
    const zoneVal = document.getElementById('zone').value.trim();

    if (!zones.includes(zoneVal)) {
  alert("Veuillez choisir une zone existante dans la liste.");
  return;
}
const codeVal = document.getElementById('code').value.trim();
if (!/^\d{6}$/.test(codeVal)) {
  alert("Le code doit contenir exactement 6 chiffres.");
  return;
}

    const soldVal = 0;
    const promoVal = 0;


    if (!productVal || isNaN(qtyVal) || !zoneVal || isNaN(soldVal) || isNaN(promoVal)) {
      alert("Veuillez remplir tous les champs correctement.");
      return;
    }
const now = new Date();
const ajoutVal = now.toLocaleString('fr-FR'); // Exemple : 12/06/2025, 09:44:31

const values = [[
  operatorName,     // invisible
  dateVal,          // ‚úÖ Date
  productVal,       // ‚úÖ Nom
  codeVal,          // ‚úÖ Code
  qtyVal,           // ‚úÖ Qt√©
  zoneVal,          // ‚úÖ Zone
  soldVal,          // ‚úÖ Vendues
  promoVal,          // ‚úÖ Promo
  ajoutVal // ‚úÖ Date d'ajout (dans le Google Sheet uniquement)
]];


    try {
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueInputOption: 'USER_ENTERED',
        resource: { values }
      });


      loadSheet();
      setStatus('Ligne ajout√©e avec succ√®s !');
      // R√©initialise tous les champs AVANT le rechargement
document.getElementById('product').value = '';
document.getElementById('code').value = '';
document.getElementById('qty').value = '';
document.getElementById('zone').value = '';
document.getElementById('sold').value = '';
document.getElementById('promo').value = '';

// Traitement sp√©cial pour le champ date
const dateInput = document.getElementById('date');
dateInput.value = '';
dateInput.dataset.raw = '';
dateInput.blur(); // enl√®ve le focus

// S√©curit√© : s'il se remplit tout seul, on le vide √† nouveau apr√®s 100ms
setTimeout(() => {
  dateInput.value = '';
  dateInput.removeAttribute('value'); // ‚¨ÖÔ∏è Ajout important ici
  dateInput.dataset.raw = '';
}, 200);
      // Clear form inputs
//document.getElementById('product').value = '';
//document.getElementById('code').value = '';
//document.getElementById('qty').value = '';
//document.getElementById('zone').value = '';
//document.getElementById('sold').value = '';
//document.getElementById('promo').value = '';

// Forcer l'effacement du champ date (m√™me si un autre script le remplit apr√®s)
//const dateInput = document.getElementById('date');
//dateInput.value = '';
//dateInput.dataset.raw = ''; // utile si un masque est utilis√©

//setTimeout(() => {
// dateInput.value = '';
//}, 50);

dateInput.focus();


    } catch (e) {
      setStatus('Erreur : ' + e.message);
    }
  };

  // Load sheet data, exclude operator from table display
  async function loadSheet() {
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: RANGE });
      const rows = res.result.values || [];
      renderTable(rows);
    } catch (e) {
      setStatus("Erreur de chargement : " + e.message);
    }
  }

  function clearTable() {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
  }

  // Render table without op√©rateur column (index 0)
  function renderTable(rows) {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
    //rows.slice(1).forEach((row, i) => {
    rows.slice(1).reverse().forEach((row, i) => {
      const tr = document.createElement('tr');
      const qte = parseInt(row[4] || '0');
const vendu = parseInt(row[6] || '0');
if (!isNaN(qte) && !isNaN(vendu) && qte === vendu) {
  tr.classList.add('ligne-vendue');
}

      // Columns: op√©rateur (0), produit (1), date(2), qty(3), zone(4), vendues(5), promo(6)
      // We skip op√©rateur (col 0)
      const cols = [1, 2, 3, 4, 5, 6];
      cols.forEach(colIndex => {
        const td = document.createElement('td');
        td.textContent = row[colIndex] || '';
        td.contentEditable = true;
       // td.dataset.row = i + 2; // Google Sheets rows start at 1 + header row
        const actualSheetRow = rows.length - i;
td.dataset.row = actualSheetRow;
        td.dataset.col = colIndex + 1; // Google Sheets columns start at 1
        td.addEventListener('blur', onCellEdit);
        tr.appendChild(td);
      });
      tr.addEventListener('click', () => {
        // Unselect all
        document.querySelectorAll('#data-table tbody tr').forEach(r => r.classList.remove('selected'));
        tr.classList.add('selected');
      });
      tbody.appendChild(tr);
    });
  }

  // Update cell in Google Sheets on edit
  async function onCellEdit(e) {
    if(!operatorName) return;
    const td = e.target;
    const newValue = td.textContent.trim();
    const row = td.dataset.row;
    const col = td.dataset.col;

    try {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `Feuille1!${columnToLetter(col)}${row}`,
        valueInputOption: 'USER_ENTERED',
        resource: { values: [[newValue]] }
      });
      setStatus(`Cellule mise √† jour (ligne ${row}, colonne ${col})`);
    } catch (err) {
      setStatus('Erreur mise √† jour : ' + err.message);
    }
  }

  // Convert number to letter for column (1->A, 2->B ...)
  function columnToLetter(column) {
    let temp, letter = '';
    while(column > 0) {
      temp = (column - 1) % 26;
      letter = String.fromCharCode(temp + 65) + letter;
      column = (column - temp - 1) / 26;
    }
    return letter;
  }

function filterTable() {
  const zoneFilter = document.getElementById("filter-zone").value.trim().toLowerCase();
  const monthFilter = document.getElementById("filter-month").value.trim(); // 07/2025 ou 072025 ou 2025
  const rows = document.querySelectorAll("#data-table tbody tr");

  rows.forEach((row) => {
    const dateCell = row.cells[0].textContent.trim(); // format = YYYY-MM-DD
    const zoneCell = row.cells[4].textContent.trim().toLowerCase();
    let show = true;

    // üîπ Filtrer par zone
    if (zoneFilter && !zoneCell.includes(zoneFilter)) {
      show = false;
    }

    // üîπ Filtrer par date
    if (monthFilter) {
      let rowYear = '';
      let rowMonth = '';

      if (dateCell.includes('-')) {
        const [yyyy, mm] = dateCell.split('-');
        rowYear = yyyy;
        rowMonth = mm;
      }

      let mFilter = null;
      let yFilter = null;

      if (/^\d{2}\/\d{4}$/.test(monthFilter)) {
        [mFilter, yFilter] = monthFilter.split('/');
      } else if (/^\d{6}$/.test(monthFilter)) {
        mFilter = monthFilter.slice(0, 2);
        yFilter = monthFilter.slice(2);
      } else if (/^\d{4}$/.test(monthFilter)) {
        yFilter = monthFilter;
      }

      if (yFilter && rowYear !== yFilter) show = false;
      if (mFilter && rowMonth !== mFilter) show = false;
    }

    row.style.display = show ? "" : "none";
  });
}

  function clearFilter() {
    document.getElementById('filter-zone').value = '';
    document.getElementById('filter-month').value = '';
    filterTable();
  }

  // Notification popup logic
  const notifPopup = document.getElementById('notification-popup');
  const notifContent = notifPopup.querySelector('.content');
  document.getElementById('btn-notif').onclick = () => {
    if(!operatorName) {
      alert("Connectez-vous et choisissez un op√©rateur pour voir les notifications.");
      return;
    }
    loadNotifications();
    notifPopup.style.display = 'flex';
  };
  document.getElementById('close-notif').onclick = () => {
    notifPopup.style.display = 'none';
  };
  document.getElementById('print-notif').onclick = () => {
    window.print();
  };

// Format "YYYY-MM" en "Mois Ann√©e" (ex : "2025-05" -> "Mai 2025")
function formatMonthYear(ym) {
  const [y, m] = ym.split('-');
  const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                  'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
  return months[parseInt(m, 10) - 1] + ' ' + y;
}

  // Load GAPI & GIS on window load
  window.onload = () => {
    gapiLoaded();
    gisLoaded();
  };</script>
<script>
if (document.getElementById('btn-history')) {
  document.getElementById('btn-history').addEventListener('click', async () => {
}
    if (!operatorName) {
      alert("Connectez-vous et choisissez un op√©rateur pour acc√©der √† l'historique.");
      return;
    }
    try {
      await transferToHistorique();
      window.location.href = '/historique.html';
    } catch (e) {
      alert("Erreur lors du transfert vers historique : " + e.message);
    }
  });

  async function transferToHistorique() {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: 'Feuille1'
    });
    const allRows = res.result.values || [];
    if (allRows.length <= 1) return;

    const now = new Date();
    const currentYM = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    const toMove = [];
    const remaining = [allRows[0]];

    allRows.slice(1).forEach(row => {
      const dateStr = row[1];
      if (!dateStr) return;
      const d = new Date(dateStr);
      if (isNaN(d)) return;
      const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      if (ym < currentYM) toMove.push(row);
      else remaining.push(row);
    });

    if (toMove.length > 0) {
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'historique',
        valueInputOption: 'USER_ENTERED',
        resource: { values: toMove }
      });
    }

    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: 'Feuille1',
      valueInputOption: 'USER_ENTERED',
      resource: { values: remaining }
    });
    setStatus(`Transf√©r√© ${toMove.length} lignes vers "historique".`);
  }
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fields = [
    'date',
    'product',
    'code',
    'qty',
    'zone',
    'sold',
    'promo'
  ];

  fields.forEach((id, index) => {
    const input = document.getElementById(id);
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const nextField = document.getElementById(fields[index + 1]);
        if (nextField) {
          nextField.focus();
        } else {
          // Si c'est le dernier champ ‚Üí clique sur le bouton
          document.getElementById('btn-add').click();
        }
      }
    });
  });
});
</script>
<script>
  const dateInput = document.getElementById('date');
  if (dateInput) {
    dateInput.addEventListener('input', function(e) {
      let val = e.target.value.replace(/[^\d]/g, '');
      if (val.length > 2) {
        val = val.slice(0,2) + '/' + val.slice(2,6);
      }
      e.target.value = val;
    });
  }
</script>
<script>
const zones = [
  "aboca", "aderma", "arko", "aromat", "avene", "bain", "bande", "b√©b√©",
  "bien etre", "bioderma", "bi-oil", "bonbon", "brumes et senteurs", "cerave",
  "circulation", "clearskin", "collagene", "coloration", "confort", "conseil",
  "cooper geo", "cosmeto", "dentaire", "deo", "dermato", "dexeryl", "dietetique",
  "douleurs", "durex", "enfants", "forme", "frigo", "homeo", "hydratis", "intime",
  "la roche posay","LRP", "la rosee", "levres et mains", "moustik",
  "noreva", "nutergia", "nuxe", "ongles", "oreille", "pieds et mains", "pileje",
  "poux", "ronflement", "cheveux", "corps", "STUP", "svr", "tisanes", "uriage",
  "nature", "vichy", "yeux", "1ersoins", "4patte"
];

const input = document.getElementById('zone');
const list = document.getElementById('zone-suggestions');

input.addEventListener('input', function () {
  const val = this.value.toLowerCase();
  list.innerHTML = '';
  if (val.length < 1) {
    list.style.display = 'none';
    return;
  }

  const matches = zones.filter(z => z.toLowerCase().includes(val));
  if (matches.length === 0) {
    list.style.display = 'none';
    return;
  }

  matches.forEach((zone, index) => {
    const li = document.createElement('li');
    li.textContent = zone;
    li.addEventListener('click', () => {
      input.value = zone;
      list.innerHTML = '';
      list.style.display = 'none';
    });
    list.appendChild(li);
  });

  const rect = input.getBoundingClientRect();
  list.style.top = rect.bottom + window.scrollY + 'px';
  list.style.left = rect.left + window.scrollX + 'px';
  list.style.width = input.offsetWidth + 'px';
  list.style.display = 'block';
});

document.addEventListener('click', function (e) {
  if (!input.contains(e.target) && !list.contains(e.target)) {
    list.style.display = 'none';
  }
});
  function renderTable(rows) {
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';

  //rows.slice(1).forEach((row, i) => {
    rows.slice(1).reverse().forEach((row, i) => {
    const tr = document.createElement('tr');
      const qte = parseInt(row[4] || '0');
const vendu = parseInt(row[6] || '0');
if (!isNaN(qte) && !isNaN(vendu) && qte === vendu) {
  tr.classList.add('ligne-vendue');
}
    const cols = [1, 2, 3, 4, 5, 6, 7];

    cols.forEach(colIndex => {
      const td = document.createElement('td');
     td.textContent = row[colIndex] || '';
      td.contentEditable = true;
      //td.dataset.row = i + 2;
      const actualSheetRow = rows.length - i;
td.dataset.row = actualSheetRow;
      td.dataset.col = colIndex + 1;
      td.addEventListener('blur', onCellEdit);
      tr.appendChild(td);
    });

    // ‚úÖ Ajout de la colonne "‚úñÔ∏è"
    const tdDelete = document.createElement('td');
    tdDelete.innerHTML = '<img src="https://i.imgur.com/oStNoqu.png" style="width:15%; height:5%; object-fit:cover;"/>';
    tdDelete.style.cursor = 'pointer';
    tdDelete.style.color = '#bbb';
    tdDelete.style.fontSize = '1.1em';
    tdDelete.title = 'Supprimer cette ligne';
    tdDelete.addEventListener('mouseenter', () => tdDelete.style.color = '#888');
    tdDelete.addEventListener('mouseleave', () => tdDelete.style.color = '#bbb');
 //   tdDelete.addEventListener('click', async () => {
 //     const confirmed = confirm("Supprimer cette ligne ?");
 //     if (confirmed) {
 //       await deleteRow(i + 2);
 //     }
 //   });
      const actualSheetRow = rows.length - i;

tdDelete.addEventListener('click', async () => {
  const confirmed = confirm("Supprimer cette ligne ?");
  if (confirmed) {
    await deleteRow(actualSheetRow);
  }
});
    tr.appendChild(tdDelete);

    tr.addEventListener('click', () => {
      document.querySelectorAll('#data-table tbody tr').forEach(r => r.classList.remove('selected'));
      tr.classList.add('selected');
    });

    tbody.appendChild(tr);
  });
}
</script>
<script>
  // Filtrer en appuyant sur Entr√©e dans les champs
  document.addEventListener('DOMContentLoaded', function () {
    const filterZone = document.getElementById('filter-zone');
    const filterMonth = document.getElementById('filter-month');

    [filterZone, filterMonth].forEach(input => {
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          filterTable(); // fonction que tu as d√©j√†
        }
      });
    });
  });
</script>
<footer style="
  position: fixed;
  bottom: 0;
  width: 100%;
  text-align: center;
  font-size: 0.6em;
  color: #666;
  background: #bfdbc4;
  padding: 8px 0;
  box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
  z-index: 10;
">
  D√©velopp√© par Violaine Claron - Mise √† jour 06/08/2025
</footer>
<script>
 function exportFilteredTableAsPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;

  const zoneFilter = document.getElementById("filter-zone").value;
  const monthFilter = document.getElementById("filter-month").value;

  doc.setFontSize(14);
  doc.text("R√©sultats filtr√©s - Produits p√©rim√©s", 10, y);
  y += 10;
  doc.setFontSize(10);
  doc.text(`Zone : ${zoneFilter || "Toutes"}`, 10, y);
  y += 6;
  doc.text(`Mois : ${monthFilter || "Tous"}`, 10, y);
  y += 10;

  const rows = document.querySelectorAll("#data-table tbody tr");
  rows.forEach((row) => {
    if (row.style.display === "none") return;
    const cells = Array.from(row.children).slice(0, 6).map(td => td.textContent.trim());
    doc.text(cells.join(" | "), 10, y);
    y += 6;
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
  });

  doc.save("resultats_perimes.pdf");
}



</script>
<script>
  const suggestionList = document.getElementById('filter-zone-suggestions');

  filterInput.addEventListener('input', function () {
    const val = this.value.toLowerCase();
    suggestionList.innerHTML = '';
    if (val.length < 2) {
      suggestionList.style.display = 'none';
      return;
    }

    const matches = zones.filter(z => z.toLowerCase().includes(val));
    if (matches.length === 0) {
      suggestionList.style.display = 'none';
      return;
    }

    matches.forEach((zone) => {
      const li = document.createElement('li');
      li.textContent = zone;
      li.addEventListener('click', () => {
        filterInput.value = zone;
        suggestionList.innerHTML = '';
        suggestionList.style.display = 'none';
      });
      suggestionList.appendChild(li);
    });

    const rect = filterInput.getBoundingClientRect();
    suggestionList.style.top = rect.bottom + window.scrollY + 'px';
    suggestionList.style.left = rect.left + window.scrollX + 'px';
    suggestionList.style.width = filterInput.offsetWidth + 'px';
    suggestionList.style.display = 'block';
  });

  document.addEventListener('click', function (e) {
    if (!filterInput.contains(e.target) && !suggestionList.contains(e.target)) {
      suggestionList.style.display = 'none';
    }
  });
</script>
<script>
  async function deleteRow(rowIndex) {
    try {
      await gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          requests: [{
            deleteDimension: {
              range: {
                sheetId: 0,
                dimension: "ROWS",
                startIndex: rowIndex - 1,
                endIndex: rowIndex
              }
            }
          }]
        }
      });
      setStatus("Ligne supprim√©e avec succ√®s.");
      loadSheet();
    } catch (e) {
      setStatus("Erreur suppression : " + e.message);
    }
  }
</script>
<script>
 /* if (filterMonthInput) {
    filterMonthInput.addEventListener('input', function(e) {
      let val = e.target.value.replace(/[^\d]/g, '');
      if (val.length > 2) {
        val = val.slice(0,2) + '/' + val.slice(2,6);
      }
      e.target.value = val;
    });
  }*/

let currentFocus = -1;

input.addEventListener('keydown', function (e) {
  const items = list.querySelectorAll("li");
  if (!items.length) return;

  if (e.key === "ArrowDown") {
    currentFocus++;
    if (currentFocus >= items.length) currentFocus = 0;
    updateActive(items);
  } else if (e.key === "ArrowUp") {
    currentFocus--;
    if (currentFocus < 0) currentFocus = items.length - 1;
    updateActive(items);
  } else if (e.key === "Enter") {
    e.preventDefault();
    if (currentFocus > -1) {
      items[currentFocus].click();
    }
  }
});

function updateActive(items) {
  items.forEach(i => i.classList.remove("active"));
  if (items[currentFocus]) {
    items[currentFocus].classList.add("active");
    items[currentFocus].scrollIntoView({ block: "nearest" });
  }
}

</script>
<script>
document.getElementById("btn-open-my-pdf").addEventListener("click", () => {
  window.open("https://drive.google.com/file/d/1sqy9bTtzSDpqSbs6yiydsNlKHHFfb1hI/view?usp=sharing", "_blank");
});
</script>
  <script>
 const dateInputField = document.getElementById('date');
const dateErrorDiv = document.getElementById('date-error');

dateInputField.addEventListener('blur', () => {
  const val = dateInputField.value.trim();
  const parts = val.split('/');
  if (parts.length !== 2) {
    dateErrorDiv.style.display = 'block';
    return;
  }

  const [mm, yyyy] = parts;
  const parsedMonth = parseInt(mm, 10);
  const parsedYear = parseInt(yyyy, 10);

  if (isNaN(parsedMonth) || isNaN(parsedYear) || parsedMonth < 1 || parsedMonth > 12) {
    dateErrorDiv.style.display = 'block';
    return;
  }

  const enteredDate = new Date(parsedYear, parsedMonth - 1, 1);
  const now = new Date();
  now.setHours(0, 0, 0, 0); // pour √©viter les bugs d‚Äôheure

  if (enteredDate < now) {
    dateErrorDiv.style.display = 'block';
  } else {
    dateErrorDiv.style.display = 'none';
  }
});

</script>
 <script>
    // Collez la fonction showTab ici
  function showTab(tabId) {
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.classList.remove('active'));

  const buttons = document.querySelectorAll('#notif-tabs .tab-button');
  buttons.forEach(button => button.classList.remove('active'));

  document.getElementById(tabId).classList.add('active');
  document.querySelector(`#notif-tabs .tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
}

async function loadNotifications() {
  const RANGE_A_ENLEVER = "Feuille2!A1:H1000";
  const parseDate = (dateStr) => {
    if (!dateStr) return null;
    let parts = dateStr.split('-');
    if (parts.length === 3) {
      // Format AAAA-MM-JJ
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }
    parts = dateStr.split('/');
    if (parts.length === 3) {
      // Format JJ/MM/AAAA
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    return null;
  };

  try {
    // Appel pour la Feuille1 (Trimestre et 2√®me mois)
    const resFeuille1 = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: RANGE
    });
    const dataFeuille1 = (resFeuille1.result.values || []).slice(1);

    // Appel pour la feuille 'Feuille2' (√Ä enlever)
    const resFeuille2 = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: RANGE_A_ENLEVER
    });
    const dataFeuille2 = (resFeuille2.result.values || []).slice(1);

    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    const grouped = {
      'trimestre': {},
      '2nd-month': [],
      'current-month': []
    };

    // Logique pour le mois pr√©c√©dent ("√Ä enlever")
    const prevMonth = (currentMonth - 1 + 12) % 12;
    const prevMonthYear = (currentMonth === 0) ? currentYear - 1 : currentYear;

    dataFeuille2.forEach(row => {
      const dateStr = row[1];
      const d = parseDate(dateStr);
      if (!d) return;

      const rowMonth = d.getMonth();
      const rowYear = d.getFullYear();

      if (rowYear === prevMonthYear && rowMonth === prevMonth) {
        grouped['current-month'].push(row);
      }
    });

    // Traitement des donn√©es de la Feuille1 pour le trimestre et le 2√®me mois
    dataFeuille1.forEach(row => {
      const dateStr = row[1];
      const d = parseDate(dateStr);
      if (!d) return;

      const rowMonth = d.getMonth();
      const rowYear = d.getFullYear();
      const ym = `${rowYear}-${String(rowMonth + 1).padStart(2, '0')}`;

      // Logique pour le trimestre (3 mois suivants √† partir d'aujourd'hui)
      const nextMonth1 = (currentMonth + 1) % 12;
      const nextMonth2 = (currentMonth + 2) % 12;
      const nextMonth3 = (currentMonth + 3) % 12;

      const nextYear1 = (currentMonth === 11) ? currentYear + 1 : currentYear;
      const nextYear2 = (currentMonth >= 11) ? currentYear + 1 : currentYear;
      const nextYear3 = (currentMonth >= 10) ? currentYear + 1 : currentYear;

      if ((rowMonth === nextMonth1 && rowYear === nextYear1) ||
          (rowMonth === nextMonth2 && rowYear === nextYear2) ||
          (rowMonth === nextMonth3 && rowYear === nextYear3)) {
        if (!grouped['trimestre'][ym]) {
          grouped['trimestre'][ym] = [];
        }
        grouped['trimestre'][ym].push(row);
      }

      // Logique pour le "2√®me mois" (mois + 2)
      const monthPlus2 = (currentMonth + 2) % 12;
      const yearPlus2 = (currentMonth >= 10) ? currentYear + 1 : currentYear;
      if (rowYear === yearPlus2 && rowMonth === monthPlus2) {
        grouped['2nd-month'].push(row);
      }
    });

    const formatMonthYear = (d) => {
      const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
      return months[d.getMonth()] + ' ' + d.getFullYear();
    };

    const renderTable = (rows) => {
      if (rows.length === 0) {
        return '<p>Aucun produit p√©rim√© pour ce mois.</p>';
      }
      rows.sort((a, b) => (a[5] || '').localeCompare(b[5] || ''));

      let tableHtml = `<table>
          <thead>
              <tr>
                  <th>Date</th><th>Nom</th><th>Code</th><th>Qt√©</th><th>Zone</th><th>Vendues</th><th>Promo</th>
              </tr>
          </thead>
          <tbody>`;

      rows.forEach(row => {
        const qte = parseInt(row[4] || '0');
        const vendu = parseInt(row[6] || '0');
        const isSoldOut = !isNaN(qte) && !isNaN(vendu) && qte === vendu;
        tableHtml += `<tr class="${isSoldOut ? 'ligne-vendue' : ''}">`;
        [1, 2, 3, 4, 5, 6, 7].forEach(ci => {
          tableHtml += `<td>${row[ci] || ''}</td>`;
        });
        tableHtml += '</tr>';
      });
      tableHtml += '</tbody></table>';
      return tableHtml;
    };

    // Rendu pour le trimestre
    let trimestreHtml = '';
    const sortedTrimestreMonths = Object.keys(grouped['trimestre']).sort();
    if (sortedTrimestreMonths.length === 0) {
      trimestreHtml = '<p>Aucun produit p√©rim√© pour le trimestre.</p>';
    } else {
      sortedTrimestreMonths.forEach(ym => {
        const [y, m] = ym.split('-');
        const d = new Date(y, m - 1, 1);
        trimestreHtml += `<h3>${formatMonthYear(d)}</h3>`;
        trimestreHtml += renderTable(grouped['trimestre'][ym]);
      });
    }
    document.getElementById('trimestre').innerHTML = trimestreHtml;

    // Rendu pour le 2√®me mois (mois + 2)
    const monthPlus2Date = new Date(now.getFullYear(), now.getMonth() + 2);
    const monthPlus2Title = formatMonthYear(monthPlus2Date);
    document.getElementById('2nd-month').innerHTML = `<h3>${monthPlus2Title}</h3>` + renderTable(grouped['2nd-month']);

    // Rendu pour le mois pr√©c√©dent ("√Ä enlever")
    const prevMonthDate = new Date(now.getFullYear(), now.getMonth() - 1);
    const prevMonthTitle = formatMonthYear(prevMonthDate);
    document.getElementById('current-month').innerHTML = `<h3>${prevMonthTitle}</h3>` + renderTable(grouped['current-month']);

  } catch (e) {
    console.error("Erreur chargement notifications :", e);
    const notifContent = document.getElementById('notification-popup').querySelector('.content');
    notifContent.innerHTML = `<p>Erreur chargement notifications : ${e.message}</p>`;
  }
}
</script>
  <script>
  document.getElementById('btn-login').addEventListener('click', () => {
    const overlay = document.getElementById('update-overlay');
    if (overlay) overlay.style.display = 'none';
  });
</script>
</body>
</html>

